var gn=function(e,t){return gn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},gn(e,t)};function In(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");gn(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function gi(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function En(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],a;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(s){a={error:s}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(a)throw a.error}}return o}function Sn(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function ot(e){return typeof e=="function"}function pc(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var Jr=pc(function(e){return function(r){e(this),this.message=r?r.length+` errors occurred during unsubscription:
`+r.map(function(n,i){return i+1+") "+n.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=r}});function Ei(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var Dn=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._teardowns=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var s=gi(a),c=s.next();!c.done;c=s.next()){var u=c.value;u.remove(this)}}catch(v){t={error:v}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}else a.remove(this);var d=this.initialTeardown;if(ot(d))try{d()}catch(v){o=v instanceof Jr?v.errors:[v]}var f=this._teardowns;if(f){this._teardowns=null;try{for(var b=gi(f),y=b.next();!y.done;y=b.next()){var m=y.value;try{Si(m)}catch(v){o=o??[],v instanceof Jr?o=Sn(Sn([],En(o)),En(v.errors)):o.push(v)}}}catch(v){n={error:v}}finally{try{y&&!y.done&&(i=b.return)&&i.call(b)}finally{if(n)throw n.error}}}if(o)throw new Jr(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Si(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._teardowns=(r=this._teardowns)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&Ei(r,t)},e.prototype.remove=function(t){var r=this._teardowns;r&&Ei(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}();Dn.EMPTY;function dc(e){return e instanceof Dn||e&&"closed"in e&&ot(e.remove)&&ot(e.add)&&ot(e.unsubscribe)}function Si(e){ot(e)?e():e.unsubscribe()}var Mn={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Pn={setTimeout:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Pn.delegate;return((r==null?void 0:r.setTimeout)||setTimeout).apply(void 0,Sn([],En(e)))},clearTimeout:function(e){var t=Pn.delegate;return((t==null?void 0:t.clearTimeout)||clearTimeout)(e)},delegate:void 0};function fc(e){Pn.setTimeout(function(){var t=Mn.onUnhandledError;if(t)t(e);else throw e})}function Pi(){}var ao=function(e){In(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,dc(r)&&r.add(n)):n.destination=hc,n}return t.create=function(r,n,i){return new vc(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(Dn),yc=Function.prototype.bind;function Zr(e,t){return yc.call(e,t)}var bc=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){or(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){or(n)}else or(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){or(r)}},e}(),vc=function(e){In(t,e);function t(r,n,i){var o=e.call(this)||this,a;if(ot(r)||!r)a={next:r??void 0,error:n??void 0,complete:i??void 0};else{var s;o&&Mn.useDeprecatedNextContext?(s=Object.create(r),s.unsubscribe=function(){return o.unsubscribe()},a={next:r.next&&Zr(r.next,s),error:r.error&&Zr(r.error,s),complete:r.complete&&Zr(r.complete,s)}):a=r}return o.destination=new bc(a),o}return t}(ao);function or(e){fc(e)}function mc(e){throw e}var hc={closed:!0,next:Pi,error:mc,complete:Pi};function gc(e){return e}function Ec(e){return ot(e==null?void 0:e.lift)}function Nn(e){return function(t){if(Ec(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}function _n(e,t,r,n,i){return new Sc(e,t,r,n,i)}var Sc=function(e){In(t,e);function t(r,n,i,o,a,s){var c=e.call(this,r)||this;return c.onFinalize=a,c.shouldUnsubscribe=s,c._next=n?function(u){try{n(u)}catch(d){r.error(d)}}:e.prototype._next,c._error=o?function(u){try{o(u)}catch(d){r.error(d)}finally{this.unsubscribe()}}:e.prototype._error,c._complete=i?function(){try{i()}catch(u){r.error(u)}finally{this.unsubscribe()}}:e.prototype._complete,c}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(ao);function qn(e,t){return Nn(function(r,n){var i=0;r.subscribe(_n(n,function(o){n.next(e.call(t,o,i++))}))})}function Ft(e,t){return Nn(function(r,n){var i=0;r.subscribe(_n(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}function Pc(e,t){return t===void 0&&(t=gc),e=e??Tc,Nn(function(r,n){var i,o=!0;r.subscribe(_n(n,function(a){var s=t(a);(o||!e(i,s))&&(o=!1,i=s,n.next(a))}))})}function Tc(e,t){return e===t}Array.prototype.toObject=function(e,t=r=>r){return this.reduce((r,n)=>(r[n[e]]=t(n),r),{})};EventTarget.prototype.subscribe=function(e,t){return this.addEventListener(e,t),()=>this.removeEventListener(e,t)};Map.prototype.toObject=function(e=r=>r,t=()=>!0){return Array.from(this.entries()).reduce((r,[n,i])=>{const o=e(i);return t(o)&&(r[n]=o),r},{})};Map.prototype.toArray=function(e=t=>t){return Array.from(this.values(),e)};function ce(e){return typeof e=="function"}function xc(e){return ce(e==null?void 0:e.lift)}function he(e){return function(t){if(xc(t))return t.lift(function(r){try{return e(r,this)}catch(n){this.error(n)}});throw new TypeError("Unable to lift unknown Observable type")}}var Tn=function(e,t){return Tn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(r[i]=n[i])},Tn(e,t)};function Fe(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Tn(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}function wc(e,t,r,n){function i(o){return o instanceof r?o:new r(function(a){a(o)})}return new(r||(r=Promise))(function(o,a){function s(d){try{u(n.next(d))}catch(f){a(f)}}function c(d){try{u(n.throw(d))}catch(f){a(f)}}function u(d){d.done?o(d.value):i(d.value).then(s,c)}u((n=n.apply(e,t||[])).next())})}function co(e,t){var r={label:0,sent:function(){if(o[0]&1)throw o[1];return o[1]},trys:[],ops:[]},n,i,o,a;return a={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function s(u){return function(d){return c([u,d])}}function c(u){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(r=0)),r;)try{if(n=1,i&&(o=u[0]&2?i.return:u[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,u[1])).done)return o;switch(i=0,o&&(u=[u[0]&2,o.value]),u[0]){case 0:case 1:o=u;break;case 4:return r.label++,{value:u[1],done:!1};case 5:r.label++,i=u[1],u=[0];continue;case 7:u=r.ops.pop(),r.trys.pop();continue;default:if(o=r.trys,!(o=o.length>0&&o[o.length-1])&&(u[0]===6||u[0]===2)){r=0;continue}if(u[0]===3&&(!o||u[1]>o[0]&&u[1]<o[3])){r.label=u[1];break}if(u[0]===6&&r.label<o[1]){r.label=o[1],o=u;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(u);break}o[2]&&r.ops.pop(),r.trys.pop();continue}u=t.call(e,r)}catch(d){u=[6,d],i=0}finally{n=o=0}if(u[0]&5)throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}}function xt(e){var t=typeof Symbol=="function"&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&typeof e.length=="number")return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function ze(e,t){var r=typeof Symbol=="function"&&e[Symbol.iterator];if(!r)return e;var n=r.call(e),i,o=[],a;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(s){a={error:s}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(a)throw a.error}}return o}function We(e,t,r){if(r||arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return e.concat(o||Array.prototype.slice.call(t))}function Pt(e){return this instanceof Pt?(this.v=e,this):new Pt(e)}function Bc(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=r.apply(e,t||[]),i,o=[];return i={},s("next"),s("throw"),s("return",a),i[Symbol.asyncIterator]=function(){return this},i;function a(y){return function(m){return Promise.resolve(m).then(y,f)}}function s(y,m){n[y]&&(i[y]=function(v){return new Promise(function(E,S){o.push([y,v,E,S])>1||c(y,v)})},m&&(i[y]=m(i[y])))}function c(y,m){try{u(n[y](m))}catch(v){b(o[0][3],v)}}function u(y){y.value instanceof Pt?Promise.resolve(y.value.v).then(d,f):b(o[0][2],y)}function d(y){c("next",y)}function f(y){c("throw",y)}function b(y,m){y(m),o.shift(),o.length&&c(o[0][0],o[0][1])}}function Oc(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=e[Symbol.asyncIterator],r;return t?t.call(e):(e=typeof xt=="function"?xt(e):e[Symbol.iterator](),r={},n("next"),n("throw"),n("return"),r[Symbol.asyncIterator]=function(){return this},r);function n(o){r[o]=e[o]&&function(a){return new Promise(function(s,c){a=e[o](a),i(s,c,a.done,a.value)})}}function i(o,a,s,c){Promise.resolve(c).then(function(u){o({value:u,done:s})},a)}}var uo=function(e){return e&&typeof e.length=="number"&&typeof e!="function"};function lo(e){return ce(e==null?void 0:e.then)}function po(e){var t=function(n){Error.call(n),n.stack=new Error().stack},r=e(t);return r.prototype=Object.create(Error.prototype),r.prototype.constructor=r,r}var en=po(function(e){return function(t){e(this),this.message=t?t.length+` errors occurred during unsubscription:
`+t.map(function(r,n){return n+1+") "+r.toString()}).join(`
  `):"",this.name="UnsubscriptionError",this.errors=t}});function gr(e,t){if(e){var r=e.indexOf(t);0<=r&&e.splice(r,1)}}var lt=function(){function e(t){this.initialTeardown=t,this.closed=!1,this._parentage=null,this._finalizers=null}return e.prototype.unsubscribe=function(){var t,r,n,i,o;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var s=xt(a),c=s.next();!c.done;c=s.next()){var u=c.value;u.remove(this)}}catch(v){t={error:v}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(t)throw t.error}}else a.remove(this);var d=this.initialTeardown;if(ce(d))try{d()}catch(v){o=v instanceof en?v.errors:[v]}var f=this._finalizers;if(f){this._finalizers=null;try{for(var b=xt(f),y=b.next();!y.done;y=b.next()){var m=y.value;try{Ti(m)}catch(v){o=o??[],v instanceof en?o=We(We([],ze(o)),ze(v.errors)):o.push(v)}}}catch(v){n={error:v}}finally{try{y&&!y.done&&(i=b.return)&&i.call(b)}finally{if(n)throw n.error}}}if(o)throw new en(o)}},e.prototype.add=function(t){var r;if(t&&t!==this)if(this.closed)Ti(t);else{if(t instanceof e){if(t.closed||t._hasParent(this))return;t._addParent(this)}(this._finalizers=(r=this._finalizers)!==null&&r!==void 0?r:[]).push(t)}},e.prototype._hasParent=function(t){var r=this._parentage;return r===t||Array.isArray(r)&&r.includes(t)},e.prototype._addParent=function(t){var r=this._parentage;this._parentage=Array.isArray(r)?(r.push(t),r):r?[r,t]:t},e.prototype._removeParent=function(t){var r=this._parentage;r===t?this._parentage=null:Array.isArray(r)&&gr(r,t)},e.prototype.remove=function(t){var r=this._finalizers;r&&gr(r,t),t instanceof e&&t._removeParent(this)},e.EMPTY=function(){var t=new e;return t.closed=!0,t}(),e}(),fo=lt.EMPTY;function yo(e){return e instanceof lt||e&&"closed"in e&&ce(e.remove)&&ce(e.add)&&ce(e.unsubscribe)}function Ti(e){ce(e)?e():e.unsubscribe()}var bo={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Rc={setTimeout:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];return setTimeout.apply(void 0,We([e,t],ze(r)))},clearTimeout:function(e){return clearTimeout(e)},delegate:void 0};function vo(e){Rc.setTimeout(function(){throw e})}function Ut(){}function br(e){e()}var Rr=function(e){Fe(t,e);function t(r){var n=e.call(this)||this;return n.isStopped=!1,r?(n.destination=r,yo(r)&&r.add(n)):n.destination=Ic,n}return t.create=function(r,n,i){return new Lt(r,n,i)},t.prototype.next=function(r){this.isStopped||this._next(r)},t.prototype.error=function(r){this.isStopped||(this.isStopped=!0,this._error(r))},t.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},t.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,e.prototype.unsubscribe.call(this),this.destination=null)},t.prototype._next=function(r){this.destination.next(r)},t.prototype._error=function(r){try{this.destination.error(r)}finally{this.unsubscribe()}},t.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},t}(lt),Cc=Function.prototype.bind;function tn(e,t){return Cc.call(e,t)}var kc=function(){function e(t){this.partialObserver=t}return e.prototype.next=function(t){var r=this.partialObserver;if(r.next)try{r.next(t)}catch(n){sr(n)}},e.prototype.error=function(t){var r=this.partialObserver;if(r.error)try{r.error(t)}catch(n){sr(n)}else sr(t)},e.prototype.complete=function(){var t=this.partialObserver;if(t.complete)try{t.complete()}catch(r){sr(r)}},e}(),Lt=function(e){Fe(t,e);function t(r,n,i){var o=e.call(this)||this,a;if(ce(r)||!r)a={next:r??void 0,error:n??void 0,complete:i??void 0};else{var s;o&&bo.useDeprecatedNextContext?(s=Object.create(r),s.unsubscribe=function(){return o.unsubscribe()},a={next:r.next&&tn(r.next,s),error:r.error&&tn(r.error,s),complete:r.complete&&tn(r.complete,s)}):a=r}return o.destination=new kc(a),o}return t}(Rr);function sr(e){vo(e)}function Qc(e){throw e}var Ic={closed:!0,next:Ut,error:Qc,complete:Ut},An=function(){return typeof Symbol=="function"&&Symbol.observable||"@@observable"}();function pt(e){return e}function Dc(e){return e.length===0?pt:e.length===1?e[0]:function(t){return e.reduce(function(r,n){return n(r)},t)}}var Be=function(){function e(t){t&&(this._subscribe=t)}return e.prototype.lift=function(t){var r=new e;return r.source=this,r.operator=t,r},e.prototype.subscribe=function(t,r,n){var i=this,o=Nc(t)?t:new Lt(t,r,n);return br(function(){var a=i,s=a.operator,c=a.source;o.add(s?s.call(o,c):c?i._subscribe(o):i._trySubscribe(o))}),o},e.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(r){t.error(r)}},e.prototype.forEach=function(t,r){var n=this;return r=xi(r),new r(function(i,o){var a=new Lt({next:function(s){try{t(s)}catch(c){o(c),a.unsubscribe()}},error:o,complete:i});n.subscribe(a)})},e.prototype._subscribe=function(t){var r;return(r=this.source)===null||r===void 0?void 0:r.subscribe(t)},e.prototype[An]=function(){return this},e.prototype.pipe=function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return Dc(t)(this)},e.prototype.toPromise=function(t){var r=this;return t=xi(t),new t(function(n,i){var o;r.subscribe(function(a){return o=a},function(a){return i(a)},function(){return n(o)})})},e.create=function(t){return new e(t)},e}();function xi(e){var t;return(t=e??bo.Promise)!==null&&t!==void 0?t:Promise}function Mc(e){return e&&ce(e.next)&&ce(e.error)&&ce(e.complete)}function Nc(e){return e&&e instanceof Rr||Mc(e)&&yo(e)}function mo(e){return ce(e[An])}function ho(e){return Symbol.asyncIterator&&ce(e==null?void 0:e[Symbol.asyncIterator])}function go(e){return new TypeError("You provided "+(e!==null&&typeof e=="object"?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}function _c(){return typeof Symbol!="function"||!Symbol.iterator?"@@iterator":Symbol.iterator}var Eo=_c();function So(e){return ce(e==null?void 0:e[Eo])}function Po(e){return Bc(this,arguments,function(){var t,r,n,i;return co(this,function(o){switch(o.label){case 0:t=e.getReader(),o.label=1;case 1:o.trys.push([1,,9,10]),o.label=2;case 2:return[4,Pt(t.read())];case 3:return r=o.sent(),n=r.value,i=r.done,i?[4,Pt(void 0)]:[3,5];case 4:return[2,o.sent()];case 5:return[4,Pt(n)];case 6:return[4,o.sent()];case 7:return o.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})})}function To(e){return ce(e==null?void 0:e.getReader)}function Pe(e){if(e instanceof Be)return e;if(e!=null){if(mo(e))return qc(e);if(uo(e))return Ac(e);if(lo(e))return Fc(e);if(ho(e))return xo(e);if(So(e))return Uc(e);if(To(e))return Lc(e)}throw go(e)}function qc(e){return new Be(function(t){var r=e[An]();if(ce(r.subscribe))return r.subscribe(t);throw new TypeError("Provided object does not correctly implement Symbol.observable")})}function Ac(e){return new Be(function(t){for(var r=0;r<e.length&&!t.closed;r++)t.next(e[r]);t.complete()})}function Fc(e){return new Be(function(t){e.then(function(r){t.closed||(t.next(r),t.complete())},function(r){return t.error(r)}).then(null,vo)})}function Uc(e){return new Be(function(t){var r,n;try{for(var i=xt(e),o=i.next();!o.done;o=i.next()){var a=o.value;if(t.next(a),t.closed)return}}catch(s){r={error:s}}finally{try{o&&!o.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}t.complete()})}function xo(e){return new Be(function(t){jc(e,t).catch(function(r){return t.error(r)})})}function Lc(e){return xo(Po(e))}function jc(e,t){var r,n,i,o;return wc(this,void 0,void 0,function(){var a,s;return co(this,function(c){switch(c.label){case 0:c.trys.push([0,5,6,11]),r=Oc(e),c.label=1;case 1:return[4,r.next()];case 2:if(n=c.sent(),!!n.done)return[3,4];if(a=n.value,t.next(a),t.closed)return[2];c.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return s=c.sent(),i={error:s},[3,11];case 6:return c.trys.push([6,,9,10]),n&&!n.done&&(o=r.return)?[4,o.call(r)]:[3,8];case 7:c.sent(),c.label=8;case 8:return[3,10];case 9:if(i)throw i.error;return[7];case 10:return[7];case 11:return t.complete(),[2]}})})}function de(e,t,r,n,i){return new Vc(e,t,r,n,i)}var Vc=function(e){Fe(t,e);function t(r,n,i,o,a,s){var c=e.call(this,r)||this;return c.onFinalize=a,c.shouldUnsubscribe=s,c._next=n?function(u){try{n(u)}catch(d){r.error(d)}}:e.prototype._next,c._error=o?function(u){try{o(u)}catch(d){r.error(d)}finally{this.unsubscribe()}}:e.prototype._error,c._complete=i?function(){try{i()}catch(u){r.error(u)}finally{this.unsubscribe()}}:e.prototype._complete,c}return t.prototype.unsubscribe=function(){var r;if(!this.shouldUnsubscribe||this.shouldUnsubscribe()){var n=this.closed;e.prototype.unsubscribe.call(this),!n&&((r=this.onFinalize)===null||r===void 0||r.call(this))}},t}(Rr),zc=function(e){Fe(t,e);function t(r,n){return e.call(this)||this}return t.prototype.schedule=function(r,n){return this},t}(lt),xn={setInterval:function(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=xn.delegate;return i!=null&&i.setInterval?i.setInterval.apply(i,We([e,t],ze(r))):setInterval.apply(void 0,We([e,t],ze(r)))},clearInterval:function(e){return clearInterval(e)},delegate:void 0},Wc=function(e){Fe(t,e);function t(r,n){var i=e.call(this,r,n)||this;return i.scheduler=r,i.work=n,i.pending=!1,i}return t.prototype.schedule=function(r,n){var i;if(n===void 0&&(n=0),this.closed)return this;this.state=r;var o=this.id,a=this.scheduler;return o!=null&&(this.id=this.recycleAsyncId(a,o,n)),this.pending=!0,this.delay=n,this.id=(i=this.id)!==null&&i!==void 0?i:this.requestAsyncId(a,this.id,n),this},t.prototype.requestAsyncId=function(r,n,i){return i===void 0&&(i=0),xn.setInterval(r.flush.bind(r,this),i)},t.prototype.recycleAsyncId=function(r,n,i){if(i===void 0&&(i=0),i!=null&&this.delay===i&&this.pending===!1)return n;n!=null&&xn.clearInterval(n)},t.prototype.execute=function(r,n){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var i=this._execute(r,n);if(i)return i;this.pending===!1&&this.id!=null&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(r,n){var i=!1,o;try{this.work(r)}catch(a){i=!0,o=a||new Error("Scheduled action threw falsy error")}if(i)return this.unsubscribe(),o},t.prototype.unsubscribe=function(){if(!this.closed){var r=this,n=r.id,i=r.scheduler,o=i.actions;this.work=this.state=this.scheduler=null,this.pending=!1,gr(o,this),n!=null&&(this.id=this.recycleAsyncId(i,n,null)),this.delay=null,e.prototype.unsubscribe.call(this)}},t}(zc),Fn={now:function(){return(Fn.delegate||Date).now()},delegate:void 0},wi=function(){function e(t,r){r===void 0&&(r=e.now),this.schedulerActionCtor=t,this.now=r}return e.prototype.schedule=function(t,r,n){return r===void 0&&(r=0),new this.schedulerActionCtor(this,t).schedule(n,r)},e.now=Fn.now,e}(),$c=function(e){Fe(t,e);function t(r,n){n===void 0&&(n=wi.now);var i=e.call(this,r,n)||this;return i.actions=[],i._active=!1,i}return t.prototype.flush=function(r){var n=this.actions;if(this._active){n.push(r);return}var i;this._active=!0;do if(i=r.execute(r.state,r.delay))break;while(r=n.shift());if(this._active=!1,i){for(;r=n.shift();)r.unsubscribe();throw i}},t}(wi),Bt=new $c(Wc),Hc=Bt;function wo(e){return e&&ce(e.schedule)}function Xc(e){return e instanceof Date&&!isNaN(e)}function Un(e,t,r){e===void 0&&(e=0),r===void 0&&(r=Hc);var n=-1;return t!=null&&(wo(t)?r=t:n=t),new Be(function(i){var o=Xc(e)?+e-r.now():e;o<0&&(o=0);var a=0;return r.schedule(function(){i.closed||(i.next(a++),0<=n?this.schedule(void 0,n):i.complete())},o)})}function Ln(e){return e[e.length-1]}function Bo(e){return ce(Ln(e))?e.pop():void 0}function Cr(e){return wo(Ln(e))?e.pop():void 0}function Yc(e,t){return typeof Ln(e)=="number"?e.pop():t}function Ve(e,t,r,n,i){n===void 0&&(n=0),i===void 0&&(i=!1);var o=t.schedule(function(){r(),i?e.add(this.schedule(null,n)):this.unsubscribe()},n);if(e.add(o),!i)return o}var Gc=Array.isArray,Kc=Object.getPrototypeOf,Jc=Object.prototype,Zc=Object.keys;function eu(e){if(e.length===1){var t=e[0];if(Gc(t))return{args:t,keys:null};if(tu(t)){var r=Zc(t);return{args:r.map(function(n){return t[n]}),keys:r}}}return{args:e,keys:null}}function tu(e){return e&&typeof e=="object"&&Kc(e)===Jc}function Oo(e,t){return t===void 0&&(t=0),he(function(r,n){r.subscribe(de(n,function(i){return Ve(n,e,function(){return n.next(i)},t)},function(){return Ve(n,e,function(){return n.complete()},t)},function(i){return Ve(n,e,function(){return n.error(i)},t)}))})}function Ro(e,t){return t===void 0&&(t=0),he(function(r,n){n.add(e.schedule(function(){return r.subscribe(n)},t))})}function ru(e,t){return Pe(e).pipe(Ro(t),Oo(t))}function nu(e,t){return Pe(e).pipe(Ro(t),Oo(t))}function iu(e,t){return new Be(function(r){var n=0;return t.schedule(function(){n===e.length?r.complete():(r.next(e[n++]),r.closed||this.schedule())})})}function ou(e,t){return new Be(function(r){var n;return Ve(r,t,function(){n=e[Eo](),Ve(r,t,function(){var i,o,a;try{i=n.next(),o=i.value,a=i.done}catch(s){r.error(s);return}a?r.complete():r.next(o)},0,!0)}),function(){return ce(n==null?void 0:n.return)&&n.return()}})}function Co(e,t){if(!e)throw new Error("Iterable cannot be null");return new Be(function(r){Ve(r,t,function(){var n=e[Symbol.asyncIterator]();Ve(r,t,function(){n.next().then(function(i){i.done?r.complete():r.next(i.value)})},0,!0)})})}function su(e,t){return Co(Po(e),t)}function au(e,t){if(e!=null){if(mo(e))return ru(e,t);if(uo(e))return iu(e,t);if(lo(e))return nu(e,t);if(ho(e))return Co(e,t);if(So(e))return ou(e,t);if(To(e))return su(e,t)}throw go(e)}function kr(e,t){return t?au(e,t):Pe(e)}function l(e,t){return he(function(r,n){var i=0;r.subscribe(de(n,function(o){n.next(e.call(t,o,i++))}))})}var cu=Array.isArray;function uu(e,t){return cu(t)?e.apply(void 0,We([],ze(t))):e(t)}function lu(e){return l(function(t){return uu(e,t)})}function pu(e,t){return e.reduce(function(r,n,i){return r[n]=t[i],r},{})}function B(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Cr(e),n=Bo(e),i=eu(e),o=i.args,a=i.keys;if(o.length===0)return kr([],r);var s=new Be(du(o,r,a?function(c){return pu(a,c)}:pt));return n?s.pipe(lu(n)):s}function du(e,t,r){return r===void 0&&(r=pt),function(n){Bi(t,function(){for(var i=e.length,o=new Array(i),a=i,s=i,c=function(d){Bi(t,function(){var f=kr(e[d],t),b=!1;f.subscribe(de(n,function(y){o[d]=y,b||(b=!0,s--),s||n.next(r(o.slice()))},function(){--a||n.complete()}))},n)},u=0;u<i;u++)c(u)},n)}}function Bi(e,t,r){e?Ve(r,e,t):t()}function fu(e,t,r,n,i,o,a,s){var c=[],u=0,d=0,f=!1,b=function(){f&&!c.length&&!u&&t.complete()},y=function(v){return u<n?m(v):c.push(v)},m=function(v){o&&t.next(v),u++;var E=!1;Pe(r(v,d++)).subscribe(de(t,function(S){i==null||i(S),o?y(S):t.next(S)},function(){E=!0},void 0,function(){if(E)try{u--;for(var S=function(){var x=c.shift();a?Ve(t,a,function(){return m(x)}):m(x)};c.length&&u<n;)S();b()}catch(x){t.error(x)}}))};return e.subscribe(de(t,y,function(){f=!0,b()})),function(){s==null||s()}}function jn(e,t,r){return r===void 0&&(r=1/0),ce(t)?jn(function(n,i){return l(function(o,a){return t(n,o,i,a)})(Pe(e(n,i)))},r):(typeof t=="number"&&(r=t),he(function(n,i){return fu(n,i,e,r)}))}function yu(e,t,r,n,i){return function(o,a){var s=r,c=t,u=0;o.subscribe(de(a,function(d){var f=u++;c=s?e(c,d,f):(s=!0,d),n&&a.next(c)},i&&function(){s&&a.next(c),a.complete()}))}}function dt(e){return e===void 0&&(e=1/0),jn(pt,e)}function bu(){return dt(1)}var vu=po(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),ue=function(e){Fe(t,e);function t(){var r=e.call(this)||this;return r.closed=!1,r.currentObservers=null,r.observers=[],r.isStopped=!1,r.hasError=!1,r.thrownError=null,r}return t.prototype.lift=function(r){var n=new Oi(this,this);return n.operator=r,n},t.prototype._throwIfClosed=function(){if(this.closed)throw new vu},t.prototype.next=function(r){var n=this;br(function(){var i,o;if(n._throwIfClosed(),!n.isStopped){n.currentObservers||(n.currentObservers=Array.from(n.observers));try{for(var a=xt(n.currentObservers),s=a.next();!s.done;s=a.next()){var c=s.value;c.next(r)}}catch(u){i={error:u}}finally{try{s&&!s.done&&(o=a.return)&&o.call(a)}finally{if(i)throw i.error}}}})},t.prototype.error=function(r){var n=this;br(function(){if(n._throwIfClosed(),!n.isStopped){n.hasError=n.isStopped=!0,n.thrownError=r;for(var i=n.observers;i.length;)i.shift().error(r)}})},t.prototype.complete=function(){var r=this;br(function(){if(r._throwIfClosed(),!r.isStopped){r.isStopped=!0;for(var n=r.observers;n.length;)n.shift().complete()}})},t.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(t.prototype,"observed",{get:function(){var r;return((r=this.observers)===null||r===void 0?void 0:r.length)>0},enumerable:!1,configurable:!0}),t.prototype._trySubscribe=function(r){return this._throwIfClosed(),e.prototype._trySubscribe.call(this,r)},t.prototype._subscribe=function(r){return this._throwIfClosed(),this._checkFinalizedStatuses(r),this._innerSubscribe(r)},t.prototype._innerSubscribe=function(r){var n=this,i=this,o=i.hasError,a=i.isStopped,s=i.observers;return o||a?fo:(this.currentObservers=null,s.push(r),new lt(function(){n.currentObservers=null,gr(s,r)}))},t.prototype._checkFinalizedStatuses=function(r){var n=this,i=n.hasError,o=n.thrownError,a=n.isStopped;i?r.error(o):a&&r.complete()},t.prototype.asObservable=function(){var r=new Be;return r.source=this,r},t.create=function(r,n){return new Oi(r,n)},t}(Be),Oi=function(e){Fe(t,e);function t(r,n){var i=e.call(this)||this;return i.destination=r,i.source=n,i}return t.prototype.next=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.next)===null||i===void 0||i.call(n,r)},t.prototype.error=function(r){var n,i;(i=(n=this.destination)===null||n===void 0?void 0:n.error)===null||i===void 0||i.call(n,r)},t.prototype.complete=function(){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.complete)===null||n===void 0||n.call(r)},t.prototype._subscribe=function(r){var n,i;return(i=(n=this.source)===null||n===void 0?void 0:n.subscribe(r))!==null&&i!==void 0?i:fo},t}(ue);function Vn(e,t){return t===void 0&&(t=Bt),he(function(r,n){var i=null,o=null,a=null,s=function(){if(i){i.unsubscribe(),i=null;var u=o;o=null,n.next(u)}};function c(){var u=a+e,d=t.now();if(d<u){i=this.schedule(void 0,u-d),n.add(i);return}s()}r.subscribe(de(n,function(u){o=u,a=t.now(),i||(i=t.schedule(c,e),n.add(i))},function(){s(),n.complete()},void 0,function(){o=i=null}))})}function wn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return bu()(kr(e,Cr(e)))}var zn=new Be(function(e){return e.complete()});function Ke(e){return e<=0?function(){return zn}:he(function(t,r){var n=0;t.subscribe(de(r,function(i){++n<=e&&(r.next(i),e<=n&&r.complete())}))})}function mu(){return he(function(e,t){e.subscribe(de(t,Ut))})}function qt(e){return l(function(){return e})}function ko(e,t){return t?function(r){return wn(t.pipe(Ke(1),mu()),r.pipe(ko(e)))}:jn(function(r,n){return Pe(e(r,n)).pipe(Ke(1),qt(r))})}function Ot(e,t){t===void 0&&(t=Bt);var r=Un(e,t);return ko(function(){return r})}function Ie(e,t){return t===void 0&&(t=pt),e=e??hu,he(function(r,n){var i,o=!0;r.subscribe(de(n,function(a){var s=t(a);(o||!e(i,s))&&(o=!1,i=s,n.next(a))}))})}function hu(e,t){return e===t}function h(e,t){return he(function(r,n){var i=0;r.subscribe(de(n,function(o){return e.call(t,o,i++)&&n.next(o)}))})}function gu(e,t){return function(r,n){return!e.call(t,r,n)}}function Eu(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e.length;if(r===0)throw new Error("list of properties cannot be empty.");return l(function(n){for(var i=n,o=0;o<r;o++){var a=i==null?void 0:i[e[o]];if(typeof a<"u")i=a;else return}return i})}var Re=function(e){Fe(t,e);function t(r){var n=e.call(this)||this;return n._value=r,n}return Object.defineProperty(t.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),t.prototype._subscribe=function(r){var n=e.prototype._subscribe.call(this,r);return!n.closed&&r.next(this._value),n},t.prototype.getValue=function(){var r=this,n=r.hasError,i=r.thrownError,o=r._value;if(n)throw i;return this._throwIfClosed(),o},t.prototype.next=function(r){e.prototype.next.call(this,this._value=r)},t}(ue),z=function(e){Fe(t,e);function t(r,n,i){r===void 0&&(r=1/0),n===void 0&&(n=1/0),i===void 0&&(i=Fn);var o=e.call(this)||this;return o._bufferSize=r,o._windowTime=n,o._timestampProvider=i,o._buffer=[],o._infiniteTimeWindow=!0,o._infiniteTimeWindow=n===1/0,o._bufferSize=Math.max(1,r),o._windowTime=Math.max(1,n),o}return t.prototype.next=function(r){var n=this,i=n.isStopped,o=n._buffer,a=n._infiniteTimeWindow,s=n._timestampProvider,c=n._windowTime;i||(o.push(r),!a&&o.push(s.now()+c)),this._trimBuffer(),e.prototype.next.call(this,r)},t.prototype._subscribe=function(r){this._throwIfClosed(),this._trimBuffer();for(var n=this._innerSubscribe(r),i=this,o=i._infiniteTimeWindow,a=i._buffer,s=a.slice(),c=0;c<s.length&&!r.closed;c+=o?1:2)r.next(s[c]);return this._checkFinalizedStatuses(r),n},t.prototype._trimBuffer=function(){var r=this,n=r._bufferSize,i=r._timestampProvider,o=r._buffer,a=r._infiniteTimeWindow,s=(a?1:2)*n;if(n<1/0&&s<o.length&&o.splice(0,o.length-s),!a){for(var c=i.now(),u=0,d=1;d<o.length&&o[d]<=c;d+=2)u=d;u&&o.splice(0,u+1)}},t}(ue);function Su(e){return he(function(t,r){var n,i=!1,o,a=function(){n=t.subscribe(de(r,void 0,void 0,function(s){o||(o=new ue,Pe(e(o)).subscribe(de(r,function(){return n?a():i=!0}))),o&&o.next(s)})),i&&(n.unsubscribe(),n=null,i=!1,a())};a()})}function Pu(e,t){return e===void 0&&(e=0),t===void 0&&(t=Bt),e<0&&(e=0),Un(e,e,t)}function H(e,t){return he(yu(e,t,arguments.length>=2,!0))}function ft(e){e===void 0&&(e={});var t=e.connector,r=t===void 0?function(){return new ue}:t,n=e.resetOnError,i=n===void 0?!0:n,o=e.resetOnComplete,a=o===void 0?!0:o,s=e.resetOnRefCountZero,c=s===void 0?!0:s;return function(u){var d,f,b,y=0,m=!1,v=!1,E=function(){f==null||f.unsubscribe(),f=void 0},S=function(){E(),d=b=void 0,m=v=!1},x=function(){var T=d;S(),T==null||T.unsubscribe()};return he(function(T,P){y++,!v&&!m&&E();var w=b=b??r();P.add(function(){y--,y===0&&!v&&!m&&(f=rn(x,c))}),w.subscribe(P),!d&&y>0&&(d=new Lt({next:function(O){return w.next(O)},error:function(O){v=!0,E(),f=rn(S,i,O),w.error(O)},complete:function(){m=!0,E(),f=rn(S,a),w.complete()}}),Pe(T).subscribe(d))})(u)}}function rn(e,t){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];if(t===!0){e();return}if(t!==!1){var i=new Lt({next:function(){i.unsubscribe(),e()}});return Pe(t.apply(void 0,We([],ze(r)))).subscribe(i)}}function ie(e,t,r){var n,i,o,a,s=!1;return e&&typeof e=="object"?(n=e.bufferSize,a=n===void 0?1/0:n,i=e.windowTime,t=i===void 0?1/0:i,o=e.refCount,s=o===void 0?!1:o,r=e.scheduler):a=e??1/0,ft({connector:function(){return new z(a,t,r)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:s})}function G(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Cr(e);return he(function(n,i){(r?wn(e,n,r):wn(e,n)).subscribe(i)})}function Je(e,t){return he(function(r,n){var i=null,o=0,a=!1,s=function(){return a&&!i&&n.complete()};r.subscribe(de(n,function(c){i==null||i.unsubscribe();var u=0,d=o++;Pe(e(c,d)).subscribe(i=de(n,function(f){return n.next(t?t(c,f,d,u++):f)},function(){i=null,s()}))},function(){a=!0,s()}))})}function Tu(e,t){return ce(t)?Je(function(){return e},t):Je(function(){return e})}function xu(e){return he(function(t,r){Pe(e).subscribe(de(r,function(){return r.complete()},Ut)),!r.closed&&t.subscribe(r)})}function Wn(e,t,r){var n=ce(e)||t||r?{next:e,error:t,complete:r}:e;return n?he(function(i,o){var a;(a=n.subscribe)===null||a===void 0||a.call(n);var s=!0;i.subscribe(de(o,function(c){var u;(u=n.next)===null||u===void 0||u.call(n,c),o.next(c)},function(){var c;s=!1,(c=n.complete)===null||c===void 0||c.call(n),o.complete()},function(c){var u;s=!1,(u=n.error)===null||u===void 0||u.call(n,c),o.error(c)},function(){var c,u;s&&((c=n.unsubscribe)===null||c===void 0||c.call(n)),(u=n.finalize)===null||u===void 0||u.call(n)}))}):pt}var Qo={leading:!0,trailing:!1};function wu(e,t){return t===void 0&&(t=Qo),he(function(r,n){var i=t.leading,o=t.trailing,a=!1,s=null,c=null,u=!1,d=function(){c==null||c.unsubscribe(),c=null,o&&(y(),u&&n.complete())},f=function(){c=null,u&&n.complete()},b=function(m){return c=Pe(e(m)).subscribe(de(n,d,f))},y=function(){if(a){a=!1;var m=s;s=null,n.next(m),!u&&b(m)}};r.subscribe(de(n,function(m){a=!0,s=m,!(c&&!c.closed)&&(i?y():b(m))},function(){u=!0,!(o&&a&&c&&!c.closed)&&n.complete()}))})}function ge(e,t,r){t===void 0&&(t=Bt),r===void 0&&(r=Qo);var n=Un(e,t);return wu(function(){return n},r)}function we(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Bo(e);return he(function(n,i){for(var o=e.length,a=new Array(o),s=e.map(function(){return!1}),c=!1,u=function(f){Pe(e[f]).subscribe(de(i,function(b){a[f]=b,!c&&!s[f]&&(s[f]=!0,(c=s.every(pt))&&(s=null))},Ut))},d=0;d<o;d++)u(d);n.subscribe(de(i,function(f){if(c){var b=We([f],ze(a));i.next(r?r.apply(void 0,We([],ze(b))):b)}}))})}function F(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=Cr(e),n=Yc(e,1/0),i=e;return i.length?i.length===1?Pe(i[0]):dt(n)(kr(i,r)):zn}function Io(e,t,r){return[h(t,r)(Pe(e)),h(gu(t,r))(Pe(e))]}const X=new ue,D=new ue;addEventListener("message",({data:e})=>X.next(e));D.subscribe(e=>postMessage(e));let Do=!1;X.subscribe(e=>{e.type==="ty-ready"&&(Do=!0)});const vr=[];function Qr(e,t){vr.push({event:e,params:t})}const Bu=Pu(150);Bu.pipe(h(()=>Do&&vr.length>0)).subscribe(()=>{const{event:e,params:t}=vr[0];D.next({type:"et-track",data:{event:e,params:t}}),vr.shift()});class Ou extends ue{constructor(t,r){super(),this.destination=t,this.source=r}next(t){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.next)===null||n===void 0||n.call(r,t)}error(t){var r,n;(n=(r=this.destination)===null||r===void 0?void 0:r.error)===null||n===void 0||n.call(r,t)}complete(){var t,r;(r=(t=this.destination)===null||t===void 0?void 0:t.complete)===null||r===void 0||r.call(t)}_subscribe(t){var r,n;return(n=(r=this.source)===null||r===void 0?void 0:r.subscribe(t))!==null&&n!==void 0?n:lt.EMPTY}}const Ru={url:"",pingPongInterval:3e3,pingPongTimeout:1e4,deserializer:e=>JSON.parse(e.data),serializer:e=>JSON.stringify(e)},Cu="WebsocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }";class ku extends Ou{constructor(t){super(),this.idCounter=1,this.url=null,this.isReset=!0,this._socket=null,this.idCounter=1,this.url=null,this.isReset=!0,this._socket=null,this._config=Object.assign({},Ru,t),this._output=new ue,this._heartbeatSuccessObserver=new ue,this._heartbeatSuccessObserver.pipe(ge(1e4)).subscribe(r=>t.tyObserver.next(r)),this.destination=new z}_resetState(){this.idCounter=1,this.isReset=!0,this._socket=null,this.source||(this.destination=new z),this._output=new ue}send(t){const{_socket:r}=this,{tyObserver:n}=this._config;if(!r||r.readyState!==1)return zn;const i=this.idCounter++;return this.next(Object.assign(Object.assign({},t),{id:i})),this._output.pipe(h(o=>o.id===i),Ke(1),l(o=>(o.error&&n.next(Ge("ws_error",Date.now(),r==null?void 0:r.guid,JSON.stringify(o.error))),o)))}_connectSocket(t){const{WebSocketCtor:r,openingObserver:n,tyObserver:i,protocol:o,binaryType:a}=this._config;n&&n.next();const s=this._output;let c=null;const u=Date.now();try{c=o?new r(t,o):new r(t),c.guid=Math.floor(Math.random()*1e4),this._socket=c,a&&(this._socket.binaryType=a)}catch(f){i.next(Ge("ws_open_fail",u)),s.error(f);return}const d=new lt(()=>{this._socket=null,c&&c.readyState===1&&c.close()});c.onopen=f=>{const{_socket:b}=this;if(i.next(Ge("ws_open_success",u,b.guid)),!b){c.close(),this._resetState();return}const{openedObserver:y}=this._config;y&&y.next();const m=this.destination;this.destination=new Rr({next:v=>{if(c.readyState===1)try{const{serializer:E}=this._config;v.id===void 0&&(v.id=this.idCounter++);const S=E(v);v.method!=="server.ping"&&v.method!=="tick.subscribe"&&i.next(Ge("ws_subscribe",u,c.guid,S)),c.send(S)}catch(E){this.destination.error(E)}},error:v=>{const{closingObserver:E}=this._config;E&&E.next(void 0),v&&v.code?c.close(v.code,v.reason):s.error(new TypeError(Cu)),this._resetState()},complete:()=>{const{closingObserver:v}=this._config;v&&v.next(void 0),c.close(),this._resetState()}}),m&&m instanceof z&&d.add(m.subscribe(this.destination)),this._startPingPong()},c.onerror=f=>{var b,y;const m=f.currentTarget;i.next(Ge("ws_error",u,m==null?void 0:m.guid)),!(((b=this===null||this===void 0?void 0:this._socket)===null||b===void 0?void 0:b.readyState)<2&&((y=this===null||this===void 0?void 0:this._socket)===null||y===void 0?void 0:y.guid)!==(m==null?void 0:m.guid))&&(this._resetState(),s.error(f))},c.onclose=f=>{var b,y;const m=f.currentTarget;if(i.next(Ge("ws_close",u,m==null?void 0:m.guid,JSON.stringify({code:f==null?void 0:f.code}))),((b=this===null||this===void 0?void 0:this._socket)===null||b===void 0?void 0:b.readyState)<2&&((y=this===null||this===void 0?void 0:this._socket)===null||y===void 0?void 0:y.guid)!==(m==null?void 0:m.guid))return;this._resetState();const{closedObserver:v}=this._config;v&&v.next(),s.error(f)},c.onmessage=f=>{var b,y;try{const m=f.currentTarget;if(((b=this===null||this===void 0?void 0:this._socket)===null||b===void 0?void 0:b.readyState)<2&&((y=this===null||this===void 0?void 0:this._socket)===null||y===void 0?void 0:y.guid)!==(m==null?void 0:m.guid))return;const{deserializer:v}=this._config,E=v(f),S=Object.assign({},E,{guid:m==null?void 0:m.guid});s.next(S)}catch(m){s.error(m)}}}_startPingPong(){const{_socket:t,_output:r}=this;if(!t||t.readyState!==1)return;const n=Date.now(),i=setTimeout(()=>{const{pingPongTimeoutObserver:a,tyObserver:s}=this._config;a&&a.next(),t&&t.readyState<2&&(t.close(),r.error("timeout")),s.next(Ge("ws_heartbeat_timeout",n,t.guid))},this._config.pingPongTimeout);r.pipe(Ke(1)).subscribe(()=>{clearTimeout(i)});const o=this.idCounter++;r.pipe(h(a=>a.id===o),Ke(1)).subscribe(()=>{const{delayObserver:a,pingPongInterval:s}=this._config;a&&a.next(Date.now()-n),this._heartbeatSuccessObserver.next(Ge("ws_heartbeat_success",n)),setTimeout(()=>this._startPingPong(),s)}),this.next({method:"server.ping",params:[],id:o})}_subscribe(t){const{source:r}=this;if(r)return r.subscribe(t);if(this.isReset){this.isReset=!1;const{_config:n}=this,{urlObservable:i}=n,o=this.url||n.url;o?this._connectSocket(o):i&&i.pipe(Ke(1)).subscribe(a=>{this.url=a,this._connectSocket(a)})}return this._output.subscribe(t),t.add(()=>{const{_socket:n}=this;this._output.observers.length===0&&(n&&(n.readyState===1||n.readyState===0)&&n.close(),this._resetState())}),t}unsubscribe(){const{_socket:t}=this;t&&t.readyState===1&&t.close(),this._resetState(),super.unsubscribe()}}function Ge(e,t,r,n){const i=Date.now();return["ws_close","ws_error","ws_open_success","ws_subscribe","ws_heartbeat_timeout"].includes(e)&&Qr("ws_debug",{phase:e,guid:r,start:t,content:n,end:i,duration:i-t}),{phase:e,start:t,end:i,duration:i-t,guid:r}}const Mo=new ue;Mo.subscribe(e=>D.next({type:"tingyun-event",data:e}));const No=new z(1),_o=new ue,qo=new ue,at=new ue,Ao=new ue,Fo=new ue,Uo=F(qo.pipe(qt("Opening")),at.pipe(qt("Opened")),Ao.pipe(qt("Closing")),Fo.pipe(qt("Closed"))),Qu={WebSocketCtor:WebSocket,urlObservable:No,openingObserver:qo,openedObserver:at,closingObserver:Ao,closedObserver:Fo,delayObserver:_o,tyObserver:Mo},j=new ku(Qu),re=j.pipe(Su(e=>e.pipe(Ot(2e3))));re.subscribe();_o.subscribe(e=>D.next({type:"network-delay",data:{delay:e}}));function Iu(e){No.next(e)}const Du=re.pipe(h(e=>!!e.position_info),l(e=>e.position_info)),Mu=Du.pipe(H((e,t)=>{const{posSide:r="",symbol:n}=t,i=r?n+r:n;return e.set(i,t),e},new Map));function Nu(){Mu.pipe(l(e=>({type:"adl",data:{adl:e}}))).subscribe(e=>D.next(e))}var _u=20,qu=1,ct=1e6,Ri=1e6,Au=-7,Fu=21,Uu=!1,jt="[big.js] ",yt=jt+"Invalid ",Ir=yt+"decimal places",Lu=yt+"rounding mode",Lo=jt+"Division by zero",K={},Ae=void 0,ju=/^-?(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i;function jo(){function e(t){var r=this;if(!(r instanceof e))return t===Ae?jo():new e(t);if(t instanceof e)r.s=t.s,r.e=t.e,r.c=t.c.slice();else{if(typeof t!="string"){if(e.strict===!0&&typeof t!="bigint")throw TypeError(yt+"value");t=t===0&&1/t<0?"-0":String(t)}Vu(r,t)}r.constructor=e}return e.prototype=K,e.DP=_u,e.RM=qu,e.NE=Au,e.PE=Fu,e.strict=Uu,e.roundDown=0,e.roundHalfUp=1,e.roundHalfEven=2,e.roundUp=3,e}function Vu(e,t){var r,n,i;if(!ju.test(t))throw Error(yt+"number");for(e.s=t.charAt(0)=="-"?(t=t.slice(1),-1):1,(r=t.indexOf("."))>-1&&(t=t.replace(".","")),(n=t.search(/e/i))>0?(r<0&&(r=n),r+=+t.slice(n+1),t=t.substring(0,n)):r<0&&(r=t.length),i=t.length,n=0;n<i&&t.charAt(n)=="0";)++n;if(n==i)e.c=[e.e=0];else{for(;i>0&&t.charAt(--i)=="0";);for(e.e=r-n-1,e.c=[],r=0;n<=i;)e.c[r++]=+t.charAt(n++)}return e}function bt(e,t,r,n){var i=e.c;if(r===Ae&&(r=e.constructor.RM),r!==0&&r!==1&&r!==2&&r!==3)throw Error(Lu);if(t<1)n=r===3&&(n||!!i[0])||t===0&&(r===1&&i[0]>=5||r===2&&(i[0]>5||i[0]===5&&(n||i[1]!==Ae))),i.length=1,n?(e.e=e.e-t+1,i[0]=1):i[0]=e.e=0;else if(t<i.length){if(n=r===1&&i[t]>=5||r===2&&(i[t]>5||i[t]===5&&(n||i[t+1]!==Ae||i[t-1]&1))||r===3&&(n||!!i[0]),i.length=t,n){for(;++i[--t]>9;)if(i[t]=0,t===0){++e.e,i.unshift(1);break}}for(t=i.length;!i[--t];)i.pop()}return e}function Rt(e,t,r){var n=e.e,i=e.c.join(""),o=i.length;if(t)i=i.charAt(0)+(o>1?"."+i.slice(1):"")+(n<0?"e":"e+")+n;else if(n<0){for(;++n;)i="0"+i;i="0."+i}else if(n>0)if(++n>o)for(n-=o;n--;)i+="0";else n<o&&(i=i.slice(0,n)+"."+i.slice(n));else o>1&&(i=i.charAt(0)+"."+i.slice(1));return e.s<0&&r?"-"+i:i}K.abs=function(){var e=new this.constructor(this);return e.s=1,e};K.cmp=function(e){var t,r=this,n=r.c,i=(e=new r.constructor(e)).c,o=r.s,a=e.s,s=r.e,c=e.e;if(!n[0]||!i[0])return n[0]?o:i[0]?-a:0;if(o!=a)return o;if(t=o<0,s!=c)return s>c^t?1:-1;for(a=(s=n.length)<(c=i.length)?s:c,o=-1;++o<a;)if(n[o]!=i[o])return n[o]>i[o]^t?1:-1;return s==c?0:s>c^t?1:-1};K.div=function(e){var t=this,r=t.constructor,n=t.c,i=(e=new r(e)).c,o=t.s==e.s?1:-1,a=r.DP;if(a!==~~a||a<0||a>ct)throw Error(Ir);if(!i[0])throw Error(Lo);if(!n[0])return e.s=o,e.c=[e.e=0],e;var s,c,u,d,f,b=i.slice(),y=s=i.length,m=n.length,v=n.slice(0,s),E=v.length,S=e,x=S.c=[],T=0,P=a+(S.e=t.e-e.e)+1;for(S.s=o,o=P<0?0:P,b.unshift(0);E++<s;)v.push(0);do{for(u=0;u<10;u++){if(s!=(E=v.length))d=s>E?1:-1;else for(f=-1,d=0;++f<s;)if(i[f]!=v[f]){d=i[f]>v[f]?1:-1;break}if(d<0){for(c=E==s?i:b;E;){if(v[--E]<c[E]){for(f=E;f&&!v[--f];)v[f]=9;--v[f],v[E]+=10}v[E]-=c[E]}for(;!v[0];)v.shift()}else break}x[T++]=d?u:++u,v[0]&&d?v[E]=n[y]||0:v=[n[y]]}while((y++<m||v[0]!==Ae)&&o--);return!x[0]&&T!=1&&(x.shift(),S.e--,P--),T>P&&bt(S,P,r.RM,v[0]!==Ae),S};K.eq=function(e){return this.cmp(e)===0};K.gt=function(e){return this.cmp(e)>0};K.gte=function(e){return this.cmp(e)>-1};K.lt=function(e){return this.cmp(e)<0};K.lte=function(e){return this.cmp(e)<1};K.minus=K.sub=function(e){var t,r,n,i,o=this,a=o.constructor,s=o.s,c=(e=new a(e)).s;if(s!=c)return e.s=-c,o.plus(e);var u=o.c.slice(),d=o.e,f=e.c,b=e.e;if(!u[0]||!f[0])return f[0]?e.s=-c:u[0]?e=new a(o):e.s=1,e;if(s=d-b){for((i=s<0)?(s=-s,n=u):(b=d,n=f),n.reverse(),c=s;c--;)n.push(0);n.reverse()}else for(r=((i=u.length<f.length)?u:f).length,s=c=0;c<r;c++)if(u[c]!=f[c]){i=u[c]<f[c];break}if(i&&(n=u,u=f,f=n,e.s=-e.s),(c=(r=f.length)-(t=u.length))>0)for(;c--;)u[t++]=0;for(c=t;r>s;){if(u[--r]<f[r]){for(t=r;t&&!u[--t];)u[t]=9;--u[t],u[r]+=10}u[r]-=f[r]}for(;u[--c]===0;)u.pop();for(;u[0]===0;)u.shift(),--b;return u[0]||(e.s=1,u=[b=0]),e.c=u,e.e=b,e};K.mod=function(e){var t,r=this,n=r.constructor,i=r.s,o=(e=new n(e)).s;if(!e.c[0])throw Error(Lo);return r.s=e.s=1,t=e.cmp(r)==1,r.s=i,e.s=o,t?new n(r):(i=n.DP,o=n.RM,n.DP=n.RM=0,r=r.div(e),n.DP=i,n.RM=o,this.minus(r.times(e)))};K.neg=function(){var e=new this.constructor(this);return e.s=-e.s,e};K.plus=K.add=function(e){var t,r,n,i=this,o=i.constructor;if(e=new o(e),i.s!=e.s)return e.s=-e.s,i.minus(e);var a=i.e,s=i.c,c=e.e,u=e.c;if(!s[0]||!u[0])return u[0]||(s[0]?e=new o(i):e.s=i.s),e;if(s=s.slice(),t=a-c){for(t>0?(c=a,n=u):(t=-t,n=s),n.reverse();t--;)n.push(0);n.reverse()}for(s.length-u.length<0&&(n=u,u=s,s=n),t=u.length,r=0;t;s[t]%=10)r=(s[--t]=s[t]+u[t]+r)/10|0;for(r&&(s.unshift(r),++c),t=s.length;s[--t]===0;)s.pop();return e.c=s,e.e=c,e};K.pow=function(e){var t=this,r=new t.constructor("1"),n=r,i=e<0;if(e!==~~e||e<-Ri||e>Ri)throw Error(yt+"exponent");for(i&&(e=-e);e&1&&(n=n.times(t)),e>>=1,!!e;)t=t.times(t);return i?r.div(n):n};K.prec=function(e,t){if(e!==~~e||e<1||e>ct)throw Error(yt+"precision");return bt(new this.constructor(this),e,t)};K.round=function(e,t){if(e===Ae)e=0;else if(e!==~~e||e<-ct||e>ct)throw Error(Ir);return bt(new this.constructor(this),e+this.e+1,t)};K.sqrt=function(){var e,t,r,n=this,i=n.constructor,o=n.s,a=n.e,s=new i("0.5");if(!n.c[0])return new i(n);if(o<0)throw Error(jt+"No square root");o=Math.sqrt(n+""),o===0||o===1/0?(t=n.c.join(""),t.length+a&1||(t+="0"),o=Math.sqrt(t),a=((a+1)/2|0)-(a<0||a&1),e=new i((o==1/0?"5e":(o=o.toExponential()).slice(0,o.indexOf("e")+1))+a)):e=new i(o+""),a=e.e+(i.DP+=4);do r=e,e=s.times(r.plus(n.div(r)));while(r.c.slice(0,a).join("")!==e.c.slice(0,a).join(""));return bt(e,(i.DP-=4)+e.e+1,i.RM)};K.times=K.mul=function(e){var t,r=this,n=r.constructor,i=r.c,o=(e=new n(e)).c,a=i.length,s=o.length,c=r.e,u=e.e;if(e.s=r.s==e.s?1:-1,!i[0]||!o[0])return e.c=[e.e=0],e;for(e.e=c+u,a<s&&(t=i,i=o,o=t,u=a,a=s,s=u),t=new Array(u=a+s);u--;)t[u]=0;for(c=s;c--;){for(s=0,u=a+c;u>c;)s=t[u]+o[c]*i[u-c-1]+s,t[u--]=s%10,s=s/10|0;t[u]=s}for(s?++e.e:t.shift(),c=t.length;!t[--c];)t.pop();return e.c=t,e};K.toExponential=function(e,t){var r=this,n=r.c[0];if(e!==Ae){if(e!==~~e||e<0||e>ct)throw Error(Ir);for(r=bt(new r.constructor(r),++e,t);r.c.length<e;)r.c.push(0)}return Rt(r,!0,!!n)};K.toFixed=function(e,t){var r=this,n=r.c[0];if(e!==Ae){if(e!==~~e||e<0||e>ct)throw Error(Ir);for(r=bt(new r.constructor(r),e+r.e+1,t),e=e+r.e+1;r.c.length<e;)r.c.push(0)}return Rt(r,!1,!!n)};K[Symbol.for("nodejs.util.inspect.custom")]=K.toJSON=K.toString=function(){var e=this,t=e.constructor;return Rt(e,e.e<=t.NE||e.e>=t.PE,!!e.c[0])};K.toNumber=function(){var e=Number(Rt(this,!0,!0));if(this.constructor.strict===!0&&!this.eq(e.toString()))throw Error(jt+"Imprecise conversion");return e};K.toPrecision=function(e,t){var r=this,n=r.constructor,i=r.c[0];if(e!==Ae){if(e!==~~e||e<1||e>ct)throw Error(yt+"precision");for(r=bt(new n(r),e,t);r.c.length<e;)r.c.push(0)}return Rt(r,e<=r.e||r.e<=n.NE||r.e>=n.PE,!!i)};K.valueOf=function(){var e=this,t=e.constructor;if(t.strict===!0)throw Error(jt+"valueOf disallowed");return Rt(e,e.e<=t.NE||e.e>=t.PE,!0)};var g=jo();const p={floor(e,t,r=0){if(isNaN(e))return"";const n=e<0?-1:1;return g(e).abs().times(g(10).pow(-r)).round(t,0).times(n).toFixed(t)},ceil(e,t,r=0){if(isNaN(e))return"";const n=e<0?-1:1;return g(e).abs().times(g(10).pow(-r)).round(t,3).times(n).toFixed(t)},roundPriceEp(e,t){return Number(g(e).div(t).round().times(t))},delimit(e){const t=String(e);let r="(\\d)(?=(\\d{3})+\\.)";return t.indexOf(".")<0&&(r="(\\d)(?=(\\d{3})+$)"),t.replace(new RegExp(r,"g"),"$1,")},pad(e){return(e<10?"0":"")+String(e)},priceToEp(e,t=4){if(isNaN(e)||e==="")return 0;const r=g(10).pow(t);return Number(g(String(e).trim()).times(r))},abbreviateNumber(e,t=2){const r=e.toString();if(g(e).lt(1e3))return this.floor(r,t);const n=[{number:1e3,unit:"K"},{number:1e6,unit:"M"},{number:1e9,unit:"B"},{number:1e12,unit:"T"},{number:1e15,unit:"P"},{number:1e18,unit:"E"}];let i;for(i=n.length-1;i>0&&!g(e).gte(n[i].number);i--);const o=n[i];if(!o)return r;const{number:a,unit:s}=o;return this.floor((Number(e)/a).toString().replace(/\.0+$|(\.[0-9]*[1-9])0+$/,"$1"),t)+s},startWithNumber(e){return/^\d/.test(e)},parseInt(e){const t={K:1e3,M:1e6,B:1e9,T:1e12,P:1e15,E:1e18},r=Object.keys(t).find(n=>e.endsWith(n));return r?parseInt(e.slice(0,-1))*t[r]:parseInt(e)},trimEnd0(e){const t=e.split(".");if(t.length<1||t.length<2)return e;const r=t[0],n=t[1].replace(/0+$/,"");return n===""?r:[r,n].join(".")}};function se(e,t){return Ee(g(e).minus(t))}function W(e,t){return Ee(g(e).plus(t))}function Er(...e){return e.length<1?"0":Ee(e.reduce((t,r)=>g(t).plus(r),g(0)))}function be(e,t){return Ee(g(e).times(t))}function Ze(e,t,r=-1,n=1){return r===-1?Ee(g(e).div(t)):Qe(g(e).div(t),r,n)}function Vo(e,...t){return t.length===0?Ee(e):Ee(t.reduce((r,n)=>r.gt(n)?g(n):r,g(e)))}function Sr(e,...t){return t.length===0?Ee(e):Ee(t.reduce((r,n)=>r.gt(n)?r:g(n),g(e)))}function ke(e,t){return g(e).gt(t)}function st(e,t){return g(e).lte(t)}function zu(e,t){return g(e).eq(t)}function ut(e,t=!1){const r=g(10).pow(g(e).toNumber());return t?Ee(r):r}function Qe(e,t=8,r=1){return g(e).round(t,r).toFixed(t)}function Ee(e){const t=g(e).abs().toString(),r=g(e).gte(0)?"":"-";if(!/e/.test(t))return r+t;const n=Number(t.match(/\d+$/)[0]),i=t.match(/^[\d\.]+/)[0].replace(/\./,"");return/e-/.test(t)?r+i.padStart(n+i.length,"0").replace(/^0/,"0."):i.length<n?r+i.padEnd(n+1,"0"):r+i.substring(0,n+1)+"."+i.substring(n+1)}function tt(e,t="symbol"){return e.reduce((r,n)=>r.set(n[t],n),new Map)}const $e=new z(1),Dr=new z(1),Wu=new z(1),De=new z(1),Ue=new z(1),zo=new z(1),$u=new z(1),$n=new z(1),Mr=new z(1),Wo=new z(1),Nr=new Re(Gu()),rt=new Re(!1),_r=new Re(6e-4),$o=new z(1),Ho=$o.pipe(l(e=>e.reduce((t,r)=>t.set("id_"+r.index_id,r),new Map))),qr=Ue.pipe(l(e=>e.map(t=>Object.assign(Object.assign({},t),{baseQtyScale:0,baseQtyFactor:1,quoteQtyScale:0,quoteQtyFactor:1})))),Hu=zo.pipe(l(e=>tt(e,"symbol")),ie(1)),vt=$e.pipe(l(e=>tt(e,"symbol")),ie(1)),le=$e.pipe(l(e=>tt(e,"currency")),ie(1)),Ar=le.pipe(h(e=>e.has("PT")),l(e=>e.get("PT")),ie(1)),He=De.pipe(l(e=>tt(e,"symbol")),ie(1)),Xo=De.pipe(l(e=>tt(e,"indexSymbol")),ie(1)),Xu=De.pipe(l(e=>tt(e,"markSymbol")),ie(1)),Hn=Ue.pipe(l(e=>tt(e,"symbol")),ie(1));$n.pipe(l(e=>tt(e,"currency")),ie(1));const Yu=De.pipe(l(e=>e.reduce((t,r)=>t.includes(r.settleCurrency)?t:[...t,r.settleCurrency],[]))),Yo=Yu.pipe(l(e=>[...e,"PT"]));$e.subscribe(e=>{Dr.next(e.filter(t=>!!t.inAssetsDisplay).map(t=>t.symbol)),Wu.next(e.filter(t=>!t.inAssetsDisplay).map(t=>t.symbol))});function Gu(){return{spot:0}}const Ku=le.pipe(h(e=>e.has("BTC")),l(e=>e.get("BTC")),G(null)),Ju=X.pipe(h(e=>e.type==="assets"),l(e=>e.data)),Zu=B([Ju,Ku]).pipe(h(([e,t])=>!!e&&!!t),l(([e,t])=>tl(e,t))),el={SPOT:"spot",SPOT_STRATEGY:"spotStrategy",SPOT_MARGIN:"spotMargin",CONTRACT:"contract",CONTRACT_STRATEGY:"contractStrategy",COPY_TRADE:"copyTrade",FIAT:"fiat",WM:"investment",LAUNCH_POOL:"investment",LENDING:"lending",UTA_TRADE:"trading",UTA_FUND:"funding"},ar={spotAll:["spot","spotStrategy"],contractAll:["contract","copyTrade","contractStrategy"],tradingAll:["trading","spotStrategy"],tradingBot:["spotStrategy","contractStrategy"]};function tl(e,t){const r=nn(e.btcTotalAssets,e.usdTotalAssets,e.usdtTotalAssets,e.localCcyTotalAssets,t.valuePrecision),n=e.details.reduce((a,s)=>{const c=el[s.walletType];let{btcTotalAssets:u,usdTotalAssets:d,usdtTotalAssets:f,localCcyTotalAssets:b}=s;if(a.has(c)){const y=a.get(c);u=W(u,y.btcEv),d=W(d,y.usdEv),f=W(f,y.usdtEv),b=W(b,y.moneyEv)}return a.set(c,{btcEv:u,usdEv:d,usdtEv:f,moneyEv:b})},new Map).toObject(),i=Object.assign(Object.assign({},n),{spotAll:cr(ar.spotAll,n),contractAll:cr(ar.contractAll,n),tradingAll:cr(ar.tradingAll,n),tradingBot:cr(ar.tradingBot,n)}),o=nn(0,0,0,0,t.valuePrecision);return Object.assign(Object.assign({},r),{localCurrency:e.localCurrency,details:Object.assign({spot:o,contract:o,contractStrategy:o,copyTrade:o,fiat:o,lending:o,spotStrategy:o,spotMargin:o,trading:o,funding:o,investment:o,spotAll:o,contractAll:o,tradingAll:o,tradingBot:o},Object.keys(i).reduce((a,s)=>Object.assign(Object.assign({},a),{[s]:nn(i[s].btcEv,i[s].usdEv,i[s].usdtEv,i[s].moneyEv,t.valuePrecision)}),{}))})}function cr(e,t){return e.reduce((r,n)=>{const i=t[n];return i?{btcEv:W(r.btcEv,i.btcEv),usdEv:W(r.usdEv,i.usdEv),usdtEv:W(r.usdtEv,i.usdtEv),moneyEv:W(r.moneyEv,i.moneyEv)}:r},{btcEv:0,usdEv:0,usdtEv:0,moneyEv:0})}function nn(e,t,r,n,i){return{btcEv:e,btc:ur(e||0,i),usdEv:t,usd:ur(t||0,2),money:ur(n||0,2),usdtEv:r,usdt:ur(r||0,2)}}function ur(e,t=8){return p.delimit(p.floor(e||0,t,0))}function rl(){Zu.pipe(ge(300,Bt,{leading:!1,trailing:!0}),l(e=>({type:"assets",data:{assets:e}}))).subscribe(e=>D.next(e))}function Me(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r}function Fr(e,t){return e.hasOwnProperty("accounts_p1")?!![e.accounts_p1,e.positions_p1].find(r=>r&&r[0]&&r[0].userID===t):!![e.accounts,e.positions].find(r=>r&&r[0]&&r[0].userID===t)}function Go(e){var t,r,n,i;return e.accounts_p1?((t=e.accounts_p1[0])===null||t===void 0?void 0:t.userID)||((r=e.positions_p1[0])===null||r===void 0?void 0:r.userID):((n=e.accounts[0])===null||n===void 0?void 0:n.userID)||((i=e.positions[0])===null||i===void 0?void 0:i.userID)}function Pr(e){return e.wallets.length>0?e.wallets[0].userID:e.orders.closed.length>0?e.orders.closed[0].userID:e.orders.open.length>0?e.orders.open[0].userID:e.orders.fills.length>0?e.orders.fills[0].userID:""}const Ko=X.pipe(h(e=>e.type==="token-update"),l(e=>e),ie(1));Ko.subscribe();const Vt=X.pipe(h(e=>e.type==="user-logout")),Jo=Uo.pipe(h(e=>e==="Opened"),Je(()=>Ko),h(e=>!!e.token),Je(({token:e,platform:t="PC"})=>j.send({method:"user.auth",params:[t,e]})),ft()),nl=Jo.pipe(h(e=>e.error),Wn(e=>{D.next({type:"auth-error",error:e.error}),console.warn("user.auth error:",e.error)}),ft()),Te=Jo.pipe(h(e=>!e.error)),fe=F(nl,Vt),Xn=new Re(!1);Te.subscribe(()=>Xn.next(!0));fe.subscribe(()=>Xn.next(!1));const Ne=new Re(0),Ct=new Re([]),Yn=Ct.pipe(l(e=>e.map(t=>t.userId))),Zo=Ct.pipe(l(e=>e.filter(ts).map(t=>t.userId))),Gn=Ct.pipe(l(e=>e.filter(es).map(t=>t.userId))),Ur=Ct.pipe(l(e=>e.filter(t=>ts(t)||es(t)).map(t=>t.userId))),il=Ct.pipe(l(e=>e.filter(ol).map(t=>t.userId)));X.pipe(h(e=>e.type==="sub-users-subscribe")).subscribe(e=>{Ne.next(e.users.main.userId),Ct.next(e.users.subs)});function es(e){return e.userBizType==="CT_FOLLOWER"}function ts(e){return e.userBizType==="BOT_TRADE_ACCOUNT"&&["CONTRACT","CONTRACT_MARTINGALE","CONTRACT_SIGNAL"].includes(e.botType)}function ol(e){return e.userBizType==="BOT_TRADE_ACCOUNT"&&e.botType==="SPOT"}Te.subscribe(()=>j.next({method:"service.subscribe",params:["service.account"]}));const rs=re.pipe(h(e=>e.msgType==="account.user.common"&&e.payload&&!!e.payload[0]),l(e=>e.payload[0]));B([Te,Ur]).pipe(h(([,e])=>e.length>0)).subscribe(([,e])=>{const t=ns(e);j.next({method:"aop_v1.subscribe",params:t}),j.next({method:"aop_p1.subscribe",params:t})});function ns(e,t=!1){return[0,t,!0,e,!0]}const is=re.pipe(h(e=>!!e.accounts&&!!e.orders&&!!e.positions),we(Ne),h(([e,t])=>!Fr(e,t)),l(([e])=>(e.accounts=ss(e.accounts),e.positions=as(e.positions,e.accounts),{userId:Go(e),data:Object.assign({},e)}))),os=re.pipe(h(e=>!!e.accounts_p1&&!!e.orders_p1&&!!e.positions_p1),we(Ne),h(([e,t])=>!Fr(e,t)),l(([e])=>{const{accounts_p1:t,orders_p1:r,positions_p1:n,events_p1:i}=e,o=Me(e,["accounts_p1","orders_p1","positions_p1","events_p1"]),a=ss(t);return{userId:Go(e),data:Object.assign(Object.assign({},o),{accounts:a,orders:r,positions:as(n,a),events:i})}}));function ss(e){return e.forEach(t=>{t.tradeLevel=t.tradeLevel||0}),e}function as(e,t){return e.map(r=>{const n=t.find(i=>i.accountID===r.accountID);return n&&(r.tradeLevel=n.tradeLevel),r})}let mr=0;Te.pipe(we(Ne),h(([,e])=>!!e)).subscribe(([,e])=>{mr=Date.now();const t=ns(e,!0);j.next({method:"aop_v1.subscribe",params:t}),j.next({method:"aop_p1.subscribe",params:t})});const zt=re.pipe(h(e=>!!e.accounts&&!!e.orders&&!!e.positions),we(Ne),h(([e,t])=>!t||Fr(e,t)),l(([e])=>(e.accounts=cs(e.accounts),e.positions=us(e.positions,e.accounts),e))),kt=re.pipe(h(e=>!!e.accounts_p1&&!!e.orders_p1&&!!e.positions_p1),we(Ne),h(([e,t])=>!t||Fr(e,t)),l(e=>{var[t]=e,{accounts_p1:r,orders_p1:n,positions_p1:i,events_p1:o}=t,a=Me(t,["accounts_p1","orders_p1","positions_p1","events_p1"]);const s=cs(r);return Object.assign(Object.assign({},a),{accounts:s,orders:n,positions:us(i,s),events:o})}));function cs(e){return e.forEach(t=>{t.tradeLevel=t.tradeLevel||0}),e}function us(e,t){return e.map(r=>{const n=t.find(i=>i.accountID===r.accountID);return n&&(r.tradeLevel=n.tradeLevel),r})}F(zt,kt).subscribe(sl);function sl(e){const{accounts:t,positions:r,sequence:n,timestamp:i,type:o,version:a,guid:s=""}=e,c=t.map(al),u=r.filter(y=>y.size>0).map(cl),d=(e.orders.open||[]).map(ul),f=Date.now()-mr,b=Date.now()-mr;Qr("aop_debug",{guid:s,as:c,ps:u,os:d,sequence:n,timestamp:i,type:o,version:a,subTime:mr,delayV1:f,delayP1:b})}function al(e){const{currency:t,accountID:r,accountBalanceRv:n,accountBalanceEv:i,bonusBalanceRv:o,bonusBalanceEv:a,totalUsedBalanceRv:s,totalUsedBalanceEv:c,unrealisedPnlRv:u,unrealisedPnlEv:d,tradeLevel:f}=e;return t==="USDT"?{currency:t,accountID:r,accountBalanceRv:n,bonusBalanceRv:o,totalUsedBalanceRv:s,unrealisedPnlRv:u,tradeLevel:f}:{currency:t,accountID:r,accountBalanceEv:i,bonusBalanceEv:a,totalUsedBalanceEv:c,unrealisedPnlEv:d,tradeLevel:f}}function cl(e){const t={symbol:e.symbol,size:e.size,currency:e.currency,freeQty:e.freeQty},r=!!e.leverageRr;return Object.assign(t,r?{leverageRr:e.leverageRr,unrealisedPnlRv:e.unrealisedPnlRv,liquidationPriceRp:e.liquidationPriceRp,assignedPosBalanceRv:e.assignedPosBalanceRv}:{leverageEr:e.leverageEr,unrealisedPnlEv:e.unrealisedPnlEv,liquidationPriceEp:e.liquidationPriceEp,assignedPosBalanceEv:e.assignedPosBalanceEv})}function ul(e){return{symbol:e.symbol,orderID:e.orderID,cumQty:e.cumQty,orderQty:e.orderQty,curPosSide:e.curPosSide,ordStatus:e.ordStatus,ordType:e.ordType}}const ls=zt.pipe(h(e=>!!e.orders)),ps=ls.pipe(h(e=>e.type==="snapshot")),ds=ls.pipe(h(e=>e.type==="incremental")),fs=kt.pipe(h(e=>!!e.orders)),ys=fs.pipe(h(e=>e.type==="snapshot"),l(vs)),bs=fs.pipe(h(e=>e.type==="incremental"),l(vs)),Lr=F(ps,ys),nt=F(ds,bs);nt.subscribe(e=>D.next({type:"incremental-order",data:{incremental:!0,aop:e}}));function vs(e){var{orders:t}=e,r=Me(e,["orders"]);const n=ll(t.closed),i=dl(t.open),o=pl(t.fills);return Object.assign(Object.assign({},r),{orders:{closed:n,open:i,fills:o}})}function ll(e){return e.map(t=>Object.assign(Object.assign({},t),{accountID:t.accountID,action:t.action,actionTimeNs:t.actionTimeNs,bonusChangedAmountEv:Number(t.bonusChangedAmountRv||0),clOrdID:t.clOrdID,closedPnlEv:Number(t.closedPnlRv||0),closedSize:t.closedSize,code:t.code,cumQty:t.cumQty,cumValueEv:Number(t.cumValueRv||0),curPosSide:t.curPosSide,currency:t.currency,cxlRejReason:t.cxlRejReason,displayQty:t.displayQty,execStatus:t.execStatus,leavesQty:t.leavesQty,leavesValueEv:Number(t.leavesValueRv||0),ordStatus:t.ordStatus,ordType:t.ordType,orderID:t.orderID,orderQty:Number(t.orderQty||0),pegOffsetValueEp:Number(t.pegOffsetValueRp||0),priceEp:Number(t.priceRp||0),side:t.side,stopLossEp:Number(t.stopLossRp||0),stopPxEp:Number(t.stopPxRp||0),symbol:t.symbol,takeProfitEp:Number(t.takeProfitRp||0),timeInForce:t.timeInForce,curPosTerm:t.curPosTerm,posSide:t.posSide}))}function pl(e){return e.map(t=>Object.assign(Object.assign({},t),{accountID:t.accountID,bonusChangedAmountEv:t.bonusChangedAmountRv,currency:t.currency,execFeeEv:t.execFeeRv,ptFeeEv:t.ptFeeRv,ptPriceEp:t.ptPriceRp,execID:t.execID,execPriceEp:t.execPriceRp,execQty:Number(t.execQty||0),execSeq:t.execSeq,execStatus:t.execStatus,execValueEv:t.execValueRv,ordType:t.ordType,orderID:t.orderID,orderQty:Number(t.orderQty||0),priceEp:Number(t.priceRp||0),side:t.side,symbol:t.symbol,tradeType:t.tradeType,transactTimeNs:t.transactTimeNs,userID:t.userID,curPosTerm:t.curPosTerm,posSide:t.posSide}))}function dl(e){return e.map(t=>Object.assign(Object.assign({},t),{accountID:t.accountID,action:t.action,actionTimeNs:t.actionTimeNs,bonusChangedAmountEv:Number(t.bonusChangedAmountRv||0),clOrdID:t.clOrdID,closedPnlEv:Number(t.closedPnlRv||0),closedSize:t.closedSize,code:t.code,cumQty:t.cumQty,cumValueEv:Number(t.cumValueRv||0),curPosSide:t.curPosSide,currency:t.currency,cxlRejReason:t.cxlRejReason,displayQty:t.displayQty,execStatus:t.execStatus,leavesQty:Number(t.leavesQty||0),leavesValueEv:Number(t.leavesValueRv||0),ordStatus:t.ordStatus,ordType:t.ordType,orderID:t.orderID,orderQty:Number(t.orderQty||0),pegOffsetValueEp:Number(t.pegOffsetValueRp||0),pegOffsetProportionEr:Number(t.pegOffsetProportionRr||0),priceEp:Number(t.priceRp||0),side:t.side,slTrigger:t.slTrigger,stopLossEp:Number(t.stopLossRp||0),stopPxEp:Number(t.stopPxRp||0),stopDirection:t.stopDirection,symbol:t.symbol,takeProfitEp:Number(t.takeProfitRp||0),timeInForce:t.timeInForce,tpTrigger:t.tpTrigger,trigger:t.trigger,transactTimeNs:t.transactTimeNs,userID:t.userID,curPosTerm:t.curPosTerm,posSide:t.posSide,execQty:Number(t.execQty||0),execInst:t.execInst,pegPriceType:t.pegPriceType,actionBy:t.actionBy}))}const fl={New:"orderSubmitted",PartiallyFilled:"orderFilled",Filled:"orderFilled",Canceled:"orderCanceled"},yl={Untriggered:"orderSubmitted",New:"orderTriggered",PartiallyFilled:"orderFilled",Filled:"orderFilled",Deactivated:"orderCanceled",Canceled:"orderCanceled"},bl=nt.pipe(l(({orders:{open:e,closed:t}})=>[...t,...e])),vl=bl.pipe(l(e=>e.map(ml).filter(Boolean)));function ml(e){return["New","Replace","Cancel"].indexOf(e.action)>-1?["Market","Limit"].indexOf(e.ordType)>-1?fl[e.ordStatus]:["Stop","StopLimit","LimitIfTouched","MarketIfTouched"].indexOf(e.ordType)>-1?yl[e.ordStatus]:"":""}function hl(){vl.pipe(l(e=>({type:"audios",data:{audios:e}}))).subscribe(e=>D.next(e))}function ms(e){const t=e.pipe(h(i=>!!i.orders)),r=t.pipe(h(i=>i.type==="snapshot"),l(i=>i.orders)),n=t.pipe(h(i=>i.type==="incremental"),l(i=>i.orders));return{orders$:t,snapshotOrders$:r,incrementalOrders$:n}}Te.subscribe(()=>j.next({method:"wo.subscribe",params:[]}));const Kn=re.pipe(h(e=>!!e.wallets&&!!e.orders)),{orders$:q0,snapshotOrders$:jr,incrementalOrders$:mt}=ms(Kn);mt.subscribe(e=>D.next({type:"incremental-order",data:{incremental:!0,wo:e}}));const gl={New:"orderSubmitted",PartiallyFilled:"orderFilled",Filled:"orderFilled",Canceled:"orderCanceled"},El={Untriggered:"orderSubmitted",New:"orderTriggered",PartiallyFilled:"orderFilled",Filled:"orderFilled",Deactivated:"orderCanceled",Canceled:"orderCanceled"},Sl=mt.pipe(l(e=>{const t=[...e.open,...e.closed,...e.fills];return Object.values(t.toObject("orderID")).map(Pl).filter(Boolean)}));function Pl(e){return["New","Replace","Cancel"].indexOf(e.action)>-1?["Market","Limit"].indexOf(e.ordType)>-1?gl[e.ordStatus]:["Stop","StopLimit","LimitIfTouched","MarketIfTouched"].indexOf(e.ordType)>-1?El[e.ordStatus]:"":""}function Tl(){Sl.pipe(l(e=>({type:"audios",data:{audios:e}}))).subscribe(e=>D.next(e))}const hs=new z(1),Xe=new z(1),Se=new z(1),xl=X.pipe(h(e=>e.type==="state-symbol"));B([xl,Ue,Mr,De]).subscribe(([e,t,r,n])=>{const{tradeType:i,symbol:o,mode:a}=e;if(i==="Spot"){const s=(a==="Margin"?r:t).find(c=>c.symbol===o);if(!s)return;Xe.next(s),Se.next(s);return}if(["Perpetual","PerpetualV2"].indexOf(i)>-1){const s=n.find(c=>c.symbol===o);if(!s)return;hs.next(s),Se.next(s)}});const wl=X.pipe(h(e=>e.type==="order-book-depth"),l(e=>e.depth),G(10)),Bl=new Re(30),gs=X.pipe(h(e=>e.type==="order-book-type"),l(e=>e.percentType),G("Stack")),Ol=X.pipe(h(e=>e.type==="book-step-size"&&["Perpetual","PerpetualV2"].indexOf(e.tradeType)>-1),l(e=>e.stepSizeEx),G(0)),Rl=X.pipe(h(e=>e.type==="book-step-size"&&e.tradeType==="Spot"),l(e=>e.stepSizeEx),G(0)),Jn=X.pipe(h(e=>e.type==="contract-qty-type"),l(e=>e.qtyType),G("ByCont"),ie(1)),Es=B([Se,Ol,Rl]).pipe(l(Cl),Ie());function Cl([e,t,r]){return e.type==="Spot"?r:["Perpetual","PerpetualV2"].indexOf(e.type)>-1?t:0}const kl=re.pipe(h(e=>!!e.book||!!e.orderbook_p),l(e=>{const{orderbook_p:t,book:r}=e,n=Me(e,["orderbook_p","book"]);return Object.assign(Object.assign({},n),{book:r||{asks:Ci(t.asks),bids:Ci(t.bids)}})}));function Ci(e){return e.map(t=>t.map(r=>Number(r)))}function ki(e,t){return[...e.keys()].sort(t==="Bid"?Ql:Il)}function Ql(e,t){return t-e}function Il(e,t){return e-t}const Dl=Se.pipe(Ie(),l(_l)),Ss=B([kl,Se]).pipe(h(([e,t])=>e.symbol===t.symbol),l(e=>e[0])),Ml=Ss.pipe(h(e=>e.type==="snapshot"),l(ql)),Nl=Ss.pipe(h(e=>e.type==="incremental"),l(Al)),Zn=F(Dl,Ml,Nl).pipe(G(e=>e),H((e,t)=>t(e),Fl()),l(Ul));function _l(e){return function(t){const{bids:r,asks:n}=t;return r.clear(),n.clear(),{tradePair:e,bids:r,asks:n}}}function ql(e){return function(t){const{tradePair:r,bids:n,asks:i}=t;n.clear(),i.clear();const{book:o}=e;return Tr(n,o.bids),Tr(i,o.asks),{tradePair:r,bids:n,asks:i}}}function Al(e){return function(t){const{tradePair:r,bids:n,asks:i}=t,{book:o}=e;return Tr(n,o.bids),Tr(i,o.asks),jl(n,o.asks),Vl(i,o.bids),{tradePair:r,bids:n,asks:i}}}function Fl(){return{tradePair:null,bids:new Map,asks:new Map}}function Ul({tradePair:e,bids:t,asks:r}){return{tradePair:e,bids:t,bidPriceEps:ki(t,"Bid"),asks:r,askPriceEps:ki(r,"Ask")}}function Tr(e,t){t.forEach(r=>Ll(e,r))}function Ll(e,t){if(t[1]===0){e.delete(t[0]);return}e.set(t[0],t[1])}function jl(e,t){if(t.length>0){const r=Math.min(...Ps(t));[...e.keys()].filter(n=>n>=r).forEach(n=>e.delete(n))}}function Vl(e,t){if(t.length>0){const r=Math.max(...Ps(t));[...e.keys()].filter(n=>n<=r).forEach(n=>e.delete(n))}}function Ps(e){return e.filter(t=>t[1]>0).map(t=>t[0])}const zl=450;function xr(e,t){e.forEach(r=>r.percent=(r.total*100/t).toFixed(2))}function Qi(e,t){e.forEach(r=>r.percent=(r.total*100/t).toFixed(2))}function wr(e,t,r,n,i){e.forEach((o,a)=>{const{size:s}=o,c=r.get(a),u=n.get(a)||0,d=i.get(a),f=Wl(d,s-c,zl>t-u);r.set(a,s),f!==d&&(i.set(a,f),n.set(a,t)),o.ss=f})}function Wl(e,t,r){if(e===void 0)return 0;if(t===0||r&&(t>0&&(e===1||e===2)||t<0&&(e===3||e===4)))return e;if(e===0){if(t>0)return 1;if(t<0)return 3}if(e===1){if(t>0)return 2;if(t<0)return 3}if(e===2){if(t>0)return 1;if(t<0)return 3}if(e===3){if(t>0)return 1;if(t<0)return 4}if(e===4){if(t>0)return 1;if(t<0)return 3}return e}function $l(e,t,r,n,i,o,a){const{symbol:s,pricePrecision:c,quoteQtyScale:u,baseQtyPrecision:d,baseQtyScale:f,quoteQtyPrecision:b}=e,y=r.map((O,Q)=>Ii(O,t.get(O),Q,"bid",c,u,d,f)),m=i.map((O,Q)=>Ii(O,n.get(O),Q,"ask",c,u,d,f)),v=Date.now(),{bidSizeCache:E,askSizeCache:S,bidTimeCache:x,askTimeCache:T,bidStatusCache:P,askStatusCache:w}=o;return wr(y,v,E,x,P),wr(m,v,S,T,w),a==="Stack"&&Hl(y,m,d,f),a==="Each"&&Xl(y,m,u,f,b),{reset:!1,symbol:s,bids:y,asks:m,bid1Ep:y.length>0?y[0].priceEp:0,ask1Ep:m.length>0?m[0].priceEp:0}}function Ii(e,t,r,n,i,o,a,s){return{priceEp:e,price:p.floor(e,i,o),size:t,sizeStr:p.abbreviateNumber(p.floor(t,a,s),a),total:0,totalStr:"0",percent:"0",[n]:!0,odd:r%2!==0,ss:0,rowSize:t}}function Di(e,t,r,n){const i=e+t.size;return t.total=i,t.totalStr=p.abbreviateNumber(p.floor(i,r,n),r),i}function Hl(e,t,r,n){const i=e.reduce((s,c)=>Di(s,c,r,n),0),o=t.reduce((s,c)=>Di(s,c,r,n),0),a=Math.max(i,o);xr(e,a),xr(t,a)}function Mi(e,t,r,n,i){const o=t.priceEp*t.size;t.total=o;const a=p.floor(o,i,r+n);return t.totalStr=p.delimit(a),Math.max(e,o)}function Xl(e,t,r,n,i){const o=e.reduce((c,u)=>Mi(c,u,r,n,i),0),a=t.reduce((c,u)=>Mi(c,u,r,n,i),0),s=Math.max(o,a);Qi(e,s),Qi(t,s)}var te;(function(e){e.Cont="ByCont",e.Base="ByValue",e.Coin="ByCoin"})(te||(te={}));function Yl(e,t,r,n,i,o,a){const{symbol:s,contractSide:c,contractSize:u,valuePrecision:d,contractSizePrecision:f}=e,b=r.map((w,O)=>Ni(w,t.get(w),O,"bid",a,e)),y=i.map((w,O)=>Ni(w,n.get(w),O,"ask",a,e)),m=Date.now(),{bidSizeCache:v,askSizeCache:E,bidTimeCache:S,askTimeCache:x,bidStatusCache:T,askStatusCache:P}=o;return wr(b,m,v,S,T),wr(y,m,E,x,P),Gl(b,y,a,c,u,d,f),{reset:!1,symbol:s,bids:b,asks:y,bid1Ep:b.length>0?b[0].priceEp:0,ask1Ep:y.length>0?y[0].priceEp:0}}function Ni(e,t,r,n,i,o){const{pricePrecision:a,priceScale:s,contractSide:c,contractSize:u,valuePrecision:d,contractSizePrecision:f,qtyPrecision:b,priceFactor:y}=o,m=Jl(t,e,i,c,u,y),v=Kl(m,i,d,f,b);return{priceEp:e,price:p.floor(e,a,s),size:m,sizeStr:v,total:0,totalStr:"0",percent:"0",[n]:!0,odd:r%2!==0,ss:0,rowSize:t}}function Gl(e,t,r,n,i,o,a){const s=e.reduce((d,f)=>_i(d,f,r,n,i,o,a),0),c=t.reduce((d,f)=>_i(d,f,r,n,i,o,a),0),u=Math.max(s,c);xr(e,u),xr(t,u)}function _i(e,t,r,n,i,o,a){const s=Number(g(t.size).plus(e));let c=2;return r===te.Cont&&(c=s>1e3?2:0),r===te.Base&&(c=o),r===te.Coin&&(c=s>1e3?2:a),t.total=s,t.totalStr=p.abbreviateNumber(s,c),s}function Kl(e,t,r,n,i){if(t===te.Cont){const o=e>1e3?2:i;return p.abbreviateNumber(e,o)}if(t===te.Base)return p.abbreviateNumber(e,r);if(t===te.Coin){const o=e>1e3?2:n;return p.abbreviateNumber(e,o)}return"0"}function Jl(e,t,r,n,i,o){return r===te.Cont?e:r===te.Base?Zl(e,n,i,t,o):r===te.Coin?Number(g(e).times(i)):0}function Zl(e,t,r,n,i=0){const o=g(e).times(r);return Number(t>0?o.times(n).div(i):o.times(i).div(n))}const Ts=Se.pipe(l(({symbol:e})=>({reset:!0,symbol:e,bids:[],asks:[],bid1Ep:0,ask1Ep:0}))),xs=Se.pipe(l(({symbol:e})=>({symbol:e,bidSizeCache:new Map,askSizeCache:new Map,bidTimeCache:new Map,askTimeCache:new Map,bidStatusCache:new Map,askStatusCache:new Map}))),ep=B([Zn,wl,Es]).pipe(l(ws),h(Boolean)),tp=B([ep,xs,gs,Jn]).pipe(h(([e,t])=>e.tradePair.symbol===t.symbol),l(Bs)),rp=F(Ts,tp),np=B([Zn,Bl,Es]).pipe(l(ws),h(Boolean)),ip=B([np,xs,gs,Jn]).pipe(h(([e,t])=>e.tradePair.symbol===t.symbol),l(Bs)),op=F(Ts,ip);function ws([e,t,r]){const{tradePair:n}=e;if(n===null)return null;const i=r===0?ap(n):r,[o,a]=qi(e.bids,e.bidPriceEps,t,i,"Bid"),[s,c]=qi(e.asks,e.askPriceEps,t,i,"Ask");return{tradePair:n,bidCache:o,bidPriceEps:a,askCache:s,askPriceEps:c}}function Bs([{tradePair:e,bidCache:t,bidPriceEps:r,askCache:n,askPriceEps:i},o,a,s]){return e.type==="Spot"?$l(e,t,r,n,i,o,a):["Perpetual","PerpetualV2"].indexOf(e.type)>-1?Yl(e,t,r,n,i,o,s):null}function qi(e,t,r,n,i){const o=new Map;for(let a=0,s=t.length;a<s;a++){const c=t[a],u=sp(c,n,i);if(o.size===r&&!o.has(u))break;const d=(o.get(u)||0)+e.get(c);o.set(u,d)}return[o,[...o.keys()]]}function sp(e,t,r){const n=g(e).mod(t),i=g(e).minus(n);return Number(n.eq(0)?e:r==="Bid"?i:i.plus(t))}function ap(e){return e&&["Perpetual","PerpetualV2"].indexOf(e.type)>-1?e.tickSizeEp:e&&e.type==="Spot"?e.quoteTickSizeEv:0}function cp(){Se.subscribe(e=>{const t=e.type==="PerpetualV2",r=t?"orderbook_p.unsubscribe":"orderbook.unsubscribe",n=t?"orderbook_p.subscribe":"orderbook.subscribe";j.next({method:r,params:[]}),j.next({method:n,params:[e.symbol,!0]})}),B([Se,rp]).subscribe(([e,t])=>{const r=Ai(e);D.next({type:"orderbook",data:{book:r?t:Fi()}})}),B([Se,op]).subscribe(([e,t])=>{const r=Ai(e);D.next({type:"fixation-order-book",data:{book:r?t:Fi()}})})}function Ai(e){const[,t]=e.timeline||[0,0];return Date.now()>t}function Fi(){return{ask1Ep:0,asks:[],bid1Ep:0,bids:[],reset:!0,symbol:""}}const _={toValueUnit(e){return Et(e)||e.contractSide>0?e.settleCurrency:e.contractUnderlyingAssets},toValueQuantity(e,t,r){return Et(e)?sn(r)?"-":p.floor(g(t).mul(r),4):e.contractSide>0?sn(r)?"-":p.floor(g(t).mul(e.contractSize).mul(r),2):p.floor(g(t).mul(e.contractSize),2)},toValue(e,t,r){return on(_.toValueQuantity(e,t,r),_.toValueUnit(e))},toCoinUnit(e){return Et(e)||e.contractSide>0?e.contractUnderlyingAssets:e.settleCurrency},toCoinQuantity(e,t,r){return!t||!e?"-":Et(e)?p.floor(t,e.qtyPrecision):e.contractSide>0?p.floor(g(t).mul(e.contractSize),4):sn(r)||Number(r)===0?"-":p.floor(g(t).mul(e.contractSize).div(r),8)},toCoin(e,t,r){return on(_.toCoinQuantity(e,t,r),_.toCoinUnit(e))},toContUnit(e){return Et(e)?"":"Cont"},toContQuantity(e,t){return Et(e)?"-":t},toCont(e,t){return on(_.toContQuantity(e,t),_.toContUnit(e))},getUnit(e,t){return{[te.Cont]:()=>_.toContUnit(e),[te.Base]:()=>_.toValueUnit(e),[te.Coin]:()=>_.toCoinUnit(e)}[t]()}};function Os(e,t){return{MarketIfTouched:e.stopPxEp,Stop:e.stopPxEp}[t]||e.priceEp}function Et(e){return e.type==="PerpetualV2"}function on(e,t){return e=e===void 0?"-":e,t?`${e} ${t}`:`${e}`}function sn(e){return isNaN(e)||e===""}const Bn={unit:"X",precision:2},Br={marginRateErToLeverageEr(e,t=8,r=8){const n=g(10).pow(t+r).div(e).toNumber();return Number(g(n).round(2,g.roundUp).toFixed(2))},marginRateErToLeverage(e,t=8,r=8){return this.leverageErToLeverage(this.marginRateErToLeverageEr(e,t,r),r)},leverageErToLeverage(e,t=8,{removeEnd0:r=!1,unit:n=Bn.unit}={}){const i=p.ceil(e,Bn.precision,t);return(r?p.trimEnd0(i):i)+n},createMaxLeverage$(e,t){const r=Ui(e);return B([r,t]).pipe(l(([n,i])=>Li(n,i.ratioScale)),h(Boolean),G({leverageEr:1e8,leverageX:"1X"}),ie(1))},createMaxLeverage(e,t){return!e||!t?{leverageEr:1e8,leverageX:"1X"}:Li(e.initialMarginEr,t.ratioScale)},createLeverageOptions$(e,t){const r=Ui(t);return B([r,e]).pipe(l(([n,i])=>ji(n,i)),h(Boolean),G([]),Ie(),ie(1))},createLeverageOptions(e,t){return!e||!t?[]:ji(t.initialMarginEr,e)},getMaxLeverageByLeverageOptions(e){const t=e.reduce((r,n)=>g(r.leverageEr).gt(n.leverageEr)?r:n,{leverageEr:0});return Object.assign(Object.assign({},t),{leverageX:`${t.leverage}X`})},getMaxLeverageByLeverages(e,t){return this.getMaxLeverageByLeverageOptions(this.createLeverageOptions(e,t))},convertSlideOptions(e){return e.sort((t,r)=>t.leverageEr-r.leverageEr).map(t=>({value:t.leverageEr,label:`${t.leverage}X`}))},ceilLeverageEr(e,t,r){return g(p.ceil(e,t,r)).times(g(10).pow(r)).toNumber()}};function Ui(e){return e.pipe(h(Boolean),l(t=>t.initialMarginEr))}function Li(e,t){const r=Br.marginRateErToLeverageEr(e,t,t);return{leverageEr:r,leverageX:Br.leverageErToLeverage(r,t)}}function ji(e,t){const r=t.find(n=>n.initialMarginEr===e);return r?r.options:null}function an(){return{maintenanceAmountRv:0,maintenanceMargin:0,maintenanceMarginRateRr:0}}function up(e,t,r){if(!e)return an();const{leverageMargin:n}=e;if(!r.has("id_"+n)||!t)return an();const{size:i,markPriceEp:o}=t,a=g(i).times(o).toNumber(),s=lp(t,n,r).sort((f,b)=>f.notionalValueRv-b.notionalValueRv).find(({notionalValueRv:f})=>f>=a);if(!s)return an();const{maintenanceMarginRateRr:c,maintenanceAmountRv:u}=s,d=Number(g(a).times(c).minus(u));return{maintenanceAmountRv:u,maintenanceMargin:d,maintenanceMarginRateRr:Number(c)}}function lp(e={size:0,riskLimitIndexId:0},t,r){var n,i,o;const{size:a,riskLimitIndexId:s}=e;if(a==0)return((n=r.get(t))===null||n===void 0?void 0:n.items)||[];if(s==0){const c=r.get(t)||{index_id:0},u=Number(c.index_id)-1e3;return((i=r.get("id_"+u)||r.get(t))===null||i===void 0?void 0:i.items)||[]}else return(o=r.get("id_"+s)||r.get(t))===null||o===void 0?void 0:o.items}const Oe=4,pp=1e4,Tt=2;function dp({side:e,contractSide:t,contractSize:r,qty:n,entryPriceEp:i,exitPriceEp:o,factor:a,priceFactor:s}){if(n===0||i===0||o===0)return 0;const c=Vi(t,r,s,a,n,i),u=Vi(t,r,s,a,n,o);return e==="Buy"?(u-c)*t:e==="Sell"?(c-u)*t:0}function Vi(e,t,r,n,i,o){return Number(Rs(e,t,r,i,o).times(n))}function fp(e,t,r,n,i,o){return Rs(e,t,r,i,o).round(n,0).toFixed(n)}function Rs(e,t,r,n,i){if(isNaN(n)||n===0||isNaN(i)||i===0)return g(0);const o=g(n).times(t);return e>0?o.times(i).div(r):e<0?o.times(r).div(i):g(0)}const ye=new z(1);X.pipe(h(e=>e.type==="update-fiat"),Eu("currency"),G("USD"),Ie()).subscribe(e=>ye.next(e));const Cs=re.pipe(h(e=>!!e.tick)),ks=re.pipe(h(e=>e.method==="perp_market24h_pack.update"),l(e=>e.data.map(Qs))),yp=re.pipe(h(e=>e.method==="perp_market24h_pack_p.update"),l(e=>e.data.map(Qs)));function Qs(e){return{symbol:e[0],open:Number(e[1]),high:Number(e[2]),low:Number(e[3]),close:Number(e[4]),volume:Number(e[5]),turnover:Number(e[6]),openInterest:Number(e[7]),indexPrice:Number(e[8]),markPrice:Number(e[9]),fundingRate:Number(e[10]),predFundingRate:Number(e[11])}}const Is=re.pipe(h(e=>e.method==="spot_market24h_pack.update"),l(e=>e.data.map(bp)));function bp(e){return{symbol:e[0],openEp:e[1],highEp:e[2],lowEp:e[3],lastEp:e[4],volumeEv:e[5],turnoverEv:e[6],bidEp:e[7],askEp:e[8],indexEp:e[9]}}const vp=B([ks,He]).pipe(l(gp),h(e=>e.length>0)),mp=B([Is,Hn]).pipe(l(Sp),h(e=>e.length>0)),hp=B([Cs,Xo]).pipe(l(([e,t])=>[Tp(e,t)])),ne=F(hp,vp,mp).pipe(G([{symbol:".USD",priceEp:pp,price:"1"}]),H((e,t)=>(t.forEach(({symbol:r,priceEp:n,price:i})=>e.set(r,{priceEp:n,price:i,priceFactor:1e4,priceScale:4})),e),new Map),ge(1e3),ie(1));function gp([e,t]){return e.map(r=>Ep(r,t)).filter(Boolean)}function Ep(e,t){const r=t.get(e.symbol);if(!r)return null;const n=g(e.indexPrice).times(g(10).pow(Oe-r.priceScale)).toNumber();return{symbol:r.indexSymbol,priceEp:n,price:p.floor(e.indexPrice,r.pricePrecision,r.priceScale)}}function Sp([e,t]){return e.map(r=>Pp(r,t)).filter(Boolean)}function Pp(e,t){const r=t.get(e.symbol);if(!r||!["USDT","MUSDT"].includes(r.quoteCurrency))return null;const n=g(e.indexEp).times(g(10).pow(Oe-r.quoteQtyScale)).toNumber();return{symbol:r.indexSymbol,priceEp:n,price:p.floor(e.indexEp,r.pricePrecision,r.quoteQtyScale)}}function Tp({tick:e},t){const{symbol:r,last:n,scale:i}=e,o=n*Math.pow(10,Oe-i),a=t.get(r),s=xp(a);return{symbol:r,priceEp:o,price:p.floor(o,s,Oe)}}function xp(e){return e?e.pricePrecision:2}Te.pipe(Tu(rt),h(Boolean)).subscribe(()=>{j.next({method:"ras.subscribe",params:{}})});const wp=re.pipe(h(e=>!!e.risk_units)),Ds=zt.pipe(h(e=>!!e.positions),l(({positions:e})=>e.map(t=>Object.assign(Object.assign({},Dp(t)),t)))),Ms=kt.pipe(h(e=>!!e.positions),l(({positions:e})=>ti(e))),Bp=B([hs,Hu,Ho,_r]).pipe(l(([e,t,r,n])=>kp(e,t,r,n))),Op=fe.pipe(l(()=>function(e){return e.clear(),e})),Rp=Ds.pipe(l(e=>function(t){return e.forEach(r=>{t.set(r.symbol,Object.assign(Object.assign(Object.assign({type:"Perpetual"},t.get(r.symbol)),r),Vr(r,t.get(r.symbol))))}),t})),Cp=Ms.pipe(l(e=>function(t){return e.forEach(r=>{const{symbol:n,posSide:i,posMode:o}=r,a=n+i;["Merged","Long","Short"].forEach(s=>{const c=n+s;t.has(c)&&t.set(c,Object.assign(Object.assign({},t.get(c)),{posMode:o}))}),t.set(a,Object.assign(Object.assign(Object.assign({type:"PerpetualV2"},t.get(a)),r),Vr(r,t.get(a))))}),t})),ei=F(Bp,Op,Rp,Cp).pipe(H((e,t)=>t(e),new Map));function kp(e,t,r,n){return function(i){const{type:o,symbol:a,settleCurrency:s,ratioFactor:c,defaultLeverage:u="-10",leverageMargin:d}=e,{riskLimitEv:f,initialMarginEr:b}=Qp(o,a,d,t,r);return(o==="Perpetual"?["Merged"]:["Merged","Long","Short"]).map(y=>Ip(o,y,a,f,s,u,b,c,n)).reduce((y,m)=>{const{type:v,symbol:E,posSide:S}=m,x=v==="Perpetual"?E:E+S;return y.has(x)?y:y.set(x,m)},i)}}function Qp(e,t,r,n,i){if(e==="Perpetual"){const o=n.get(t).riskLimits;if(o.length>0){const{riskLimitEv:a,initialMarginEr:s}=o[0];return{riskLimitEv:a,initialMarginEr:s}}}else{const o=i.get("id_"+r).items;if(o.length>0){const{notionalValueRv:a,maxLeverage:s}=o[0];return{riskLimitEv:a||0,initialMarginEr:g(1).div(s).round(2,0).toNumber()}}}return{riskLimitEv:0,initialMarginEr:0}}function Ip(e,t,r,n,i,o,a,s,c){const u=Math.abs(Number(o)),d=g(1).div(u),f=Number(d.plus(g(c).times(g(2).minus(d))).times(s)),b=Number(d.plus(g(c).times(g(2).plus(d))).times(s)),y=Number(g(u).times(s));return{accountID:0,assignedPosBalanceEv:0,avgEntryPriceEp:0,bankruptCommEv:0,bankruptPriceEp:0,buyLeavesQty:0,buyLeavesValueEv:0,buyValueToCostEr:f,createdAtNs:0,crossSharedBalanceEv:0,cumClosedPnlEv:0,cumFundingFeeEv:0,cumTransactFeeEv:0,curTermRealisedPnlEv:0,curTermDiscountFeeEv:0,currency:i,dataVer:3,deleveragePercentileEr:0,displayLeverageEr:y,estimatedOrdLossEv:0,execSeq:0,freeCostEv:0,freeQty:0,initMarginReqEr:a,lastFundingTime:0,lastTermEndTime:0,leverageEr:y,isCross:!0,isIsolated:!1,liquidationPriceEp:0,maintMarginReqEr:0,makerFeeRateEr:0,markPriceEp:0,orderCostEv:0,posCostEv:0,positionMarginEv:0,positionStatus:"Normal",riskLimitEv:n,sellLeavesQty:0,sellLeavesValueEv:0,sellValueToCostEr:b,side:"None",size:0,symbol:r,takerFeeRateEr:0,term:1,transactTimeNs:0,unrealisedPnlEv:0,updatedAtNs:0,usedBalanceEv:0,userID:0,valueEv:0,posMode:e==="PerpetualV2"?"Hedged":"OneWay",posSide:t,type:e}}function Vr(e,t){const r=e.leverageEr===void 0?t==null?void 0:t.leverageEr:e.leverageEr;return{leverageEr:Math.abs(r),isIsolated:r>0,isCross:r<=0}}function ti(e){return e.map(t=>Object.assign(Object.assign({},t),{accountID:t.accountID,assignedPosBalanceEv:Number(t.assignedPosBalanceRv)||0,avgEntryPriceEp:Number(t.avgEntryPriceRp)||0,bankruptCommEv:Number(t.bankruptCommRv)||0,bankruptPriceEp:Number(t.bankruptPriceRp)||0,buyLeavesQty:Number(t.buyLeavesQty)||0,buyLeavesValueEv:Number(t.buyLeavesValueRv)||0,buyValueToCostEr:Number(t.buyValueToCostRr)||0,createdAtNs:Number(t.createdAtNs)||0,crossSharedBalanceEv:Number(t.crossSharedBalanceRv)||0,cumClosedPnlEv:Number(t.cumClosedPnlRv)||0,cumFundingFeeEv:Number(t.cumFundingFeeRv)||0,cumTransactFeeEv:Number(t.cumTransactFeeRv)||0,curTermRealisedPnlEv:Number(t.curTermRealisedPnlRv)||0,cumPtFeeEv:Number(t.cumPtFeeRv)||0,curTermDiscountFeeEv:Number(t.curTermDiscountFeeRv)||0,curTermPtFeeEv:Number(t.curTermPtFeeRv)||0,currency:t.currency,dataVer:t.dataVer||0,deleveragePercentileEr:Number(t.deleveragePercentileRr)||0,displayLeverageEr:Number(t.displayLeverageRr)||0,estimatedOrdLossEv:Number(t.estimatedOrdLossRv)||0,execSeq:Number(t.execSeq)||0,freeCostEv:Number(t.freeCostRv)||0,freeQty:Number(t.freeQty)||0,initMarginReqEr:Number(t.initMarginReqRr)||0,lastFundingTime:Number(t.lastFundingTime)||0,lastTermEndTime:Number(t.lastTermEndTime)||0,leverageEr:Number(t.leverageRr)||0,liquidationPriceEp:Number(t.liquidationPriceRp)||0,maintMarginReqEr:Number(t.maintMarginReqRr)||0,makerFeeRateEr:Number(t.makerFeeRateRr)||0,markPriceEp:Number(t.markPriceRp)||0,orderCostEv:Number(t.orderCostRv)||0,posCostEv:Number(t.posCostRv)||0,positionMarginEv:Number(t.positionMarginRv)||0,positionStatus:t.positionStatus,riskLimitEv:Number(t.riskLimitRv)||0,sellLeavesQty:Number(t.sellLeavesQty)||0,sellLeavesValueEv:Number(t.sellLeavesValueRv)||0,sellValueToCostEr:Number(t.sellValueToCostRr)||0,side:t.side,size:Number(t.size),symbol:t.symbol,takerFeeRateEr:Number(t.takerFeeRateRr)||0,term:Number(t.term)||0,transactTimeNs:Number(t.transactTimeNs)||0,unrealisedPnlEv:Number(t.unrealisedPnlRv)||0,updatedAtNs:Number(t.updatedAtNs)||0,usedBalanceEv:Number(t.usedBalanceRv)||0,userID:Number(t.userID)||0,valueEv:Number(t.valueRv)||0,minPosCostRv:Number(t.minPosCostRv)||0,posMode:t.posMode,posSide:t.posSide}))}function Dp({accountID:e,currency:t,symbol:r,side:n}){return{side:n,symbol:r,currency:t,accountID:e,assignedPosBalanceEv:0,avgEntryPriceEp:0,bankruptCommEv:0,bankruptPriceEp:0,buyLeavesQty:0,buyLeavesValueEv:0,buyValueToCostEr:0,createdAtNs:0,crossSharedBalanceEv:0,cumClosedPnlEv:0,cumFundingFeeEv:0,cumTransactFeeEv:1,curTermRealisedPnlEv:-1,dataVer:0,deleveragePercentileEr:0,displayLeverageEr:0,estimatedOrdLossEv:0,execSeq:0,freeCostEv:0,freeQty:0,initMarginReqEr:0,lastFundingTime:0,lastTermEndTime:0,leverageEr:0,liquidationPriceEp:0,maintMarginReqEr:0,makerFeeRateEr:0,markPriceEp:0,orderCostEv:0,posCostEv:0,positionMarginEv:0,positionStatus:"Normal",riskLimitEv:0,sellLeavesQty:0,sellLeavesValueEv:0,sellValueToCostEr:0,size:0,takerFeeRateEr:0,term:0,transactTimeNs:0,unrealisedPnlEv:0,updatedAtNs:0,usedBalanceEv:0,userID:0,valueEv:0,marginRatioRr:"0",marginRatio:"--"}}const Mp=F(ks,yp).pipe(H((e,t)=>(t.forEach(r=>e.set(r.symbol,r)),e),new Map),we(Se),l(([e,t])=>{const r=e.has(t.symbol)?e:e.set(t.symbol,Lp(t));return Array.from(r.values())})),Np=B([He,Mp]).pipe(l(_p),h(e=>e.length>0),ie(1));function _p([e,t]){return t.map(r=>qp(e,r)).filter(Boolean)}function qp(e,t){const{symbol:r}=t,n=e.get(r);if(!n)return null;const{close:i,high:o,low:a,open:s,indexPrice:c,markPrice:u,volume:d,turnover:f,openInterest:b=0,fundingRate:y,predFundingRate:m}=t,{type:v,displaySymbol:E,pairName:S,baseCurrency:x,pricePrecision:T,priceScale:P,valuePrecision:w,valueScale:O,contractSize:Q,status:R,contractSide:I,valueFactor:k,settleCurrency:M,ratioScale:C}=n,N=p.floor(f,I>0?w:0,O),A=p.delimit(N),q=i-s,U=p.floor(q,T,P),V=Fp(i,s),$=I<0?d:f/k;if(!["Listed","Suspend"].includes(R))return jp(n);const Y=Number(p.floor(g(N).times(c),T,P));return{type:v,symbol:r,status:R,pairName:S,baseCurrency:x,symbolV2:S,displaySymbol:E,closeEp:i,openEp:s,indexPriceEp:c,indexPrice:p.floor(c,T,P),markPriceEp:u,markPrice:p.floor(u,T,P),close:p.floor(i,T,P),highEp:o,high:p.floor(o,T,P),lowEp:a,low:p.floor(a,T,P),open:p.floor(s,T,P),turnover:N,turnoverEv:f,turnoverStr:p.abbreviateNumber(N),turnoverWithUSDRaw:Y,turnoverWithUSD:p.abbreviateNumber(p.floor(g(N).times(c),T,P)),turnoverWU:A+" "+M,openInterest:b,openInterestStr:p.delimit(b),volume:d,volume24hStr:p.abbreviateNumber(Math.floor(d*Q)),volume24hWithUSD:p.abbreviateNumber(p.floor(g(d).times(Q).times(c),T,P)),fundingRate:y,fundingRateStr:p.floor(y,4,C-2),predFundingRate:m,predFundingRateStr:p.floor(m,4,C-2),change24hEp:q,change24hStr:Ap(q,U),changePercent:V,changePercentStr:Up(V),combinationTurnoverEv:$,contractSide:I,klineData:[],isCheapCopyToken:Y<1e7}}function Ap(e,t){return(e>0?"+":"")+t}function Fp(e,t){return e===0||t===0||e===t?0:(e-t)*100/t}function Up(e){if(e===0)return"--%";const t=e>0?"+":"",r=p.floor(e,2);return t+r+"%"}function Lp(e){return{close:0,fundingRate:0,high:0,indexPrice:0,low:0,markPrice:0,open:0,openInterest:0,predFundingRate:0,symbol:e.symbol,turnover:0,volume:0}}function jp({type:e,symbol:t,status:r,pairName:n,baseCurrency:i,displaySymbol:o,contractSide:a}){return{type:e,symbol:t,status:r,symbolV2:n,pairName:n,baseCurrency:i,displaySymbol:o,closeEp:0,openEp:0,indexPriceEp:0,indexPrice:"--",markPriceEp:0,markPrice:"--",close:"--",highEp:0,high:"--",lowEp:0,low:"--",open:"--",turnoverEv:0,turnoverStr:"--",turnoverWithUSDRaw:0,turnoverWithUSD:"--",turnoverWU:"--",openInterest:0,openInterestStr:"--",volume:0,volume24hStr:"--",volume24hWithUSD:"--",fundingRate:0,fundingRateStr:"--",predFundingRate:0,predFundingRateStr:"--",change24hEp:0,change24hStr:"--",changePercent:0,changePercentStr:"--%",combinationTurnoverEv:0,contractSide:a,klineData:[],turnover:"--",isCheapCopyToken:!1}}const Vp=Np.pipe(l(Wp)),zp=Cs.pipe(we(Xu,Xo),l($p)),Qt=F(Vp,zp).pipe(h(Boolean),H((e,t)=>t(e),{changed:!0,cache:new Map}),h(e=>e.changed),l(e=>e.cache),ge(1e3),ie(1));function Wp(e){return function(t){return t.changed=!0,e.forEach(r=>t.cache.set(r.symbol,r)),t}}function $p([e,t,r]){const{type:n,contract:i}=Hp(t,r,e.tick.symbol);return n==="None"?null:function(o){o.changed=!1;const{cache:a}=o,{symbol:s}=i;if(a.has(s)){const c=a.get(s),{last:u,scale:d}=e.tick,f=u*Math.pow(10,4-d),{pricePrecision:b,priceScale:y}=i,m=p.floor(f,b,y);if(n==="MarkPrice"&&c.markPriceEp!==f){o.changed=!0;const v=Object.assign(Object.assign({},c),{markPriceEp:f,markPrice:m});a.set(s,v)}if(n==="IndexPrice"&&c.indexPriceEp!==f){o.changed=!0;const v=Object.assign(Object.assign({},c),{indexPriceEp:f,indexPrice:m});a.set(s,v)}}return o}}function Hp(e,t,r){const n=e.get(r);if(n)return{type:"MarkPrice",contract:n};const i=t.get(r);return i?{type:"IndexPrice",contract:i}:{type:"None",contract:null}}const Xp=B([ei,Qt,_r]).pipe(ge(500),l(Yp),G(g(0)));function Yp([e,t,r]){const n=e.toArray().filter(({currency:i,isCross:o})=>["USDT","MUSDT"].includes(i)&&o);return Array.from(new Set(n.map(({symbol:i})=>i))).map(i=>{const o=n.filter(u=>u.symbol===i),a=o.every(({posMode:u})=>u==="OneWay"),s=t.get(i),c=s?s.markPriceEp:0;if(a){const u=o.find(({posMode:E,posSide:S})=>E==="OneWay"&&S==="Merged");if(!u)return g(0);const{side:d,size:f,buyValueToCostEr:b,sellValueToCostEr:y}=u,m=f&&c?g(f).times(c):g(0),v=d==="Buy"?b:y;return m.times(g(v).minus(r))}else{const u=o.find(({posMode:P,posSide:w})=>P==="Hedged"&&w==="Long"),d=o.find(({posMode:P,posSide:w})=>P==="Hedged"&&w==="Short"),f=(u==null?void 0:u.size)||0,b=(d==null?void 0:d.size)||0,y=f>b?u:d;if(!y)return g(0);const m=g(f).minus(b).abs(),v=m.gt(0)?g(m).times(c):g(0),{side:E,buyValueToCostEr:S,sellValueToCostEr:x}=y,T=E==="Buy"?S:x;return v.times(g(T).minus(r))}}).reduce((i,o)=>g(i).plus(o),g(0))}const Ns=B([wp.pipe(h(e=>!!e.risk_units)),Ne]).pipe(h(([e,t])=>{var r;return((r=e==null?void 0:e.risk_units[0])===null||r===void 0?void 0:r.userID)===t}),l(([e])=>e.risk_units)),_s=Ns.pipe(l(e=>Kp(e)),l(e=>e.reduce((t,r)=>t.set(r.symbol+r.posSide,r),new Map)),G(new Map),ie(1)),Gp=B([Ns,Xp]).pipe(l(([e,t])=>qs(e,t)),G({totalBalanceRv:0,totalUsedBalanceRv:0,isolatedTotalBalanceRv:0,totalBonusRv:0,uid:0}));function qs(e,t){const r=e.reduce((a,{totalBalanceRv:s="0"})=>Number(g(a).plus(s)),0),n=e.filter(({symbol:a})=>a).reduce((a,{totalBalanceRv:s="0"})=>Number(g(a).plus(s)),0),i=e.filter(({symbol:a})=>!a).reduce((a,{symbol:s,totalPosCostRv:c="0",totalDebtCostRv:u="0",totalOrdUsedBalanceRv:d="0",totalOrdOpenLossRv:f="0",fixedUsedRv:b="0"})=>{const y=g(!s&&t?t:c).plus(b).plus(d).plus(u).plus(f);return Number(g(a).plus(y))},0),o=e.reduce((a,{totalBonusRv:s="0"})=>Number(g(a).plus(s)),0);return{totalBalanceRv:r,totalUsedBalanceRv:i,totalBonusRv:o,isolatedTotalBalanceRv:n,uid:e&&e[0]&&e[0].userID}}function Kp(e){const t={0:"Invalid",1:"Long",2:"Short",3:"Merged"};return e.map(r=>{var{posSide:n}=r,i=Me(r,["posSide"]);const{totalBalanceRv:o=0,totalPosCostRv:a=0,totalDebtCostRv:s=0,totalOrdUsedBalanceRv:c=0,totalOrdOpenLossRv:u=0}=i,d=g(a).plus(s).plus(c).plus(u).toNumber();return Object.assign(Object.assign({},i),{posSide:t[n],accountBalanceRv:o,totalUsedBalanceRv:d})})}const Jp=zt.pipe(h(e=>!!e.accounts),l(e=>e.accounts)),Zp=kt.pipe(h(e=>!!e.accounts),l(e=>e.accounts)),ed=B([Zp,rt,Gp]).pipe(l(As));function As([e,t,r]){return e.map(({unrealisedPnlRv:n,userID:i,currency:o,accountID:a,accountBalanceRv:s,totalUsedBalanceRv:c,bonusBalanceRv:u})=>{const d=Number(n);let f,b,y,m;if(["USDT","MUSDT"].includes(o)){const v=t&&r?r:{totalBalanceRv:s,totalUsedBalanceRv:c,totalBonusRv:u,isolatedTotalBalanceRv:0};f=Number(v.totalBalanceRv),b=Number(v.totalUsedBalanceRv),y=Number(v.totalBonusRv),m=Number(v.isolatedTotalBalanceRv)}else f=Number(s),b=Number(c),y=Number(u),m=0;return{accountBalanceEv:f,accountID:a,bonusBalanceEv:y,currency:o,totalUsedBalanceEv:b,unrealisedPnlEv:d,userID:i,isolatedTotalBalanceEv:m}})}const td=Yo.pipe(l(e=>function(t){return Array.from(new Set(e)).reduce((r,n)=>r.has(n)?r:r.set(n,{accountBalanceEv:0,accountID:0,bonusBalanceEv:0,currency:n,totalUsedBalanceEv:0,userID:0,tradeLevel:0,isolatedTotalBalanceEv:0}),t)})),rd=Jp.pipe(l(e=>function(t){return e.forEach(r=>t.set(r.currency,r)),t})),nd=ed.pipe(l(e=>function(t){return e.forEach(r=>t.set(r.currency,r)),t})),id=fe.pipe(l(()=>function(e){return e.clear(),e})),Fs=F(td,rd,nd,id).pipe(H((e,t)=>t(e),new Map)),od=B([ye,ne]).pipe(l(([e,t])=>t.get("."+e)),Ie()),Us=B([ye,od]).pipe(l(([e,t])=>sd(e,t))),Ls=B([_s,ei,Ho,He,Qt,le,_r]).pipe(ge(500),l(([e,t,r,n,i,o,a])=>e.toArray().map(({symbol:s,posSide:c,valuationCurrency:u})=>{const d=["USDT","MUSDT"].includes(u),{valueScale:f,valuePrecision:b}=o.get(u),y=["USDC","USDT","MUSDT","PT"].indexOf(u)>-1?0:f;if(s){const m=s+c;if(t.has(m)){const v=t.get(m),E=n.get(v.symbol),{mmCost:S}=Wi(v,r,n,i,a),{accountBalanceRv:x}=e.get(m)||{accountBalanceRv:"0"},T=i.get(v.symbol),P=T?T.markPriceEp:0,w=Or(v,P,E),O=g(x).plus(w),Q=O.gt(0)?O:g(0),R=g(S).gt(0)?S:g(0),{marginRatioRr:I,marginRatio:k}=$i(d,O,S);return{key:m,symbol:s,side:v.side,currency:u,totalEquity:p.floor(Q,b,y),maintenanceMargin:p.floor(R,b,y),marginRatioRr:Number(I),marginRatio:k}}return null}else{const m=t.toArray().filter(({isCross:C,size:N,type:A})=>C&&N>0&&A==="PerpetualV2"),v=m.filter(({posMode:C})=>C==="OneWay").map(C=>{const{mmCost:N}=Wi(C,r,n,i,a);return N}).reduce((C,N)=>C.plus(N),g(0)),E=m.filter(({posMode:C})=>C==="Hedged"),S=Array.from(new Set(E.map(({symbol:C})=>C))).map(C=>{const N=E.filter(V=>V.symbol===C),A=N.find(({posSide:V})=>V==="Long"),q=N.find(({posSide:V})=>V==="Short"),{mmCost:U}=dd(A,q,r,n,i,a);return U}).reduce((C,N)=>C.plus(N),g(0)),x=m.reduce((C,N)=>{const A=i.get(N.symbol),q=n.get(N.symbol),U=A?A.markPriceEp:0,V=Or(N,U,q);return C.plus(V)},g(0)),{accountBalanceRv:T,totalOrdUsedBalanceRv:P,fixedUsedRv:w}=e.get("Invalid"),O=g(T).plus(x).minus(w||0).minus(P||0),Q=v.plus(S),R=O.gt(0)?O:g(0),I=Q.gt(0)?Q:g(0),{marginRatioRr:k,marginRatio:M}=$i(d,O,Q);return{key:"Cross",symbol:"",side:"",currency:u,totalEquity:p.floor(R,b,y),maintenanceMargin:p.floor(I,b,y),marginRatioRr:k,marginRatio:M}}}).filter(Boolean).reduce((s,c)=>s.set(c.key,c),new Map))),ri=B([He,ei,Qt,Fs,Us,Ls,rt]).pipe(l(([e,t,r,n,i,o,a])=>js(e,t,r,n,i,o,a)),ft());function sd(e,t){if(t){const{price:r,priceEp:n}=t;return{fiat:e,price:r,priceEp:n}}return null}function js(e,t,r,n,i,o,a){return t.toArray().map(s=>{const{symbol:c,currency:u}=s,d=e.get(c);if(!d)return null;const f=r.get(c);if(!f)return null;const b=n.get(u);return b?ad(s,d,f,b,i,o,a):null}).filter(Boolean)}function ad(e,t,r,n,i,o,a){var s,c;const{type:u,displaySymbol:d,settleCurrency:f,valuePrecision:b,pricePrecision:y,priceScale:m,valueScale:v}=t,{valueEv:E,assignedPosBalanceEv:S,curTermRealisedPnlEv:x,curTermDiscountFeeEv:T,size:P,side:w,posMode:O,posSide:Q,avgEntryPriceEp:R,liquidationPriceEp:I,riskLimitEv:k,buyLeavesValueEv:M,sellLeavesValueEv:C,isCross:N,symbol:A,bankruptCommEv:q,positionMarginEv:U}=e,V=S||0,$=p.floor(V,b,v),Y=t.type==="PerpetualV2",ee=a&&Y?Number(g(U).plus(q)):V,oe=p.floor(ee,b,v),me=r?r.closeEp:0,ae=r?r.markPriceEp:0,pe=r?r.indexPriceEp:0,Ce=Number(se(x,T||0)),_e=p.floor(Ce,b,v),Z=Or(e,me,t),Gt=p.floor(Z,b,v),Ye=Or(e,ae,t),Le=p.floor(Ye,b,v),Kt=ld(e,Ye),Jt=p.floor(Kt,b,v),ht=lr(t,i,ee,pe),It=lr(t,i,Ce,pe),gt=lr(t,i,Z,pe),Dt=lr(t,i,Ye,pe),Zt=pd(e,t.ratioScale),er=Br.leverageErToLeverage(Zt,t.ratioScale,{removeEnd0:!0,unit:""}),{accountBalanceEv:tr,totalUsedBalanceEv:rr}=n,Gr=tr-rr,nr=W(Y?W(S,Ye):S,Sr(Gr,0)),Mt=Y?be(ae,P):E,ir=+nr>0&&+Mt>0?g(Mt).div(nr):0,Kr=g(ir).gt(.01)?p.floor(ir,2):"0.01",Nt=p.floor(R,y,m),rc=_.toContQuantity(t,P),nc=_.toCont(t,P),ic=_.toValueQuantity(t,P,Nt),oc=_.toValue(t,P,Nt),sc=_.toCoinQuantity(t,P,Nt),ac=_.toCoin(t,P,Nt),cc=A+Q,hi=N?"Cross":cc,uc=o&&((s=o.get(hi))===null||s===void 0?void 0:s.marginRatioRr)||0,lc=o&&((c=o.get(hi))===null||c===void 0?void 0:c.marginRatio)||"--";return Object.assign(Object.assign({},e),{type:u,posMode:O||"OneWay",posSide:Q||"Merged",displaySymbol:d,settleCurrency:f,sizeStr:cd(P,w),value:p.floor(E,b,v),valueWU:p.delimit(p.floor(E,b,v))+" "+f,avgEntryPrice:Nt,liquidationPrice:p.floor(I,y,m),liquidationDistance:p.floor(Math.abs(I-ae),y,m),riskLimit:p.floor(k,0,v),leverageEr:Zt,leverage:er,leverageX:`${er}${Bn.unit}`,marginEv:V,margin:$,marginWU:oe+" "+t.settleCurrency,marginFiat:ht,marginFiatWU:pr(t,i,ht),markPriceEp:ae,markPrice:r?r.markPrice:0 .toFixed(y),realisedPnlEv:Ce,realisedPnl:_e,realisedPnlWU:_e+" "+f,realisedPnlFiat:It,realisedPnlFiatWU:pr(t,i,It),buyLeavesValue:p.floor(M,b,v),sellLeavesValue:p.floor(C,b,v),usedLimit:ud(e,b,v),unrealisedPnlEvByLastPrice:Z,unrealisedPnlByLastPrice:Gt,unrealisedPnlByLastPriceWU:Gt+" "+f,unrealisedPnlByLastPriceFiat:gt,unrealisedPnlByLastPriceFiatWU:pr(t,i,gt),roiByLastPrice:zi(Z,ee),unrealisedPnlEvByMarkPrice:Ye,unrealisedPnlByMarkPrice:Le,unrealisedPnlByMarkPriceWU:Le+" "+f,unrealisedPnlByMarkPriceFiat:Dt,unrealisedPnlByMarkPriceFiatWU:pr(t,i,Dt),roiByMarkPrice:zi(Ye,ee),maxRemovableEv:Kt,maxRemovable:Jt,maxRemovableWU:Jt+" "+f,actualLeverage:Kr,sizeByCont:rc,sizeByContWU:nc,sizeByValue:ic,sizeByValueWU:oc,sizeByCoin:sc,sizeByCoinWU:ac,marginRatio:lc,marginRatioRr:uc})}function cd(e,t){return e===0?"0":(t==="Sell"?"-":"")+p.delimit(e)}function ud(e,t,r){if(!e)return 0 .toFixed(t);const n=e.buyLeavesValueEv+(e.side==="Buy"?e.valueEv:0),i=e.sellLeavesValueEv+(e.side==="Sell"?e.valueEv:0);return p.floor(Math.max(n,i),t,r)}function Or(e,t,r){const{contractSide:n,contractSize:i,valueFactor:o,priceFactor:a}=r;return dp({side:e.side,contractSide:n,contractSize:i,qty:e.size,entryPriceEp:e.avgEntryPriceEp,exitPriceEp:t,factor:o,priceFactor:a})}function zi(e,t){return t===0?"0.00%":p.floor(Ze(e*100,t),2)+"%"}function ld(e,t){const{assignedPosBalanceEv:r,posCostEv:n,size:i}=e;if(i===0)return 0;const o=t>0?0:Math.abs(t),a=g(r).minus(n).minus(o);return a.gt(0)?Math.floor(Number(a)):0}function lr(e,t,r,n){if(!t)return"";const{contractSide:i,valueScale:o,isSupportHedge:a}=e,s=a?1e4:1,c=g(r).times(s).div(t.priceEp);if(i>0){const d=p.floor(c,Tt);return p.delimit(d)}const u=p.floor(g(c).times(n),Tt,o);return p.delimit(u)}function pr(e,t,r){if(!t)return"";const{fiat:n}=t;return e.settleCurrency==="USD"&&n==="USD"?"":r+" "+n}function pd(e,t){return e.leverageEr===0?Br.marginRateErToLeverageEr(e.initMarginReqEr,t,t):e.leverageEr}function On(e,t,r,n){if(!e)return 0;const{symbol:i}=e,o=r.get(i),{maintenanceMargin:a}=up(o,Object.assign(Object.assign({},e),{markPriceEp:n}),t);return a||0}function dd(e,t,r,n,i,o){if(!e&&!t||(e==null?void 0:e.size)<=0&&(t==null?void 0:t.size)<=0)return{mm:0,posValue:0,mmCost:0};const a=(e==null?void 0:e.size)||0,s=(t==null?void 0:t.size)||0,c=a>s?e:t,u=a>s?t:e,d=zs(c==null?void 0:c.symbol,i),f=c?On(c,r,n,d):0,b=u?On(u,r,n,d):0,y=g(f).minus(b),m=se(be((c==null?void 0:c.size)||0,d),be((u==null?void 0:u.size)||0,d)),v=Vs(c.posSide==="Long",m,y,o);return{mm:y,posValue:m,mmCost:W(v,y)}}function Wi(e,t,r,n,i){if(!e||e.size<=0)return{mm:0,posValue:0,mmCost:0};const o=zs(e.symbol,n),a=On(e,t,r,o),s=be(e.size,o),c=Vs(e.side==="Buy",s,a,i);return{mm:a,posValue:s,mmCost:W(c,a)}}function $i(e,t,r){const n=t.gt(0)&&g(r).gt(0)?t.div(r):g(999),i=n.gt(999)?999:Number(n),o=e?p.floor(i,2,-2)+"%":"--";return{marginRatioRr:i,marginRatio:o}}function Vs(e,t,r,n){return e?g(t).minus(r).times(n):g(t).plus(r).times(n)}function zs(e,t){const r=t.get(e);return r?r.markPriceEp:0}const Ws=B([Fs,ri,le,De,rt]).pipe(l(([e,t,r,n,i])=>e.toArray().map(o=>$s(o,t,r,n,i))));function fd(e){return e.reduce((t,r)=>t+r.marginEv,0)}function Hi(e){return e.reduce((t,r)=>t+r.unrealisedPnlEvByMarkPrice,0)}function yd(e){return e.filter(t=>t.isCross&&t.unrealisedPnlEvByMarkPrice<0).reduce((t,r)=>t+r.unrealisedPnlEvByMarkPrice,0)}function bd(e){return e.reduce((t,r)=>t+r.orderCostEv,0)}function $s(e,t,r,n,i){const{currency:o,accountBalanceEv:a,totalUsedBalanceEv:s,bonusBalanceEv:c,isolatedTotalBalanceEv:u=0}=e,d=n.filter(ae=>ae.settleCurrency===o),f=t.filter(ae=>d.some(pe=>pe.symbol===ae.symbol)),b=t.filter(({isCross:ae,size:pe,symbol:Ce,currency:_e})=>["USDT","MUSDT"].includes(_e)&&ae&&pe>0&&d.some(Z=>Z.symbol===Ce)),y=Hi(f),{valueScale:m,valuePrecision:v,name:E}=r.get(o),S=/^USD\w$/.test(o)?4:v,x=["USDC","USDT","MUSDT","PT"].indexOf(o)>-1?0:m,T=i?Hi(b):0,P=T>0?.99:1.01,w=g(T).times(P),O=a-u,Q=g(O).plus(T).minus(s),R=g(O).plus(w).minus(s),I=Q.gte(0)?Number(Q):0,k=R.gte(0)?Number(R):0,M=p.floor(I,S,x),C=p.floor(I,2,x),N=p.floor(I,4,x),A=fd(f),q=bd(f),U=yd(f),V=a+U,$=Number(a)+Number(y),Y=g(k).minus(c),ee=Y.gte(0)?Number(Y):0,oe=p.floor(ee,v,x),me=p.floor(ee,2,x);return{name:E,currency:o,accountBalanceEv:a,accountBalance:p.floor(a,v,x),totalUsedBalanceEv:s,totalUsedBalance:p.floor(s,v,x),availableBalanceEv:I,availableBalance:M,availableBalanceWU:M+" "+o,availableBalance2:C,availableBalance2WU:C+" "+o,availableBalance4:N,availableBalance4WU:N+" "+o,availableTransferBalanceEv:ee,availableTransferBalance:oe,availableTransferBalanceWU:oe+" "+o,availableTransferBalance2WU:me+" "+o,bonusBalanceEv:c,bonusBalance:p.floor(c,v,x),positionMarginEv:A,positionMargin:p.floor(A,v,x),unrealisedPnlEv:y,unrealisedPnl:p.floor(y,v,x),equityEv:$,equity:p.floor($,v,x),marginBalanceEv:V,marginBalance:p.floor(V,v,x),orderMarginEv:q,orderMargin:p.floor(q,v,x)}}B([Te,rt,Ur]).pipe(h(([,e,t])=>e&&t.length>0)).subscribe(([,e,t])=>{j.next({method:"ras.subscribe",params:[t]})});const vd=re.pipe(h(e=>!!e.risk_units),we(Ne),h(([e,t])=>e.risk_units.filter(r=>r.userID!==t).length>0),l(([e])=>{var t;return{userId:(t=e==null?void 0:e.risk_units[0])===null||t===void 0?void 0:t.userID,data:Object.assign({},e)}})),md=B([vd,Ur]).pipe(h(([{userId:e},t])=>t.includes(e)),l(([{userId:e,data:t}])=>function(r){return r.set(e,qs(t.risk_units)),r}),H((e,t)=>t(e),new Map),G(new Map)),hd=B([Yn,Yo]).pipe(l(([e,t])=>{const r=function(n){return Array.from(new Set(t)).reduce((i,o)=>i.has(o)?i:i.set(o,{accountBalanceEv:0,accountID:0,bonusBalanceEv:0,currency:o,totalUsedBalanceEv:0,userID:0,tradeLevel:0,isolatedTotalBalanceEv:0}),n)};return n=>e.reduce((i,o)=>i.set(o,r(new Map)),n)})),gd=fe.pipe(l(()=>e=>(e.clear(),e)));function Hs(e,t){return function(r){const n=r.get(e)||new Map;return r.set(e,t(n)),r}}const Ed=is.pipe(h(e=>!!e.data.accounts),l(e=>{const t=function(r){return e.data.accounts.forEach(n=>r.set(n.currency,n)),r};return Hs(e.userId,t)})),Sd=os.pipe(h(e=>!!e.data.accounts)),Pd=B([Sd,rt,md]).pipe(l(([e,t,r])=>{const n=r.get(e.userId);return{accounts:As([e.data.accounts,t,n]),userId:e.userId}})),Td=Pd.pipe(l(e=>{const t=function(r){return e.accounts.forEach(n=>r.set(n.currency,n)),r};return Hs(e.userId,t)})),Xs=F(hd,Ed,Td,gd).pipe(H((e,t)=>t(e),new Map)),xd=is.pipe(h(e=>!!e.data.positions),l(e=>({userId:e.userId,data:e.data.positions}))),wd=os.pipe(h(e=>!!e.data.positions),l(e=>({userId:e.userId,data:ti(e.data.positions)})));function Ys(e,t){return function(r){const n=r.get(e)||new Map;return r.set(e,t(n)),r}}const Bd=Yn.pipe(l(e=>t=>(e.forEach(r=>{t.set(r,new Map)}),t))),Od=fe.pipe(l(()=>function(e){return e.clear(),e})),Rd=xd.pipe(l(e=>{const t=function(r){return e.data.forEach(n=>{r.set(n.symbol,Object.assign(Object.assign(Object.assign({},r.get(n.symbol)),n),Vr(n,r.get(n.symbol))))}),r};return Ys(e.userId,t)})),Cd=wd.pipe(l(e=>{const t=function(r){return e.data.forEach(n=>{const{symbol:i,posSide:o,posMode:a}=n,s=i+o;["Merged","Long","Short"].forEach(c=>{const u=i+c;r.has(u)&&r.set(u,Object.assign(Object.assign({},r.get(u)),{posMode:a}))}),r.set(s,Object.assign(Object.assign(Object.assign({},r.get(s)),n),Vr(n,r.get(s))))}),r};return Ys(e.userId,t)})),kd=F(Bd,Od,Rd,Cd).pipe(H((e,t)=>t(e),new Map)),Gs=B([Yn,He,kd,Qt,Xs,Us]).pipe(l(([e,t,r,n,i,o])=>e.reduce((a,s)=>a.set(s,js(t,r.get(s)||new Map,n,i.get(s),o,new Map,!1)),new Map)),ft()),Qd=Id(Gn);function Id(e){return e.pipe(Je(t=>Gs.pipe(l(r=>t.reduce((n,i)=>n.set(i,r.get(i)||[]),new Map)),ge(1e3))))}const Ks=B([Ur,Xs,Gs,le,De,rt]).pipe(ge(100),l(([e,t,r,n,i,o])=>e.reduce((a,s)=>a.set(s,(t.get(s)||new Map).toArray().map(c=>$s(c,r.get(s),n,i,o))),new Map))),Dd=Js(Gn),Md=Js(Zo);function Js(e){return e.pipe(Je(t=>Ks.pipe(l(r=>t.reduce((n,i)=>n.set(i,r.get(i)||[]),new Map)))))}const Nd=B([kt,Ar]).pipe(h(([e])=>!!e.accounts),l(([e,t])=>e.accounts.find(r=>r.currency===t.symbol)),h(Boolean),Wn(e=>{Qr("aop_pt_account",{content:e})}),l(e=>e.status===1),Ie(),G(!1));function _d(){Ws.pipe(l(e=>({type:"accounts",data:{accounts:e}}))).subscribe(e=>D.next(e)),Dd.pipe(l(e=>({type:"accounts-copy-trade",data:e})),ge(500)).subscribe(e=>D.next(e)),Md.pipe(l(e=>({type:"accounts-bot-trade",data:e})),ge(500)).subscribe(e=>D.next(e)),Nd.pipe(l(e=>({type:"contract-pt-discount-state",data:{state:e}}))).subscribe(e=>D.next(e))}const qd=Se.pipe(l(({symbol:e})=>({reset:!0,symbol:e,bids:[],asks:[]}))),Ad=Zn.pipe(ge(1e3),l(Ud),h(Boolean)),Fd=F(qd,Ad);function Ud({tradePair:e,bids:t,bidPriceEps:r,asks:n,askPriceEps:i}){if(!e)return null;const{symbol:o,pricePrecision:a,priceScale:s,type:c}=e,{baseQtyPrecision:u=0,baseQtyScale:d=0,quoteQtyScale:f=0}=e,b=c==="Spot"?f:s,y=Xi(t,r,a,b,u,d),m=Xi(n,i,a,b,u,d);return{reset:!1,symbol:o,bids:y,asks:m}}function Xi(e,t,r,n,i,o){return t.reduce((a,s)=>{const c={priceEp:s,price:p.floor(s,r,n),total:i===0?a.total:Number(p.floor(a.total,i,o))};return{total:a.total+e.get(s),items:[...a.items,c]}},{total:0,items:[]}).items}function Ld(){Fd.subscribe(e=>D.next({type:"depth",data:e}))}const Yi={convertToBar(e,t){const{pricePrecision:r}=t,n=jd(t),i=Number(e[2]),o=Number(e[3]),a=i>0?i:o;return{close:At(Number(e[6]),r,n),high:At(Number(e[4]),r,n),low:At(Number(e[5]),r,n),open:At(a,r,n),time:e[0]*1e3,volume:Vd(Number(e[7]),t)}}};function jd(e){return e.type==="Spot"?e.quoteQtyScale:e.priceScale}function At(e,t,r){return Number(p.floor(e,t,r))}function Vd(e,t){if(t.type==="Spot"){const{baseQtyPrecision:r,baseQtyScale:n}=t;return At(e,r,n)}return e}const zd=re.pipe(h(e=>!!e.kline||!!e.kline_p),l(Wd));function Wd(e){var{kline:t,kline_p:r}=e,n=Me(e,["kline","kline_p"]);let i=t||r;return n.symbol.startsWith(".")&&(i=i.map(o=>(o[7]=0,o))),Object.assign(Object.assign({},n),{kline:i})}class $d{constructor(t,r,n,i){this.symbol=t,this.resolution=r,this.period=n,this.tradeType=i,this.symbol=t,this.tradeType=i,this.resolution=r,this.period=n,this.window=this.resolution*6e4,this.snapshotLastTime=0,this.lastState={id:0,buffer:[]},this.init()}init(){const{symbol:t,resolution:r,period:n}=this;this.dispose$=new ue;const i=zd.pipe(h(s=>s.kline.length>0&&s.symbol===t&&s.kline[0][1]===n)),o=i.pipe(h(s=>s.type==="snapshot"),Wn(s=>this.snapshotLastTime=s.kline[0][0]),l(s=>s.kline.reverse()),Ke(1));this.snapshotData$=B([o,Se]).pipe(l(([s,c])=>s.map(u=>Yi.convertToBar(u,c))),l(s=>({type:"snapshot",symbol:t,resolution:r,bars:s})));const a=i.pipe(h(s=>s.type==="incremental"),l(s=>s.kline.filter(c=>c[0]>=this.snapshotLastTime).reverse()));this.incrementalData$=B([a,Se]).pipe(l(([s,c])=>s.map(u=>Yi.convertToBar(u,c))),l(s=>({type:"incremental",symbol:t,resolution:r,bars:s})))}start(){F(this.snapshotData$,this.incrementalData$).pipe(xu(this.dispose$)).subscribe(t=>D.next({type:"kline",data:t})),this.subscribeKline()}dispose(t){this.dispose$.next(),this.unsubscribeKline(t)}subscribeKline(){const t=this.tradeType==="PerpetualV2"?"kline_p1.subscribe":"kline_v1.subscribe";j.next({method:t,params:[this.symbol,this.period]})}unsubscribeKline(t){if(t)return;const r=this.tradeType==="PerpetualV2"?"kline_p1.unsubscribe":"kline_v1.unsubscribe";j.next({method:r,params:[this.symbol,this.period]})}}class Hd{constructor(){this.cache=new Map}subscribe(t,r,n){const i=t+"_"+r;if(this.cache.has(i))return;const o=r*60,a=new $d(t,r,o,n);this.cache.set(i,a),a.start()}unsubscribe(t,r,n){const i=t+"_"+r;this.cache.has(i)&&(this.cache.get(i).dispose(n),this.cache.delete(i))}clear(){this.cache.clear()}}const cn=new Hd,Xd=X.pipe(h(e=>e.type==="kline-subscribe")),Yd=X.pipe(h(e=>e.type==="kline-unsubscribe"));function Gd(){at.subscribe(()=>cn.clear()),Xd.subscribe(e=>cn.subscribe(e.symbol,e.resolution,e.tradeType)),Yd.subscribe(e=>cn.unsubscribe(e.symbol,e.resolution,e.shouldNotUnsubscribe))}const Zs=e=>{const t=new Date(e),r=t.getFullYear(),n=t.getMonth()+1,i=t.getDate();return[r,n,i].map(p.pad).join("-")},ni=e=>{const t=new Date(e),r=t.getHours(),n=t.getMinutes(),i=t.getSeconds();return[r,n,i].map(p.pad).join(":")},Kd=e=>{const t=new Date(e),r=t.getMonth()+1,n=t.getDate();return[r,n].map(p.pad).join("-")},Jd=e=>[Kd(e),ni(e)].join(" "),Zd=e=>[Zs(e),ni(e)].join(" "),ef=e=>{const t=new Date(e),r=t.getUTCFullYear(),n=t.getUTCMonth()+1,i=t.getUTCDate();return[r,n,i].map(p.pad).join("-")},tf=e=>{const t=new Date(e),r=t.getUTCHours(),n=t.getUTCMinutes(),i=t.getUTCSeconds();return[r,n,i].map(p.pad).join(":")},xe={formatDate:Zs,formatMonthDayTime:Jd,formatTime:ni,formatDateTime:Zd,formatUTCDate:ef,formatUTCTime:tf},rf=re.pipe(h(e=>!!e.trades||!!e.trades_p),l(e=>{const{trades_p:t,trades:r}=e,n=Me(e,["trades_p","trades"]);return Object.assign(Object.assign({},n),{trades:r||nf(t)})}));function nf(e){return e.map(([t,r,n,i])=>[t,r,Number(n),Number(i)])}const ii=af(Se,rf,Jn),of=200,sf=450;function af(e,t,r){const n=e.pipe(l(({symbol:o,type:a})=>({reset:!0,symbol:o,tradeType:a,trades:[]}))),i=e.pipe(Je(o=>df(o,t,r)));return F(n,i)}function cf([e,t,r,n],i,o,a,s,c,u){const d=bf(n,r,c,u),f=vf(n,r,c,u);return{time:xe.formatTime(e/1e6),buy:t==="Buy",sell:t==="Sell",priceEp:r,price:a(r),size:c.type==="Spot"?n:f,sizeStr:c.type==="Spot"?s(n):d,up:!1,down:!1,fa:i,fb:o}}function uf(e){const t=e.length;if(!(t<2))for(let r=t-1;r>0;r--){const n=e[r],i=e[r-1];i.up=i.priceEp>n.priceEp,i.down=i.priceEp<n.priceEp}}function lf(e,t){return t?e:e===2?1:2}function pf(e,t,r,n){e.forEach((i,o)=>{const a=r.get(o)||0,s=t.get(o),c=lf(s,sf>n-a);c!==s&&(t.set(o,c),r.set(o,n))})}function df(e,t,r){const n=new Map,i=new Map,o=t.pipe(Gi(e.symbol,"snapshot"),l(d=>function(){return d.trades})),a=t.pipe(Gi(e.symbol,"incremental"),l(d=>(pf(d.trades,n,i,Date.now()),function(f){return f?d.trades.concat(f):d.trades}))),s=F(o,a).pipe(H((d,f)=>f(d).slice(0,of),null)),c=ff(e),u=yf(e);return B([s,r]).pipe(l(([d,f])=>{const b=d.filter(y=>{var m;return((m=e.timeline)===null||m===void 0?void 0:m.length)>0?y[0]/1e6>((e==null?void 0:e.timeline[1])||0):!0}).map((y,m)=>{const v=n.get(m);return cf(y,v===1,v===2,c,u,e,f)});return uf(b),{reset:!1,symbol:e.symbol,tradeType:e.type,trades:b}}))}function ff(e){if(e.type==="Spot"){const{pricePrecision:t,quoteQtyScale:r}=e;return function(n){return p.floor(n,t,r)}}if(["Perpetual","PerpetualV2"].indexOf(e.type)>-1){const{pricePrecision:t,priceScale:r}=e;return function(n){return p.floor(n,t,r)}}return null}function yf(e){if(e.type==="Spot"){const{baseQtyPrecision:t,baseQtyScale:r}=e;return function(n){return p.abbreviateNumber(p.floor(n,t,r),t)}}return["Perpetual","PerpetualV2"].indexOf(e.type)>-1?function(t){return p.delimit(t)}:null}function Gi(e,t){return h(r=>r.symbol===e&&r.type===t)}function bf(e,t,r,n){const{contractSide:i,contractSize:o,valuePrecision:a,contractSizePrecision:s,qtyPrecision:c=0,priceFactor:u}=r;if(!o)return"0";if(n===te.Cont){const d=e>1e3?2:c;return p.abbreviateNumber(e,d)}if(n===te.Base){const d=ea(e,i,o,t,u);return p.abbreviateNumber(d,a)}if(n===te.Coin){const d=g(e).times(o),f=Number(d)>1e3?2:s;return p.abbreviateNumber(d,f)}return"0"}function vf(e,t,r,n){const{contractSide:i,contractSize:o,priceFactor:a}=r;return o?n===te.Cont?e:n===te.Base?ea(e,i,o,t,a):n===te.Coin?Number(g(e).times(o)):0:0}function ea(e,t,r,n,i){if(!r)return 0;const o=g(e).times(r);return Number(t>0?o.times(n).div(i):o.times(i).div(n))}const mf=B([He,ii.pipe(h(e=>["Perpetual","PerpetualV2"].indexOf(e.tradeType)>-1)),Qt]).pipe(l(hf),h(Boolean),ie(1));function hf([e,{symbol:t,trades:r},n]){const i=e.get(t);if(!i||!n.has(t))return null;const{pricePrecision:o,priceScale:a}=i,s=n.get(t),c=r.length>0?r[0].priceEp:s.closeEp,u=c>0?p.floor(c,o,a):"--",d=c!==0&&s.openEp!==0?c-s.openEp:0,f=c>0?p.floor(d,o,a):"--",b=gf(d,f),y=Ef(c,s.openEp),m=Sf(y);return Object.assign(Object.assign({},s),{closeEp:c,close:u,change24hEp:d,change24hStr:b,changePercent:y,changePercentStr:m})}function gf(e,t){return(e>0?"+":"")+t}function Ef(e,t){return e===0||t===0||e===t?0:(e-t)*100/t}function Sf(e){if(e===0)return"--%";const t=e>0?"+":"",r=p.floor(e,2);return t+r+"%"}function Pf(){at.subscribe(()=>{j.next({method:"perp_market24h_pack.subscribe",params:[]}),j.next({method:"perp_market24h_pack_p.subscribe",params:{}})}),Qt.subscribe(e=>D.next({type:"market24h-contract",data:e})),mf.subscribe(e=>D.next({type:"market24h-contract-realtime",data:e}))}const ta=B([ne,ye]).pipe(h(([e,t])=>e.has("."+t)),Ie((e,t)=>e[0].get("."+t)!==t[0].get("."+t))),Tf=ta.pipe(l(xf),ft()),zr=B([vt,ta]).pipe(l(wf),ft());function xf([e,t]){const r=e.get("."+t);return function(n,i,o){const a=i-Oe,s=e.get("."+o);if(!s)return"--"+t;const c=Number(g(n).times(s.priceEp).div(r.priceEp).div(s.priceFactor)),u=c<100?6:Tt;return p.delimit(p.floor(c,u,a))+" "+t}}function wf([e,[t,r]]){const n=t.get("."+r);return function(i,o,a=!1){const s=Bf(o,i,e,t,n.priceEp,a);return[p.delimit(s)+" "+r,s]}}function Bf(e,t,r,n,i,o=!1){const a=r.get(t);if(!a)return 0 .toFixed(Tt);const s=n.get("."+t);if(!s)return 0 .toFixed(Tt);const c=Of(e,s.priceEp,i),u=o?0:a.valueScale;return p.floor(c,Tt,u)}function Of(e,t,r){return g(e).times(t).div(r).toString()}const Rf=B([Hn,Is,Tf,ne]).pipe(ge(50),l(Cf),h(e=>e.length>0),ie(1));function Cf([e,t,r,n]){return t.map(i=>kf(e,i,r,n)).filter(Boolean)}function kf(e,t,r,n){const{symbol:i}=t,o=e.get(i);if(!o)return null;const{bidEp:a,askEp:s,lastEp:c,highEp:u,lowEp:d,openEp:f,indexEp:b,turnoverEv:y,volumeEv:m}=t,{type:v,displaySymbol:E,name:S,baseCurrency:x,quoteCurrency:T,displayBaseCurrency:P,pricePrecision:w,quoteQtyScale:O,quoteQtyPrecision:Q,status:R,baseQtyPrecision:I,baseQtyScale:k}=o,M=O,C=Nf(n,T,y),N=p.floor(C,Q,O),A=p.floor(m,I,k),q=If(c,f),U=c-f,V=p.floor(U,w,M);return R!=="Listed"?Mf(o):{type:v,symbol:i,status:R,displaySymbol:E,baseCurrency:x,bid1Ep:a,ask1Ep:s,openEp:f,open:p.floor(f,w,M),closeEp:c,close:p.floor(c,w,M),closeMoneyWU:r(c,M,T),highEp:u,high:p.floor(u,w,M),lowEp:d,low:p.floor(d,w,M),indexPriceEp:b,indexPrice:p.floor(b,w,M),turnoverEv:C,turnoverStr:p.abbreviateNumber(N),volume24hStr:p.abbreviateNumber(A),changePercent:q,changePercentStr:Df(q),change24hEp:U,change24hStr:Qf(U,V),name:S,displayBaseCurrency:P,klineData:[],quoteCurrency:T,combinationTurnoverEv:Number(N),volumeEv:m}}function Qf(e,t){return(e>0?"+":"")+t}function If(e,t){return e===0||t===0||e===t?0:(e-t)*100/t}function Df(e){if(e===0)return"0.00%";const t=e>0?"+":"",r=p.floor(e,2);return t+r+"%"}function Mf({type:e,symbol:t,status:r,displaySymbol:n,baseCurrency:i,name:o}){return{type:e,symbol:t,status:r,displaySymbol:n,baseCurrency:i,bid1Ep:0,ask1Ep:0,openEp:0,open:"--",closeEp:0,close:"--",closeMoneyWU:"--",highEp:0,high:"--",lowEp:0,low:"--",indexPriceEp:0,indexPrice:"--",turnoverEv:0,turnoverStr:"--",volume24hStr:"--",changePercent:0,changePercentStr:"--",change24hEp:0,change24hStr:"--",name:o,displayBaseCurrency:"",klineData:[],quoteCurrency:"USDT",combinationTurnoverEv:0,volumeEv:0}}function Nf(e,t,r){if(t==="TRY"){const n=e.get("."+t);return n?g(r).times(n.priceEp).div(n.priceFactor).toNumber():0}return r}const ra=Rf.pipe(dt(),H((e,t)=>e.set(t.symbol,t),new Map),ge(100),ie(1)),_f=ii.pipe(h(e=>e.tradeType==="Spot")),qf=B([Hn,_f,ra]).pipe(l(Af),h(Boolean));function Af([e,{symbol:t,trades:r},n]){const i=e.get(t);if(!i||!n.has(t))return null;const{pricePrecision:o,quoteQtyScale:a}=i,s=n.get(t),c=r.length>0?r[0].priceEp:s.closeEp,u=p.floor(c,o,a),d=c!==0&&s.openEp!==0?c-s.openEp:0,f=p.floor(d,o,a),b=Ff(d,f),y=Uf(c,s.openEp),m=Lf(s.changePercent);return Object.assign(Object.assign({},s),{closeEp:c,close:u,change24hEp:d,change24hStr:b,changePercent:y,changePercentStr:m})}function Ff(e,t){return(e>0?"+":"")+t}function Uf(e,t){return e===0||t===0||e===t?0:(e-t)*100/t}function Lf(e){if(e===0)return"0.00%";const t=e>0?"+":"",r=p.floor(e,2);return t+r+"%"}function jf(){at.subscribe(()=>j.next({method:"spot_market24h_pack.subscribe",params:[]})),ra.subscribe(e=>D.next({type:"market24h-spot",data:e})),qf.subscribe(e=>D.next({type:"market24h-spot-realtime",data:e}))}const J={isConditionalOrder(e){return["Stop","StopLimit","LimitIfTouched","MarketIfTouched","BoSlLimit","BoSlMarket"].indexOf(e)>-1},isLimitOrder(e){return["Bracket","StopLimit","LimitIfTouched","BoTpLimit","BoSlLimit"].indexOf(e)>-1},isMarketOrder(e){return["Market","Stop","MarketIfTouched","BoSlMarket"].indexOf(e)>-1},isBracketOrders(e){return["Bracket","BoTpLimit","BoSlLimit","BoSlMarket"].indexOf(e)>-1},isFinalOrder(e){return["Deactivated","Filled","Canceled","Rejected"].indexOf(e)>-1},isActivation(e,t){return t==="TrailingTakeProfitPeg"&&e==="Inactive"},formatOrderQty(e){return e>0?p.delimit(e):"PositionSize"}},na=new Re(te.Coin),ia=new Re(te.Coin);X.pipe(h(e=>e.type==="qty-before-v2-change"),l(e=>e.qtyType)).subscribe(e=>na.next(e));X.pipe(h(e=>e.type==="qty-v2-change"),l(e=>e.qtyType)).subscribe(e=>ia.next(e));const Vf=F(ds,bs).pipe(l(({orders:{open:e,closed:t}})=>[].concat(t,e)),dt()),zf=F(ps,ys).pipe(l(({orders:{open:e,closed:t}})=>[].concat(t,e))),Wf=zf.pipe(l(e=>function(t){return t.clear(),e.forEach(r=>t.set(r.orderID,r)),t})),oa=new ue,sa=new Re(new Map),aa=new ue,$f=aa.asObservable();F(Wf,oa).pipe(H((e,t)=>t(e),new Map)).subscribe(e=>sa.next(e));Vf.pipe(we(De)).subscribe(([e,t])=>{const r=t.find(o=>o.symbol===e.symbol);if(!r)return;const n=sa.getValue(),i=Hf(e,r,n);i&&aa.next(i),oa.next(Xf(e))});function _t(e,t,r){const n=(e.type==="Perpetual"?na:ia).getValue(),i={[te.Cont]:()=>_.toCont(e,t),[te.Base]:()=>_.toValue(e,t,r),[te.Coin]:()=>_.toCoin(e,t,r)};return i[n]&&i[n]()}function Hf(e,t,r){const{pricePrecision:n,priceScale:i,pairName:o,settleCurrency:a}=t,{side:s,orderQty:c,priceEp:u,stopPxEp:d,leavesQty:f,ordStatus:b,code:y,action:m,pegPriceType:v="Unspecified",curPosSide:E,stopDirection:S,clOrdID:x,ordType:T}=e,P=J.isMarketOrder(T),w=J.isConditionalOrder(T),O=P?"Market":p.floor(u,n,i),Q=p.floor(P?d:u,n,i),R=s,I=c,k=o,M=a;if(x.startsWith("scaled-")&&T==="Limit"&&m!=="Replace")return null;if(y!==0)return{ID:"OrderError",type:["Canceled","Deactivated"].indexOf(b)>-1?"info":"error",Code:y};if(m==="Replace")return Yf(e,t,r);if(c===0&&(m==="Replace"||m==="New")&&b==="Untriggered"){if(v==="Unspecified"){if(S==="Rising")return{ID:E==="Buy"?"TakeProfileAccepted":"StopLossAccepted",Price:p.floor(e.stopPxEp,n,i)};if(S==="Falling")return{ID:E==="Buy"?"StopLossAccepted":"TakeProfileAccepted",Price:p.floor(e.stopPxEp,n,i)}}if(v==="TrailingStopPeg")return{ID:"TrailingStopAccepted",Price:p.floor(e.stopPxEp,n,i),TrailValue:p.floor(Math.abs(e.pegOffsetValueEp),n,i)};if(v==="TrailingTakeProfitPeg")return{ID:"TrailingProfitAccepted",Price:p.floor(e.stopPxEp-e.pegOffsetValueEp,n,i),TrailValue:p.floor(Math.abs(e.pegOffsetValueEp),n,i)}}if(b==="Deactivated")return{ID:"OrderCanceled"};if(b==="PartiallyFilled"){const C=p.floor(e.execPriceEp,n,i);return{ID:"OrderPartiallyFilled",Symbol:k,SettleCurrency:M,Side:R,OrderQty:_t(t,e.execQty,C),Price:C,LeavesQty:f}}if(b==="Filled"){const C=p.floor(e.priceEp,n,i);return{ID:"OrderFilled",Symbol:k,SettleCurrency:M,Side:R,OrderQty:_t(t,I,C),Price:C}}if(m==="New"){if(w&&b==="Untriggered")return{ID:"ConditionalOrderSubmitted",Symbol:k,SettleCurrency:M,Side:R,OrderQty:_t(t,I,Q),Price:O,TriggerPrice:p.floor(e.stopPxEp,n,i)};if(w&&b==="New")return{ID:"ConditionalOrderTriggered",Symbol:k,SettleCurrency:M,Side:R,OrderQty:_t(t,I,Q),Price:O,StopDirection:S==="Rising"?"profit":"stop"};if(!w&&b==="New")return{ID:"OrderSubmitted",Symbol:k,SettleCurrency:M,Side:R,OrderQty:_t(t,I,Q),Price:O}}return b==="Canceled"?{ID:"OrderCanceled"}:null}function Xf(e){return J.isFinalOrder(e.ordStatus)&&e.execStatus!=="ReplaceToCanceled"?function(t){return t.delete(e.orderID,e),t}:function(t){return t.set(e.orderID,e),t}}function Yf(e,t,r){const n=r.get(e.orderID);if(!n)return null;const{pairName:i,settleCurrency:o}=t,{orderQty:a,priceEp:s,stopPxEp:c,tpTimeInForce:u,tpTrigger:d,tpPxRp:f,takeProfitRp:b,slTimeInForce:y,slTrigger:m,slPxRp:v,stopLossRp:E}=e;return n.priceEp!==s||n.orderQty!==a||n.stopPxEp!==c||n.tpTimeInForce!==u||n.tpTrigger!==d||n.tpPxRp!==f||n.takeProfitRp!==b||n.slTimeInForce!==y||n.slTrigger!==m||n.slPxRp!==v||n.stopLossRp!==E?{ID:"OrderModify",Symbol:i,SettleCurrency:o}:null}function Gf(){$f.subscribe(e=>D.next({type:"notification-contract-order",data:e}))}const Kf=F(Ds,Ms),Jf=kt.pipe(h(e=>e.type==="incremental"),l(e=>{const t=oy(e.events),r=ti(e.positions);return Object.assign(Object.assign({},e),{events:t,positions:r})})),Zf=F(zt.pipe(h(e=>e.type==="incremental")),Jf),ey=Zf.pipe(l(({events:e,positions:t})=>t.length<1?null:t.map(r=>{const n=e.find(({symbol:i,posSide:o})=>r.symbol===i&&r.posSide===o);return Object.assign(Object.assign({},r),{event:n})})),h(Boolean),dt()),ty=Kf.pipe(l(e=>function(t){return e.forEach(r=>{const{symbol:n,posSide:i}=r,o=n+(i||"");t&&t.has(o)?t.set(o,Object.assign(Object.assign({},r),t.get(o))):t.set(o,r)}),t})),ca=new ue,ua=new Re(new Map),la=new ue,ry=la.asObservable();F(ty,ca).pipe(H((e,t)=>t(e),new Map)).subscribe(e=>ua.next(e));ey.pipe(we(De)).subscribe(([e,t])=>{const r=t.find(o=>o.symbol===e.symbol);if(!r)return;const n=ua.getValue(),i=ny(e,r,n);i&&la.next(i),ca.next(iy(e))});function ny(e,t,r){const{event:n}=e;if(!n)return null;const{symbolV2:i,settleCurrency:o,valuePrecision:a,valueScale:s,ratioScale:c}=t,u=i,d=o;if(n.code!==0)return{ID:"Error",Code:n.code};if(n.action==="SetLeverage"){const{symbol:f,posSide:b}=e,y=f+(b||""),m=r.get(y);return m.leverageEr===e.leverageEr?null:{ID:"LeverageModified",Symbol:u,SettleCurrency:d,OldIsIsolated:m.leverageEr>0,OldLeverage:Ki(m.leverageEr,c),Leverage:Ki(e.leverageEr,c),IsIsolated:e.leverageEr>0}}if(n.action==="AssignPosBalance"){const{execValueEv:f}=n;return{ID:f>0?"MarginAdded":"MarginRemoved",Symbol:u,SettleCurrency:d,Amount:p.floor(Math.abs(f),a,s),Currency:o}}return n.action==="SetRiskLimit"?{ID:"RiskLimitModified",Symbol:u,SettleCurrency:d,RiskLimit:p.floor(e.riskLimitEv,0,s)}:n.action==="LiqRequest"?{ID:"PositionLiquidated",Symbol:u,SettleCurrency:d,Side:n.side==="Buy"?"Sell":"Buy",Size:n.orderQty}:n.action==="ADLResult"?{ID:"AutoDeleveraged",Symbol:u,SettleCurrency:d,Side:e.side,Size:e.size}:null}function iy(e){return function(t){const{symbol:r,posSide:n}=e,i=r+(n||"");return t&&t.has(i)?t.set(i,Object.assign(Object.assign({},t.get(i)),e)):t.set(i,e),t}}function Ki(e,t){return p.trimEnd0(p.ceil(Math.abs(e),2,t))}function oy(e){return e.map(t=>Object.assign(Object.assign({},t),{execValueEv:Number(t.execValueRv)}))}function sy(){ry.subscribe(e=>D.next({type:"notification-position",data:e}))}const L={isConditionalOrder(e){return["Stop","StopLimit","LimitIfTouched","MarketIfTouched"].indexOf(e.ordType)>-1},isMarketOrder(e){return["Market","Stop","MarketIfTouched"].indexOf(e.ordType)>-1},isLiqTradeOrder(e){return e.ordType==="LiqTrade"},calcValue({qtyType:e,priceEp:t,baseQtyEv:r,quoteQtyEv:n,baseQtyScale:i,quoteQtyScale:o,baseQtyPrecision:a,quoteQtyPrecision:s}){const c=this.getByQtyType(e,a,s,!0);if(t<=0)return this.formatDelimit(0,c);const u=g(t).div(g(10).pow(o));if(e==="ByBase"){const d=g(10).pow(i);return this.formatDelimit(g(r).div(d).times(u),c)}if(e==="ByQuote"){const d=g(10).pow(o);return this.formatDelimit(g(n).div(d).div(u),c)}return this.formatDelimit(0,c)},calcValueWU({qtyType:e,priceEp:t,baseQtyEv:r,quoteQtyEv:n,baseQtyScale:i,quoteQtyScale:o,baseQtyPrecision:a,quoteQtyPrecision:s,displayBaseCurrency:c,quoteCurrency:u}){const d=this.calcValue({qtyType:e,priceEp:t,baseQtyEv:r,quoteQtyEv:n,baseQtyScale:i,quoteQtyScale:o,baseQtyPrecision:a,quoteQtyPrecision:s});return e==="ByBase"?[d,u].join(" "):e==="ByQuote"?[d,c].join(" "):"-"},calcQty(e,t,r){return e==="ByBase"?p.delimit(t):e==="ByQuote"?p.delimit(r):""},calcQtyWU(e,t,r,n,i){return e==="ByBase"?p.delimit(t)+" "+r:e==="ByQuote"?p.delimit(n)+" "+i:""},getByQtyType(e,t,r,n=!1){if(e==="ByBase")return n?r:t;if(e==="ByQuote")return n?t:r},joinWU(e,t){return!e||!t?"-":[e,t].join(" ")},formatDelimit(e,t){return p.delimit(p.floor(e,t))},isFinalOrder(e){return["Deactivated","Filled","Canceled","Rejected"].indexOf(e)>-1}};function Wt(e,t,r,n){return e?"Market":p.floor(t,r,n)}function pa(e,t,r=!1){if(e.bizError!==0)return{ID:"OrderError",Code:e.bizError};const{side:n,priceEp:i,stopPxEp:o,qtyType:a,baseQtyEv:s,quoteQtyEv:c,leavesBaseQtyEv:u,leavesQuoteQtyEv:d,ordStatus:f,action:b}=e,y=t.find(M=>M.symbol===e.symbol);if(!y)return null;const{pricePrecision:m,baseCurrency:v,quoteCurrency:E,baseQtyPrecision:S,quoteQtyPrecision:x}=y,T=r?0:y.quoteQtyScale,P=r?0:y.baseQtyScale,w=L.isLiqTradeOrder(e),O=L.isMarketOrder(e),Q=p.floor(s,S,P),R=p.floor(c,x,T),I=Wt(O||w,i,m,T),k=fa({QtyType:a,Price:I,Side:n,Coin:v},{qtyType:a,baseQty:Q,baseCurrency:v,quoteQty:R,quoteCurrency:E});if(b==="Replace")return k("OrderModify");if(f==="Untriggered")return k("ConditionalOrderSubmitted",{TriggerPrice:p.floor(o,m,T)});if(f==="Deactivated")return k("OrderCanceled");if(f==="New")return k("ConditionalOrderTriggered");if(f==="PartiallyFilled"){const M=p.floor(u,S,P),C=p.floor(se(s,u),S,P),N=p.floor(d,S,P),A=p.floor(se(c,d),S,P),q=L.calcQtyWU(a,C,v,A,E),U=L.calcQtyWU(a,M,v,N,E);return k("OrderPartiallyFilled",{Amount:q,RemainingAmount:U})}return f==="Filled"?k("OrderFilled"):f==="Canceled"?k("OrderCanceled"):null}function da(e,t,r=!1){if(e.bizError!==0)return{ID:"OrderError",Code:e.bizError};const{side:n,priceEp:i,qtyType:o,baseQtyEv:a,quoteQtyEv:s,leavesBaseQtyEv:c,leavesQuoteQtyEv:u,action:d,ordStatus:f}=e,b=t.find(k=>k.symbol===e.symbol);if(!b)return null;const{pricePrecision:y,baseCurrency:m,quoteCurrency:v,baseQtyPrecision:E,quoteQtyPrecision:S}=b,x=r?0:b.quoteQtyScale,T=r?0:b.baseQtyScale,P=L.isLiqTradeOrder(e),w=L.isMarketOrder(e),O=p.floor(a,E,T),Q=p.floor(s,S,x),R=Wt(w||P,i,y,x),I=fa({QtyType:o,Price:R,Side:n,Coin:m},{qtyType:o,baseQty:O,baseCurrency:m,quoteQty:Q,quoteCurrency:v});if(d==="Replace")return I("OrderModify");if(f==="New")return I("OrderSubmitted");if(f==="PartiallyFilled"){const k=p.floor(c,E,T),M=p.floor(se(a,c),E,T),C=p.floor(u,S,x),N=p.floor(se(s,u),S,x),A=L.calcQtyWU(o,M,m,N,v),q=L.calcQtyWU(o,k,m,C,v);return I("OrderPartiallyFilled",{Amount:A,RemainingAmount:q})}return f==="Filled"?I("OrderFilled"):f==="Canceled"?I("OrderCanceled"):null}function fa({QtyType:e,Price:t,Side:r,Coin:n},{qtyType:i,baseQty:o,baseCurrency:a,quoteQty:s,quoteCurrency:c}){return function(u,d={}){return Object.assign(Object.assign({},d),{ID:u,QtyType:e,Price:t,Side:r,Coin:n,Amount:i==="ByBase"?o+" "+a:s+" "+c})}}const ay=mt.pipe(l(({open:e,closed:t})=>[].concat(e,t)),dt(),h(e=>e.execStatus!=="ReplaceToCanceled")),[cy,uy]=Io(ay,e=>L.isConditionalOrder(e)),ly=B([cy,Ue]).pipe(l(([e,t])=>pa(e,t)),h(Boolean)),py=B([uy,Ue]).pipe(l(([e,t])=>da(e,t)),h(Boolean)),dy=F(ly,py).pipe(h(e=>!!e));function fy(){dy.subscribe(e=>D.next({type:"notification-spot-order",data:e}))}const ya=fe.pipe(l(()=>e=>(e.clear(),e))),ba=X.pipe(h(e=>e.type==="order-active-remove"),l(e=>t=>(t.delete(e.orderID),t))),va=Lr.pipe(l(({orders:{open:e}})=>e)),yy=ga(va,!1),by=ga(va,!0),ma=nt.pipe(l(({orders:{open:e,closed:t}})=>[...t,...e])),vy=Ea(ma,!1),my=Ea(ma,!0),ha=nt.pipe(l(({orders:{closed:e}})=>e.filter(t=>t.execStatus!=="ReplaceToCanceled"))),hy=Py(ha),gy=Ty(ha),Ey=F(yy,vy,hy,ya,ba).pipe(H((e,t)=>t(e),new Map)),Sy=F(by,my,gy,ya,ba).pipe(H((e,t)=>t(e),new Map));function oi(e,t,r){return["New","Replace","Cancel"].indexOf(e.action)>-1&&["ReplaceRejected","CancelRejected"].indexOf(e.execStatus)<0?J.isBracketOrders(e.ordType)?r:t==="snapshot"?["New","PartiallyFilled"].indexOf(e.ordStatus)>-1:t==="incremental"?["New","PartiallyFilled","Filled","Canceled"].indexOf(e.ordStatus)>-1:!1:!1}function ga(e,t){return e.pipe(l(r=>(t?Cy(r):r).filter(n=>oi(n,"snapshot",t))),h(r=>r.length>0),l(xy))}function Ea(e,t){return e.pipe(l(r=>r.filter(n=>oi(n,"incremental",t))),h(r=>r.length>0),l(wy))}function Py(e){return e.pipe(l(t=>t.filter(r=>oi(r,"incremental",!1)&&J.isFinalOrder(r.ordStatus))),h(t=>t.length>0),l(By),Ot(5e3))}function Ty(e){return e.pipe(l(t=>t.filter(r=>J.isBracketOrders(r.ordType)&&J.isFinalOrder(r.ordStatus))),h(t=>t.length>0),l(Oy),Ot(5e3))}function xy(e){return function(t){return e.forEach(r=>t.set(r.orderID,r)),t}}function wy(e){return function(t){return e.forEach(r=>t.set(r.orderID,r)),t}}function By(e){return function(t){return e.forEach(r=>t.delete(r.orderID)),t}}function Oy(e){return function(t){const r=t.toArray();return e.forEach(n=>{const i=Ry(r,n);if(i&&J.isFinalOrder(i.ordStatus)){const{tpOrder:o,slOrder:a}=Sa(r,i);!o&&!a&&t.delete(i.orderID),o&&a&&J.isFinalOrder(o.ordStatus)&&J.isFinalOrder(a.ordStatus)&&(t.delete(i.orderID),t.delete(o.orderID),t.delete(a.orderID))}}),t}}function Ry(e,t){if(t.ordType==="Bracket")return t;const r=t.clOrdID.slice(0,-3);return e.find(n=>n.orderID===r)}function Cy(e){const t=e.filter(n=>n.ordType==="Bracket"),r=new Set;return t.forEach(n=>{const{tpOrder:i,slOrder:o}=Sa(e,n);if(i||console.log(`BO has no TP: orderID: ${n.orderID}, priceEp: ${n.priceEp}, orderQty: ${n.orderQty}, ordStatus: ${n.ordStatus}`),o||console.log(`BO has no SL: orderID: ${n.orderID}, priceEp: ${n.priceEp}, orderQty: ${n.orderQty}, ordStatus: ${n.ordStatus}`),!i||!o){r.add(n.orderID),i&&r.add(i.orderID),o&&r.add(o.orderID);return}J.isFinalOrder(n.ordStatus)&&i&&J.isFinalOrder(i.ordStatus)&&o&&J.isFinalOrder(o.ordStatus)&&(r.add(n.orderID),r.add(i.orderID),r.add(o.orderID))}),e.filter(n=>!r.has(n.orderID))}function Sa(e,t){return{tpOrder:e.find(r=>r.clOrdID===t.orderID+"_TP"),slOrder:e.find(r=>r.clOrdID===t.orderID+"_SL")}}const ky=B([Ey,He]).pipe(l(([e,t])=>e.toObject(r=>hr(r,t))),G({})),Qy=B([Sy,He]).pipe(l(([e,t])=>_y(e,t).toObject("orderID")),G({})),Iy=B([ky,Qy]).pipe(l(([e,t])=>Object.values(Object.assign({},e,t))));function Dy(e,t,r){return J.isMarketOrder(e.ordType)?"Market":e.priceEp===0?"-":p.floor(e.priceEp,t,r)}function My(e,t,r,n,i){return e.cumValueEv===0||e.cumQty===0?"-":p.floor(Math.pow(e.cumValueEv/(e.cumQty*r*n),t),i)}function Ny(e,t,r,n){return J.isConditionalOrder(e)?t===0?"-":p.floor(t,r,n):"-"}function hr(e,t,r){const n=t.get(e.symbol),{displaySymbol:i,settleCurrency:o,contractSide:a,contractSize:s,valuePrecision:c,valueFactor:u,pricePrecision:d,priceFactor:f,priceScale:b}=n,{orderID:y,clOrdID:m,ordType:v,ordStatus:E,code:S,symbol:x,side:T,orderQty:P,cumQty:w,leavesQty:O,priceEp:Q,stopPxEp:R,takeProfitEp:I,stopLossEp:k,tpTrigger:M,slTrigger:C,execInst:N,actionTimeNs:A=0,timeInForce:q="",curPosTerm:U,posSide:V,tpPxRp:$,slPxRp:Y,slTimeInForce:ee,tpTimeInForce:oe,displayQty:me}=e,ae=fp(a,s,f,c,P,Q),pe=Math.floor(A/1e6),Ce=J.formatOrderQty(P),_e=Dy(e,d,b),Z=r||p.floor(Os(e,v),d,b);return{orderID:y,clOrdID:m,ordType:v,ordStatus:E,code:S,symbol:x,displaySymbol:i,side:T,displayQty:me,orderQty:Number(P),orderQtyByCont:_.toCont(n,P),orderQtyByValue:_.toValue(n,P,Z),orderQtyByCoin:_.toCoin(n,P,Z),orderQtyStr:Ce,cumQty:w,cumQtyByCont:_.toCont(n,w),cumQtyByValue:_.toValue(n,w,Z),cumQtyByCoin:_.toCoin(n,w,Z),leavesQty:O,leavesQtyByCont:_.toCont(n,O),leavesQtyByValue:_.toValue(n,O,Z),leavesQtyByCoin:_.toCoin(n,O,Z),priceEp:Number(Q),price:_e,stopPxEp:R,stopPx:Ny(v,R,d,b),fillPrice:My(e,a,u,s,d),value:ae,valueWU:ae+" "+o,takeProfitEp:I,takeProfitPrice:p.floor(I,d,b),stopLossEp:k,stopLossPrice:p.floor(k,d,b),tpTrigger:M,slTrigger:C,execInst:N,actionTimestamp:pe,actionTime:xe.formatDateTime(pe),actionMonthDayTime:xe.formatMonthDayTime(pe),timeInForce:q,removable:J.isFinalOrder(E),curPosTerm:U,posSide:V,tpPxRp:$,slPxRp:Y,slTimeInForce:ee,tpTimeInForce:oe,icebergOrderQtyByCont:_.toCont(n,me??0),icebergOrderQtyByValue:_.toValue(n,me??0,Z),icebergOrderQtyByCoin:_.toCoin(n,me??0,Z)}}function _y(e,t){const r=e.toArray();return r.filter(n=>n.ordType==="Bracket").map(n=>{const i=hr(n,t),{tpOrder:o,slOrder:a}=qy(r,i);return o&&a&&(i.tpOrder=hr(o,t,i.price),i.slOrder=hr(a,t,i.price),i.removable=J.isFinalOrder(i.ordStatus)&&J.isFinalOrder(o.ordStatus)&&J.isFinalOrder(a.ordStatus)),i})}function qy(e,t){return{tpOrder:e.find(r=>r.clOrdID===t.orderID+"_TP"),slOrder:e.find(r=>r.clOrdID===t.orderID+"_SL")}}function Ay(){Iy.pipe(l(e=>({type:"contract-orders-active",data:{orders:e}}))).subscribe(e=>D.next(e))}const Fy=fe.pipe(l(()=>e=>(e.clear(),e))),Uy=X.pipe(h(e=>e.type==="order-condition-remove"),l(e=>t=>(t.delete(e.orderID),t))),Ly=Lr.pipe(l(({orders:{open:e}})=>e)),jy=Xy(Ly),Vy=nt.pipe(l(({orders:{open:e,closed:t}})=>[...t,...e])),zy=Yy(Vy),Wy=nt.pipe(l(({orders:{closed:e}})=>e)),$y=Gy(Wy),Hy=F(jy,zy,$y,Fy,Uy).pipe(H((e,t)=>t(e),new Map));function Xy(e){return e.pipe(l(t=>t.filter(r=>si(r,"snapshot"))),h(t=>t.length>0),l(Ky))}function Yy(e){return e.pipe(l(t=>t.filter(r=>si(r,"incremental"))),h(t=>t.length>0),l(Jy))}function Gy(e){return e.pipe(l(t=>t.filter(r=>si(r,"incremental")&&J.isFinalOrder(r.ordStatus))),h(t=>t.length>0),l(Zy),Ot(5e3))}function Ky(e){return function(t){return e.forEach(r=>t.set(r.orderID,r)),t}}function Jy(e){return function(t){e.forEach(r=>t.set(r.orderID,r));for(let r of t.values())r.ordStatus==="Rejected"&&t.delete(r.orderID);return t}}function Zy(e){return function(t){return e.forEach(r=>t.delete(r.orderID)),t}}function si(e,t){return!(["New","Replace","Cancel"].indexOf(e.action)>-1&&["ReplaceRejected","CancelRejected"].indexOf(e.execStatus)<0)||J.isBracketOrders(e.ordType)||!J.isConditionalOrder(e.ordType)?!1:t==="snapshot"?["New","PartiallyFilled","Untriggered"].indexOf(e.ordStatus)>-1:t==="incremental"?["New","PartiallyFilled","Untriggered","Filled","Deactivated","Canceled","Rejected"].indexOf(e.ordStatus)>-1:!1}const Pa=B([Hy,De]).pipe(l(([e,t])=>e.toArray(r=>ib(r,t)).filter(Boolean)));function eb(e,t){if(t==="TrailingTakeProfitPeg"){if(e==="Rising")return"";if(e==="Falling")return""}return e==="Rising"?"":e==="Falling"?"":""}function tb(e){return e==="ByLastPrice"||e==="ByLastPriceLimit"?"LP":e==="ByMarkPrice"||e==="ByMarkPriceLimit"?"MP":""}function rb(e,t){return t==="TrailingTakeProfitPeg"&&e==="Untriggered"?"Inactive":e}function nb(e,t,r){return["TrailingTakeProfitPeg","TrailingTakeProfitByProportionPeg"].includes(e)?t-r:0}function ib(e,t){const r=t.find(oe=>oe.symbol===e.symbol);if(!r)return null;const{displaySymbol:n,pricePrecision:i,priceScale:o}=r,{orderID:a,clOrdID:s,ordType:c,ordStatus:u,symbol:d,side:f,orderQty:b,priceEp:y,trigger:m,stopPxEp:v,actionTimeNs:E,stopDirection:S,timeInForce:x,pegOffsetValueEp:T,pegOffsetProportionEr:P,pegPriceType:w,takeProfitEp:O,stopLossEp:Q,tpTrigger:R,slTrigger:I,curPosTerm:k,posSide:M,actionBy:C,displayQty:N}=e,A=Math.floor(E/1e6),q=nb(w,v,T),U=J.formatOrderQty(b),V=p.floor(y,i,o),$=p.floor(Os(e,c),i,o),Y=r.type==="PerpetualV2",ee=p.floor(Math.abs(P),2,Y?-2:6)+"%";return{orderID:a,clOrdID:s,ordType:c,ordStatus:rb(u,w),displaySymbol:n,symbol:d,side:f,orderQty:Number(b),orderQtyByCont:_.toCont(r,b),orderQtyByValue:_.toValue(r,b,$),orderQtyByCoin:_.toCoin(r,b,$),orderQtyStr:U,priceEp:Number(y),price:V,activationPriceEp:q,activationPrice:q?p.floor(q,i,o):"-",stopPxEp:v,stopPx:p.floor(v,i,o),actionTimestamp:A,actionTime:xe.formatDateTime(A),actionMonthDayTime:xe.formatMonthDayTime(A),stopDirection:eb(S,w),trigger:m,triggerType:tb(m),timeInForce:x,pegOffsetValueEp:T,pegOffsetValue:p.floor(Math.abs(T),i,o),pegOffsetProportionEr:P,pegOffsetProportion:ee,pegPriceType:w,removable:J.isFinalOrder(u),takeProfitEp:O,takeProfitPrice:p.floor(O,i,o),stopLossEp:Q,stopLossPrice:p.floor(Q,i,o),tpTrigger:R,slTrigger:I,curPosTerm:k,posSide:M,actionBy:C,displayQty:N,icebergOrderQtyByCont:_.toCont(r,N??0),icebergOrderQtyByValue:_.toValue(r,N??0,$),icebergOrderQtyByCoin:_.toCoin(r,N??0,$)}}function ob(){Pa.pipe(l(e=>({type:"contract-orders-conditional",data:{orders:e}}))).subscribe(e=>D.next(e))}const sb=Lr.pipe(l(({orders:{fills:e}})=>e)),ab=nt.pipe(l(({orders:{fills:e}})=>e)),cb=fe.pipe(l(()=>e=>(e.clear(),e))),ub=F(sb,ab).pipe(l(e=>function(t){return e.forEach(r=>t.set(r.execID,r)),t})),lb=F(ub,cb).pipe(H((e,t)=>t(e),new Map)),Ta=B([ne,ye]).pipe(h(([e,t])=>e.has("."+t)),l(([e,t])=>e.get("."+t)));Ta.pipe(l(e=>({type:"fiat-rate",data:{fiatRate:e}}))).subscribe(e=>D.next(e));const pb=B([lb,He,Ar,ne,Ta]).pipe(l(([e,t,r,n,i])=>e.toArray(o=>db(o,t,r,n,i)).filter(Boolean)));function db(e,t,r,n,i){const{orderID:o,clOrdID:a,ordType:s,ordStatus:c,symbol:u,side:d,orderQty:f,priceEp:b,execID:y,execQty:m,execPriceEp:v,transactTimeNs:E,timeInForce:S,closedPnlEv:x,execFeeEv:T,ptFeeEv:P,currency:w,tradeType:O,posSide:Q}=e,R=t.get(u);if(!R)return null;const{displaySymbol:I,pricePrecision:k,priceScale:M,valuePrecision:C,valueScale:N,baseCurrency:A}=R,q=Math.floor(E/1e6),U=p.floor(b,k,M),V=p.floor(v,k,M),$=T?p.floor(T,C,N)+" "+w:"",Y=P&&ke(P,0),ee=Y?p.floor(P,r.valuePrecision)+" "+r.displayCurrency:"",oe=Y?n.get(".PT"):n.get("."+A),me=oe?oe.priceEp:0,ae=(Y?P:T)||0;return{orderID:o,clOrdID:a,ordType:fb(s,O),ordStatus:c,symbol:u,displaySymbol:I,side:d,orderQty:Number(f),orderQtyByCont:_.toCont(R,f),orderQtyByValue:_.toValue(R,f,U),orderQtyByCoin:_.toCoin(R,f,U),orderQtyStr:p.delimit(f),priceEp:Number(b),price:U,execID:y,execQty:m,execQtyByCont:_.toCont(R,m),execQtyByValue:_.toValue(R,m,V),execQtyByCoin:_.toCoin(R,m,V),execQtyStr:p.delimit(m),execPriceEp:v,execPrice:V,transactTimestamp:q,transactTime:xe.formatDateTime(q),timeInForce:S,closedPnl:x?p.floor(x,C,N)+" "+w:"-",execFee:ee||$||"-",execFeeMoney:yb(R,i,ae,me),posSide:Q}}function fb(e,t){return e||{AdlTrade:"AdlTrade",LiqTrade:"Liquidation"}[t]||"-"}function yb(e,t,r,n){if(!t)return"";const{contractSide:i,valueScale:o,isSupportHedge:a}=e,s=a?1e4:1,c=g(r).times(s).div(t.priceEp);return i>0?p.floor(c,8):p.floor(g(c).times(n),8,o)}function bb(){pb.pipe(l(e=>({type:"contract-orders-fill",data:{orders:e}}))).subscribe(e=>D.next(e))}const vb=fe.pipe(l(()=>e=>(e.clear(),e))),mb=Lr.pipe(l(e=>{const{closed:t}=e.orders;return function(r){return t.filter(xa).forEach(n=>r.set(n.orderID,n)),r}})),hb=nt.pipe(l(e=>{const{closed:t}=e.orders;return function(r){return t.filter(xa).forEach(n=>r.set(n.orderID,n)),r}})),gb=F(mb,hb,vb).pipe(H((e,t)=>t(e),new Map));function xa(e){return["New","Replace","Cancel","LiqRequest"].includes(e.action)&&!["ReplaceRejected","CancelRejected"].includes(e.execStatus)}const Eb=B([gb,De]).pipe(l(([e,t])=>e.toArray(r=>xb(r,t)).filter(Boolean).sort((r,n)=>n.transactTimestamp-r.transactTimestamp)));function Sb(e,t,r){return J.isMarketOrder(e.ordType)?"Market":e.priceEp===0?"-":p.floor(e.priceEp,t,r)}function Pb(e,t,r,n,i){return e.cumValueEv===0||e.cumQty===0?"-":p.floor(Math.pow(e.cumValueEv/(e.cumQty*r*n),t),i)}function Tb(e,t,r,n){return J.isConditionalOrder(e)?t===0?"-":p.floor(t,r,n):"-"}function xb(e,t){const r=t.find(V=>V.symbol===e.symbol);if(!r)return null;const{displaySymbol:n,contractSide:i,contractSize:o,pricePrecision:a,valueFactor:s,priceScale:c}=r,{orderID:u,clOrdID:d,ordType:f,ordStatus:b,symbol:y,side:m,priceEp:v,stopPxEp:E,orderQty:S,cumQty:x,leavesQty:T,createBy:P,actionTimeNs:w,transactTimeNs:O,timeInForce:Q,action:R,execPriceEp:I,posSide:k}=e,M=Math.floor(w/1e6),C=Math.floor(O/1e6),N=J.formatOrderQty(S),A=p.floor(I,a,c),q=Pb(e,i,s,o,a),U=wb(e,r);return{orderID:u,clOrdID:d,ordType:R==="LiqRequest"?"Liquidation":f,ordStatus:b,displaySymbol:n,symbol:y,side:m,orderQty:S,orderQtyStr:N,orderQtyStrByCont:_.toCont(r,S),orderQtyStrByValue:_.toValue(r,S,U),orderQtyStrByCoin:_.toCoin(r,S,U),cumQty:x,cumQtyByCont:_.toCont(r,x),cumQtyByValue:_.toValue(r,x,U),cumQtyByCoin:_.toCoin(r,x,U),leavesQty:T,leavesQtyByCont:_.toCont(r,T),leavesQtyByValue:_.toValue(r,T,U),leavesQtyByCoin:_.toCoin(r,T,U),leavesQtyStr:p.delimit(T),priceEp:v,price:Sb(e,a,c),fillPrice:q,stopPxEp:E,stopPx:Tb(f,E,a,c),createBy:P,actionTimestamp:M,actionTime:xe.formatDateTime(M),actionMonthDayTime:xe.formatMonthDayTime(M),transactTimestamp:C,transactTime:xe.formatDateTime(C),transactMonthDayTime:xe.formatMonthDayTime(C),timeInForce:Q,execPriceEp:I,execPrice:A,posSide:k}}function wb(e,t){const{pricePrecision:r,priceScale:n}=t,i=["execPriceEp","priceEp","stopPxEp"];for(let o=0;o<i.length;o++){const a=i[o],s=e[a];if(s)return p.floor(s,r,n)}return""}function Bb(){Eb.pipe(l(e=>({type:"contract-orders-history",data:{orders:e}}))).subscribe(e=>D.next(e))}const $t=new Re(!0);X.pipe(h(e=>e.type==="spot-all-symbols"),l(e=>e.data)).subscribe(e=>$t.next(e));function wa(e,t){const r=Vt.pipe(l(()=>s=>(s.clear(),s))),n=X.pipe(h(s=>s.type==="order-active-remove"),l(s=>c=>(c.delete(s.orderID),c))),i=e.pipe(l(s=>s.open.filter(c=>un(c,"snapshot"))),h(s=>s.length>0),l(s=>function(c){return c.clear(),s.forEach(u=>c.set(u.orderID,u)),c})),o=t.pipe(l(s=>[...s.open,...s.closed].filter(c=>un(c,"incremental")&&c.execStatus!=="ReplaceToCanceled")),h(s=>s.length>0),l(s=>function(c){return s.forEach(u=>c.set(u.orderID,u)),c})),a=t.pipe(l(s=>s.closed.filter(c=>un(c,"incremental")&&c.execStatus!=="ReplaceToCanceled")),h(s=>s.length>0),l(s=>function(c){return s.forEach(u=>c.delete(u.orderID)),c}),Ot(5e3));return F(i,o,a,r,n).pipe(H((s,c)=>c(s),new Map))}function un(e,t){const{execStatus:r,ordStatus:n}=e;return["ReplaceRejected","CancelRejected"].includes(r)?!1:t==="snapshot"?["New","PartiallyFilled"].includes(n):t==="incremental"?["New","PartiallyFilled","Filled","Canceled"].includes(n):!1}const Ob=wa(jr,mt);function Rn(e,t,r,n){const i=e.length;return{orders:(n?e:e.filter(o=>o.symbol===r.symbol)).map(o=>Rb(o,t,r.mode)).filter(Boolean).sort((o,a)=>a.createTimestamp-o.createTimestamp),count:i}}function Cn(e,t,r,n){const i=e.length;return{orders:(n?e:e.filter(o=>o.symbol===r.symbol)).map(o=>Qb(o,t,r.mode)).filter(Boolean).sort((o,a)=>a.createTimestamp-o.createTimestamp),count:i}}function kn(e,t,r,n){return{orders:(n?e:e.filter(i=>i.symbol===r.symbol)).map(i=>kb(i,t,r.mode)).filter(Boolean).sort((i,o)=>o.transactTimestamp-i.transactTimestamp)}}function Qn(e,t,r,n){return{orders:(n?e:e.filter(i=>i.symbol===r.symbol)).map(i=>Cb(i,t,r.mode)).filter(Boolean).sort((i,o)=>o.createTimestamp-i.createTimestamp)}}function Rb(e,t,r="Spot"){const{orderID:n,symbol:i,side:o,qtyType:a,baseQtyEv:s,quoteQtyEv:c,leavesBaseQtyEv:u,leavesQuoteQtyEv:d,ordType:f,ordStatus:b,priceEp:y,createTimeNs:m}=e,v=t.find(oe=>oe.symbol===i);if(!v)return null;const{displaySymbol:E,pricePrecision:S,baseCurrency:x,displayBaseCurrency:T,quoteCurrency:P,baseQtyPrecision:w,quoteQtyPrecision:O}=v,{baseQtyScale:Q,quoteQtyScale:R}=Wr(r,v),I=p.floor(s,w,Q),k=p.floor(u,w,Q),M=p.floor(se(s,u),w,Q),C=p.floor(c,O,R),N=p.floor(d,O,R),A=p.floor(se(c,d),O,R),q=L.calcQty(a,I,C),U=Number(a==="ByBase"?s:c),V=L.getByQtyType(a,T,P),$=L.calcValue({qtyType:a,priceEp:y,baseQtyEv:s,quoteQtyEv:c,baseQtyScale:Q,quoteQtyScale:R,quoteQtyPrecision:O,baseQtyPrecision:w}),Y=L.getByQtyType(a,T,P,!0),ee=$r(m);return{orderID:n,symbol:i,displaySymbol:E,side:o,qtyType:a,qty:q,qtyEv:U,qtyWU:L.joinWU(q,V),qtyCurrency:V,supportMarginTrade:v.supportMarginTrade,priceEp:y,price:p.floor(y,S,R),value:$,valueWU:L.joinWU($,Y),valueCurrency:Y,filledQty:L.calcQty(a,M,A),remainingQtyWU:L.calcQtyWU(a,k,x,N,P),remainingQty:L.calcQty(a,k,N),ordType:f,ordStatus:b,createTimestamp:ee,createTime:xe.formatDateTime(ee),removable:L.isFinalOrder(b)}}function Cb(e,t,r="Spot"){const{orderID:n,symbol:i,side:o,qtyType:a,baseQtyEv:s,quoteQtyEv:c,ordType:u,ordStatus:d,priceEp:f,avgPriceEp:b,stopPxEp:y,createTimeNs:m}=e,v=t.find(q=>q.symbol===i);if(!v)return null;const{displaySymbol:E,pricePrecision:S,displayBaseCurrency:x,quoteCurrency:T,baseQtyPrecision:P,quoteQtyPrecision:w}=v,{baseQtyScale:O,quoteQtyScale:Q}=Wr(r,v),R=L.isLiqTradeOrder(e),I=L.isMarketOrder(e),k=p.floor(s,P,O),M=p.floor(c,w,Q),C=$r(m),N=L.calcQty(a,k,M),A=L.getByQtyType(a,x,T);return{orderID:n,symbol:i,displaySymbol:E,side:o,amount:N,supportMarginTrade:v.supportMarginTrade,amountWU:L.joinWU(N,A),amountCurrency:A,price:Wt(I||R,f,S,Q),fillPrice:Nb(b,S,Q),value:I||R?"-":L.calcValueWU({qtyType:a,priceEp:f,baseQtyEv:s,quoteQtyEv:c,baseQtyScale:O,quoteQtyScale:Q,baseQtyPrecision:P,quoteQtyPrecision:w,displayBaseCurrency:x,quoteCurrency:T}),stopPx:_b(y,u,S,Q),ordType:u,ordStatus:d,createTimestamp:C,createTime:xe.formatDateTime(C)}}function kb(e,t,r="Spot"){const{orderID:n,execID:i,symbol:o,side:a,qtyType:s,baseQtyEv:c,quoteQtyEv:u,execBaseQtyEv:d,execQuoteQtyEv:f,ordType:b,priceEp:y,execPriceEp:m,transactTimeNs:v}=e,E=t.find(U=>U.symbol===o);if(!E)return null;const{displaySymbol:S,pricePrecision:x,displayBaseCurrency:T,quoteCurrency:P,baseQtyPrecision:w,quoteQtyPrecision:O}=E,{baseQtyScale:Q,quoteQtyScale:R}=Wr(r,E),I=L.isLiqTradeOrder(e),k=L.isMarketOrder(e),M=p.floor(c,w,Q),C=p.floor(d,w,Q),N=p.floor(u,O,R),A=p.floor(f,O,R),q=$r(v);return{orderID:n,execID:i,symbol:o,displaySymbol:S,side:a,supportMarginTrade:E.supportMarginTrade,qty:L.calcQtyWU(s,M,T,N,P),getQty:Db(a,C,T,A,P),spendQty:Mb(a,C,T,A,P),price:Wt(k||I,y,x,R),execPrice:p.floor(m,x,R),ordType:b,transactTimestamp:q,transactTime:xe.formatDateTime(q),execBaseQtyEv:d,execQuoteQtyEv:f}}function Qb(e,t,r="Spot"){const{orderID:n,symbol:i,side:o,qtyType:a,baseQtyEv:s,quoteQtyEv:c,leavesBaseQtyEv:u,leavesQuoteQtyEv:d,ordType:f,ordStatus:b,priceEp:y,stopPxEp:m,createTimeNs:v,stopDirection:E}=e,S=t.find(Ce=>Ce.symbol===i);if(!S)return null;const{displaySymbol:x,pricePrecision:T,baseCurrency:P,displayBaseCurrency:w,quoteCurrency:O,baseQtyPrecision:Q,quoteQtyPrecision:R}=S,{baseQtyScale:I,quoteQtyScale:k}=Wr(r,S),M=L.isLiqTradeOrder(e),C=L.isMarketOrder(e),N=$r(v),A=p.floor(s,Q,I),q=p.floor(u,Q,I),U=p.floor(se(s,u),Q,I),V=p.floor(c,R,k),$=p.floor(d,R,k),Y=p.floor(se(c,d),R,k),ee=L.calcQty(a,A,V),oe=Number(a==="ByBase"?s:c),me=L.getByQtyType(a,w,O),ae=L.calcValue({qtyType:a,priceEp:y,baseQtyEv:s,quoteQtyEv:c,baseQtyScale:I,quoteQtyScale:k,quoteQtyPrecision:R,baseQtyPrecision:Q}),pe=L.getByQtyType(a,w,O,!0);return{orderID:n,symbol:i,displaySymbol:x,side:o,isMarket:C,qtyType:a,qty:ee,qtyWU:L.joinWU(ee,me),qtyCurrency:me,supportMarginTrade:S.supportMarginTrade,price:Wt(C||M,y,T,k),priceEp:Number(y),qtyEv:oe,value:C||M?"-":ae,valueWU:C||M?"-":L.joinWU(ae,pe),valueCurrency:pe,filledQty:L.calcQty(a,U,Y),remainingQtyWU:L.calcQtyWU(a,q,P,$,O),remainingQty:L.calcQty(a,q,$),stopDirection:Ib(E),stopPxEp:m,stopPx:p.floor(m,T,k),ordType:f,ordStatus:b,createTimestamp:N,createTime:xe.formatDateTime(N),createMDTime:xe.formatMonthDayTime(N)}}function Ib(e){return e==="Rising"?"":e==="Falling"?"":""}function Db(e,t,r,n,i){return e==="Buy"?p.delimit(t)+" "+r:e==="Sell"?p.delimit(n)+" "+i:""}function Mb(e,t,r,n,i){return e==="Buy"?p.delimit(n)+" "+i:e==="Sell"?p.delimit(t)+" "+r:""}function Nb(e,t,r){return zu(e,0)?"-":p.floor(e,t,r)}function _b(e,t,r,n){return["Stop","StopLimit","LimitIfTouched","MarketIfTouched"].indexOf(t)<0?"-":p.floor(e,r,n)}function Wr(e,{baseQtyScale:t,quoteQtyScale:r}){return e==="Margin"?{baseQtyScale:0,quoteQtyScale:0}:{baseQtyScale:t,quoteQtyScale:r}}function $r(e){return Math.floor((e||0)/1e6)}const qb=Ob.pipe(l(e=>e.toArray())),Ab=B([qb,Ue,Xe,$t]).pipe(h(([,,e])=>e.mode==="Spot"),l(([e,t,r,n])=>Rn(e,t,r,n)));function Fb(){Ab.pipe(l(e=>({type:"spot-orders-active",data:e}))).subscribe(e=>D.next(e))}function Ba(e,t){const r=Vt.pipe(l(()=>s=>(s.clear(),s))),n=X.pipe(h(s=>s.type==="order-conditional-remove"),l(s=>c=>(c.delete(s.orderID),c))),i=e.pipe(l(s=>s.open.filter(c=>ln(c,"snapshot"))),l(s=>function(c){return c.clear(),s.forEach(u=>c.set(u.orderID,u)),c})),o=t.pipe(l(s=>[...s.open,...s.closed].filter(c=>ln(c,"incremental"))),h(s=>s.length>0),l(s=>function(c){return s.forEach(u=>c.set(u.orderID,u)),c})),a=t.pipe(l(s=>s.closed.filter(c=>ln(c,"incremental"))),h(s=>s.length>0),l(s=>function(c){return s.forEach(u=>c.delete(u.orderID)),c}),Ot(5e3));return F(i,o,n,r,a).pipe(H((s,c)=>c(s),new Map))}function ln(e,t){if(!L.isConditionalOrder(e))return!1;const{execStatus:r,ordStatus:n}=e;return["ReplaceRejected","CancelRejected"].includes(r)?!1:t==="snapshot"?["New","PartiallyFilled","Untriggered"].includes(n):t==="incremental"?["New","PartiallyFilled","Untriggered","Filled","Deactivated","Canceled","Rejected"].includes(n):!1}const Ub=Ba(jr,mt),Lb=Ub.pipe(l(e=>e.toArray())),jb=B([Lb,Ue,Xe,$t]).pipe(h(([,,e])=>e.mode==="Spot"),l(([e,t,r,n])=>Cn(e,t,r,n)));function Vb(){jb.pipe(l(e=>({type:"spot-orders-conditional",data:e}))).subscribe(e=>D.next(e))}function Oa(e,t){const r=Vt.pipe(l(()=>o=>(o.clear(),o))),n=e.pipe(l(o=>o.fills),l(o=>function(a){return a.clear(),o.forEach(s=>a.set(s.execID,s)),a})),i=t.pipe(l(o=>o.fills),h(o=>o.length>0),l(o=>function(a){return o.forEach(s=>a.set(s.execID,s)),a}));return F(n,i,r).pipe(H((o,a)=>a(o),new Map))}const zb=Oa(jr,mt),Wb=zb.pipe(l(e=>e.toArray())),$b=B([Wb,Ue,Xe,$t]).pipe(h(([,,e])=>e.mode==="Spot"),l(([e,t,r,n])=>kn(e,t,r,n)));function Hb(){$b.pipe(l(e=>({type:"spot-orders-fill",data:e}))).subscribe(e=>D.next(e))}function Ra(e,t){const r=Vt.pipe(l(()=>o=>(o.clear(),o))),n=e.pipe(l(o=>{const{open:a,closed:s}=o;return function(c){return c.clear(),a.forEach(u=>c.set(u.orderID,u)),s.forEach(u=>c.set(u.orderID,u)),c}})),i=t.pipe(l(o=>{const{open:a,closed:s}=o;return function(c){return a.forEach(u=>c.set(u.orderID,u)),s.forEach(u=>c.set(u.orderID,u)),c}}));return F(n,i,r).pipe(H((o,a)=>a(o),new Map))}const Xb=Ra(jr,mt),Yb=Xb.pipe(l(e=>e.toArray())),Gb=B([Yb,Ue,Xe,$t]).pipe(h(([,,e])=>e.mode==="Spot"),l(([e,t,r,n])=>Qn(e,t,r,n)));function Kb(){Gb.pipe(l(e=>({type:"spot-orders-history",data:e}))).subscribe(e=>D.next(e))}function Jb(){ri.pipe(l(e=>({type:"positions",data:{positions:e}}))).subscribe(e=>D.next(e)),Qd.pipe(l(e=>[].concat(...e.toArray())),l(e=>({type:"positions-copy-trade",data:{positions:e}}))).subscribe(e=>D.next(e)),Ls.pipe(l(e=>[].concat(...e.toArray())),l(e=>({type:"contract-margin-level",data:{marginLevels:e}}))).subscribe(e=>D.next(e))}const et=Nr.pipe(l(e=>e.spot===2),Ie()),ai=new Re({status:0}),Zb=ai.pipe(l(e=>e.status===1),Ie());X.pipe(h(e=>e.type==="init-user-data")).subscribe(e=>{e.data&&(e.data.uta&&Nr.next(e.data.uta),e.data.lendingAccount&&ai.next(e.data.lendingAccount))});rs.pipe(h(e=>e.bizType==="ACCOUNT"&&e.bizChangeType==="ACCOUNT_UPGRADE"||e.bizType===null&&e.bizChangeType===null),l(e=>e.content.uta)).subscribe(e=>{e&&Nr.next(e)});rs.pipe(h(e=>e.bizType==="ACCOUNT"&&e.bizChangeType==="LENDING_ACCOUNT_OPEN"||e.bizType===null&&e.bizChangeType===null),l(e=>e.content.lendingAccount)).subscribe(e=>{e&&ai.next(e)});const ev=$e.pipe(l(e=>t=>(e.forEach(r=>t.has(r.currency)?t:t.set(r.currency,ov(r))),t))),tv=fe.pipe(l(()=>e=>(e.clear(),e))),rv=Kn.pipe(l(e=>e.wallets)),nv=B([rv,$e]).pipe(l(([e,t])=>{const r=t.map(n=>n.currency);return n=>(e.filter(i=>r.includes(i.currency)).forEach(i=>n.set(i.currency,i)),n)})),iv=F(ev,nv,tv).pipe(H((e,t)=>t(e),new Map));function ov({currency:e,displayCurrency:t}){return{balanceEv:0,currency:e,displayCurrency:t,lastUpdateTimeNs:Date.now(),lockedTradingBalanceEv:0,lockedWithdrawEv:0,userID:0}}B([et,Te]).pipe(h(([e])=>!e)).subscribe(()=>{j.next({method:"mao.subscribe",params:[]}),et.pipe(Ie(),h(Boolean)).subscribe(()=>{j.next({method:"maos.unsubscribe",params:[]})})});const sv=B({isUtaSpot:et,wsMsg:re}).pipe(h(({isUtaSpot:e,wsMsg:t})=>!e&&!!t.wallets_mao&&!!t.orders_mao),l(({wsMsg:e})=>av(e)),we(Ne),h(([e,t])=>Pr(e)===t),l(([e])=>e));function av(e){var{orders_mao:t,wallets_mao:r,riskLevelRr:n}=e,i=Me(e,["orders_mao","wallets_mao","riskLevelRr"]);const{closed:o=[],open:a=[],fills:s=[]}=t,c=n;return Object.assign(Object.assign({},i),{riskLevelEr:c,wallets:cv(r,c),orders:{closed:pn(o),open:pn(a),fills:pn(s)}})}function cv(e,t){return e.map(r=>({balanceEv:r.balanceRq||"0",fundEv:r.fundRq||"0",currency:r.currency,lastUpdateTimeNs:r.lastUpdateTimeNs,lockedTradingBalanceEv:r.lockedTradingBalanceRq||"0",lockedWithdrawEv:r.lockedWithdrawRq||"0",borrowedEv:r.borrowedRq||"0",cumInterestEv:r.cumInterestRq||"0",hourlyInterestRateEr:r.hourlyInterestRateRr,maxAmountToBorrowEv:r.maxAmountToBorrowRq||"0",riskLevelEr:t,userID:r.userID}))}function pn(e){return e.map(t=>{const{avgPriceRp:r,averageRp:n,baseQtyRq:i,cumBaseQtyRq:o,cumFeeRv:a,cumQuoteQtyRq:s,curBaseWalletQtyRq:c,curQuoteWalletQtyRq:u,execBaseQtyRq:d,execFeeRv:f,execPriceRp:b,execQuoteQtyRq:y,leavesBaseQtyRq:m,leavesQuoteQtyRq:v,pegOffsetValueRv:E,priceRp:S,quoteQtyRq:x,stopPxRp:T,borrowQtyRq:P,paybackPrincipalQtyRq:w,paybackInterestQtyRq:O,hourlyInterestRateRr:Q,riskLevelRr:R,liqFeeRv:I,liqFeeRateRr:k}=t,M=Me(t,["avgPriceRp","averageRp","baseQtyRq","cumBaseQtyRq","cumFeeRv","cumQuoteQtyRq","curBaseWalletQtyRq","curQuoteWalletQtyRq","execBaseQtyRq","execFeeRv","execPriceRp","execQuoteQtyRq","leavesBaseQtyRq","leavesQuoteQtyRq","pegOffsetValueRv","priceRp","quoteQtyRq","stopPxRp","borrowQtyRq","paybackPrincipalQtyRq","paybackInterestQtyRq","hourlyInterestRateRr","riskLevelRr","liqFeeRv","liqFeeRateRr"]);return Object.assign(Object.assign({},M),{avgPriceEp:r||"0",averageEp:n||"0",baseQtyEv:i||"0",cumBaseQtyEv:o||"0",cumFeeEv:a||"0",cumQuoteQtyEv:s||"0",curBaseWalletQtyEv:c||"0",curQuoteWalletQtyEv:u||"0",execBaseQtyEv:d||"0",execFeeEv:f||"0",execPriceEp:b||"0",execQuoteQtyEv:y||"0",leavesBaseQtyEv:m||"0",leavesQuoteQtyEv:v||"0",pegOffsetValueEv:E||"0",priceEp:S||"0",quoteQtyEv:x||"0",stopPxEp:T||"0",borrowQtyEq:P||"0",paybackPrincipalQtyEq:w||"0",paybackInterestQtyEq:O||"0",hourlyInterestRateEr:Q||"0",riskLevelEr:R||"0",liqFeeEv:I||"0",liqFeeRateEr:k||"0"})})}const uv={1:"SPOT",2:"SPOT_MARGIN_TRADE",3:"UTA_SPOT",4:"UTA_MARGIN"};Te.subscribe(()=>j.next({method:"uta.mao.subscribe",params:[]}));const Ca=re.pipe(h(e=>!!e.wallets_mao&&!!e.orders_mao),l(e=>pv(e))),lv=B({isUtaSpot:et,wsMsg:Ca}).pipe(h(({isUtaSpot:e})=>e),l(({wsMsg:e})=>e),we(Ne),h(([e,t])=>Pr(e)===t),l(([e])=>e));function pv(e){var{orders_mao:t,wallets_mao:r,riskLevelRr:n}=e,i=Me(e,["orders_mao","wallets_mao","riskLevelRr"]);const{closed:o=[],open:a=[],fills:s=[]}=t,c=n;return Object.assign(Object.assign({},i),{riskLevelEr:c,wallets:dv(r,c),orders:{closed:dn(o),open:dn(a),fills:dn(s)}})}function dv(e,t){return e.map(r=>({balanceEv:r.balanceRq||"0",fundEv:r.fundRq||"0",currency:r.currency,lastUpdateTimeNs:r.lastUpdateTimeNs,lockedTradingBalanceEv:r.lockedTradingBalanceRq||"0",lockedWithdrawEv:r.lockedWithdrawRq||"0",borrowedEv:r.borrowedRq||"0",cumInterestEv:r.cumInterestRq||"0",hourlyInterestRateEr:r.hourlyInterestRateRr,maxAmountToBorrowEv:r.maxAmountToBorrowRq||"0",riskLevelEr:t,userID:r.userID}))}function dn(e){return e.map(t=>{const{avgPriceRp:r,averageRp:n,baseQtyRq:i,cumBaseQtyRq:o,cumFeeRv:a,cumQuoteQtyRq:s,curBaseWalletQtyRq:c,curQuoteWalletQtyRq:u,execBaseQtyRq:d,execFeeRv:f,execPriceRp:b,execQuoteQtyRq:y,leavesBaseQtyRq:m,leavesQuoteQtyRq:v,pegOffsetValueRv:E,priceRp:S,quoteQtyRq:x,stopPxRp:T,borrowQtyRq:P,paybackPrincipalQtyRq:w,paybackInterestQtyRq:O,hourlyInterestRateRr:Q,riskLevelRr:R,liqFeeRv:I,liqFeeRateRr:k,business:M}=t,C=Me(t,["avgPriceRp","averageRp","baseQtyRq","cumBaseQtyRq","cumFeeRv","cumQuoteQtyRq","curBaseWalletQtyRq","curQuoteWalletQtyRq","execBaseQtyRq","execFeeRv","execPriceRp","execQuoteQtyRq","leavesBaseQtyRq","leavesQuoteQtyRq","pegOffsetValueRv","priceRp","quoteQtyRq","stopPxRp","borrowQtyRq","paybackPrincipalQtyRq","paybackInterestQtyRq","hourlyInterestRateRr","riskLevelRr","liqFeeRv","liqFeeRateRr","business"]);return Object.assign(Object.assign({},C),{business:uv[M],avgPriceEp:r||"0",averageEp:n||"0",baseQtyEv:i||"0",cumBaseQtyEv:o||"0",cumFeeEv:a||"0",cumQuoteQtyEv:s||"0",curBaseWalletQtyEv:c||"0",curQuoteWalletQtyEv:u||"0",execBaseQtyEv:d||"0",execFeeEv:f||"0",execPriceEp:b||"0",execQuoteQtyEv:y||"0",leavesBaseQtyEv:m||"0",leavesQuoteQtyEv:v||"0",pegOffsetValueEv:E||"0",priceEp:S||"0",quoteQtyEv:x||"0",stopPxEp:T||"0",borrowQtyEq:P||"0",paybackPrincipalQtyEq:w||"0",paybackInterestQtyEq:O||"0",hourlyInterestRateEr:Q||"0",riskLevelEr:R||"0",liqFeeEv:I||"0",liqFeeRateEr:k||"0"})})}const Hr=F(sv,lv);B([Te,il]).pipe(h(([e,t])=>t.length>0)).subscribe(([e,t])=>t.map(r=>j.next({method:"uta.mao.subscribe",params:[0,r]})));const fv=Ca.pipe(we(Ne),h(([e,t])=>Pr(e)!==t),l(([e])=>({userId:Pr(e),data:e}))),wt={getBalanceEv(e,t,r=1e8,n=1e4,i=1e8,o=0){if(e===0)return 0;const a=g(i).times(n).div(r);return Number(Ee(g(e).div(t).times(a)))},getBalanceRv(e,t,r=1e8,n=1e4,i=8,o=0){if(e===0)return g(0).toFixed(i,o);const a=g(n).div(r);return g(e).div(t).times(a).round(i,o).toFixed(i)},getValueEv(e,t,r=1e8,n=1e4,i=1e8,o=!0){if(e===0)return 0;const a=g(i).div(n).div(r);return o?Number(Ee(g(e).times(t).times(a))):Ee(g(e).times(t).times(a))},getValueRv(e,t,r=1e8,n=1e4,i=8,o=0){if(e===0)return g(0).toFixed(i,o);const a=g(n).times(r);return g(e).times(t).div(a).round(i,o).toFixed(i)}},Ht=!1;function ve(e,t,r,n,i=Ht,o=!1,a=0){if(!t.has(".BTC")||!r.get("BTC")||!r.get("USD")||!t.get(".USDT"))return null;const s=Ji(e,t,r,n,i,!1,a);if(!o)return s;const{btcEv:c,btc:u,usdEv:d,usd:f,usdtEv:b,usdt:y,money:m}=Ji(e,t,r,n,i,!0,a);return Object.assign(Object.assign({},s),{bonusBtcEv:c,bonusBtc:u,bonusUsdEv:d,bonusUsd:f,bonusUsdtEv:b,bonusUsdt:y,bonusMoney:m})}function Ji(e,t,r,n,i=Ht,o=!1,a=0){if(!t.has(".BTC"))return null;const s=r.get("BTC"),c=r.get("USD"),[u,d]=Zi(s),[f,b]=Zi(c),{priceEp:y}=t.get(".BTC"),m=t.get(".USDT"),v=e.filter(C=>C.currency==="BTC"),E=e.filter(C=>C.currency==="USD"),S=e.filter(C=>["BTC","USD"].indexOf(C.currency)<0),x=v.map(C=>o?C.bonusBalanceEv:C.valueEv),T=E.map(C=>o?C.bonusBalanceEv:C.valueEv),P=Er(...x),w=Er(...T),O=S.reduce((C,N)=>W(C,vv(N,t,r,b,i,o)),"0"),Q=yv(P,w,O,y,d,b,i),R=bv(P,w,O,y,d,b,i),I=t.get("."+n),k=ka(I,R),M=g(R).times(m.priceFactor).div(m.priceEp).toNumber();return{btcEv:Q,btc:dr(Q,u,d,a),usdEv:R,usd:dr(R,f,b,a),usdtEv:M,usdt:dr(M,f,b,a),money:dr(k,c.valuePrecision,c.valueScale,a)}}function yv(e,t,r,n,i,o,a=Ht){return Math.floor(Number(g(t).plus(r).times(ut(a?Oe:g(i).plus(Oe).minus(o))).div(n).plus(e).times(ut(a?i:0)).valueOf()))}function bv(e,t,r,n,i,o,a=Ht){return Math.floor(Number(g(e).times(n).times(ut(a?-Oe:g(o).minus(Oe).minus(i))).plus(t).plus(r).times(ut(a?o:0)).valueOf()))}function vv(e,t,r,n,i=Ht,o=!1){const{currency:a}=e,s=r.get(a);if(!s)return 0;const c=t.get("."+a);if(!c)return 0;const u=i?-Oe:se(n,W(Oe,s.valueScale));return g(o?e.bonusBalanceEv:e.valueEv).times(c.priceEp).times(ut(u)).valueOf()}function Zi(e){return[e.valuePrecision,e.valueScale,e.valueFactor]}function dr(e,t,r,n=0){const i=n===3?p.ceil:p.floor;return p.delimit(i(e,t,r))}function ka(e,t){return e?Number(g(t).times(e.priceFactor).div(e.priceEp)):0}function mv([e,t,r,...n]){const i=e.get("BTC");if(!i)return null;const o=e.get("USD");if(!o)return null;const a=(n||[]).filter(Boolean),s=eo(t,r,o,i,a),{btcEv:c,btc:u,usdEv:d,usd:f,usdtEv:b,usdt:y,money:m}=eo(t,r,o,i,a,!0);return Object.assign(Object.assign({},s),{bonusBtcEv:c,bonusBtc:u,bonusUsdEv:d,bonusUsd:f,bonusUsdtEv:b,bonusUsdt:y,bonusMoney:m})}function eo(e,t,r,n,i,o=!1){const{valueScale:a,valueFactor:s}=r,c=2,u=2,d=Number(Qe(Er(...i.map(S=>o?S.bonusBtcEv||0:S.btcEv)),0,0)),f=Number(Qe(Er(...i.map(S=>o?S.bonusUsdEv||0:S.usdEv)),0,0)),b=t.get("."+e),y=ka(b,f),m=p.delimit(p.floor(y,u,a)),v=t.get(".USDT"),E=wt.getBalanceEv(f,v.priceEp,s,v.priceFactor,s);return{btcEv:d,btc:p.floor(d,n.valuePrecision,n.valueScale),usdEv:f,usd:p.delimit(p.floor(f,c,a)),money:m,usdtEv:E,usdt:p.delimit(p.floor(E,c,a))}}const Qa=fv.pipe(H((e,t)=>{const r=t.data.wallets.map(n=>Object.assign(Object.assign({},n),{valueEv:Number(n.balanceEv)-Number(n.borrowedEv)-Number(n.cumInterestEv)}));return e.set(t.userId,r),e},new Map),G(new Map));B([Qa,ne,le,ye]).pipe(ge(100),l(([e,t,r,n])=>{const i=[].concat(...e.toArray());return ve(i,t,r,n,!0)}),h(Boolean));const ci=Qa.pipe(l(e=>{const t=[].concat(...e.toArray());return hv(t)}),G(new Map));function hv(e){return e.reduce((t,r)=>{const n=r.currency,i=parseFloat(r.balanceEv);return t.set(n,(t.get(n)||0)+i),t},new Map)}const Ia=new z(1),ui=new z(1),Da=new z(1);B([Ia,Dr]).pipe(l(([e,t])=>{const r=e.filter(({currency:i})=>t.includes(i)),n=e.filter(({currency:i})=>!t.includes(i));return[r,n]})).subscribe(([e,t])=>{ui.next({wallets:e}),Da.next({wallets:t})});B([et,iv,le,zr,ci]).pipe(h(([e])=>!e),l(gv)).subscribe(e=>Ia.next(e));function gv([e,t,r,n,i]){return e?[]:t.toArray(o=>Ev(o,r,n,i)).filter(Boolean).sort((o,a)=>ke(a.totalBalanceValue,o.totalBalanceValue)?1:-1)}function Ev({lastUpdateTimeNs:e,currency:t,balanceEv:r,lockedTradingBalanceEv:n,lockedWithdrawEv:i},o,a,s){const c=o.get(t);if(!c)return null;const{valueScale:u,valuePrecision:d=8,valueFactor:f,name:b,displayCurrency:y,depositOpen:m,withdrawOpen:v,status:E}=c,S=s.has(t)?s.get(t):0,x=Number(be(S,f)),T=p.delimit(p.floor(x,d,u)),P=Number(W(r,x)),w=Number(W(W(n,i),x)),O=Number(se(P,w)),Q=it(O,d,u),R=it(O,2,u),I=it(O,4,u),[k]=a(y,O),[M]=a(y,w),[C,N]=a(y,P);return{time:Math.floor(e/1e6),currency:t,displayCurrency:y,name:b,totalBalanceEv:P,totalBalance:it(P,d,u),totalBalanceMoneyWU:C,totalBalanceValue:N,availableBalanceEv:O,availableBalance:Q,availableBalanceWU:Q+" "+t,availableBalance2:R,availableBalance2WU:R+" "+t,availableBalance4:I,availableBalance4WU:I+" "+t,availableBalanceMoneyWU:k,freezeBalanceEv:w,freezeBalance:it(w,d,u),freezeBalanceMoneyWU:M,lockedTradingBalanceEv:n,lockedTradingBalance:it(n,d,u),lockedWithdrawEv:i,lockedWithdraw:it(i,d,u),depositOpen:m,withdrawOpen:v,status:E,tradingBotEv:x,tradingBotsStr:T}}function it(e,t,r){return p.delimit(p.floor(e,t,r))}const Ma=Kn.pipe(h(e=>!!e.users));Ma.subscribe(e=>{const{sequence:t,timestamp:r,type:n,users:i,version:o}=e;Qr("wo_users_debug",{sequence:t,timestamp:r,type:n,content:i,version:o})});const Sv=B([Ma,Ar]).pipe(l(([e,t])=>!!e.users.find(r=>r.discountWithCcy===t.code)));function Pv(){ui.pipe(l(e=>({type:"spot-wallets",data:e}))).subscribe(e=>D.next(e)),Da.pipe(l(e=>({type:"spot-invalid-wallets",data:e}))).subscribe(e=>D.next(e)),Sv.pipe(l(e=>({type:"spot-pt-discount-state",data:{state:e}}))).subscribe(e=>D.next(e))}function Tv(){at.subscribe(()=>{j.next({method:"tick.subscribe",params:[".BTC"]}),j.next({method:"tick.subscribe",params:[".USDT"]}),j.next({method:"tick.subscribe",params:[".TRY"]}),j.next({method:"tick.subscribe",params:[".BRZ"]}),j.next({method:"markprice.subscribe",params:[]})}),B([at,ye]).pipe(l(e=>e[1]),h(e=>e!=="USD"),Ie()).subscribe(e=>j.next({method:"tick.subscribe",params:["."+e]}))}function xv(){Se.subscribe(e=>{const{type:t,symbol:r}=e,n=t==="PerpetualV2"?"trade_p.subscribe":"trade.subscribe",i=t==="PerpetualV2"?"trade_p.unsubscribe":"trade.unsubscribe";j.next({method:i,params:[]}),j.next({method:n,params:[r]})}),ii.subscribe(e=>D.next({type:"trades",data:e}))}const Na=B([et,$e,$n]).pipe(l(([e,t,r])=>{const n=r.reduce((i,o)=>(i.set(o.currency,o),i),new Map);return e?t.reduce((i,o)=>(n.has(o.currency)||i.set(o.currency,kv(o)),i),n):n})),li=Na.pipe(l(e=>e.toArray())),wv=li.pipe(l(e=>t=>(e.forEach(r=>t.get(r.currency)?t:t.set(r.currency,Cv(r.currency))),t))),Bv=fe.pipe(l(()=>e=>(e.clear(),e))),Ov=Hr.pipe(l(e=>e.wallets)),Rv=B([Ov,li]).pipe(l(([e,t])=>{const r=t.map(n=>n.currency);return n=>(e.filter(i=>r.includes(i.currency)).forEach(i=>n.set(i.currency,i)),n)})),pi=F(wv,Rv,Bv).pipe(H((e,t)=>t(e),new Map));function Cv(e){return{balanceEv:"0",fundEv:"0",currency:e,lastUpdateTimeNs:0,lockedTradingBalanceEv:"0",lockedWithdrawEv:"0",borrowedEv:"0",cumInterestEv:"0",hourlyInterestRateEr:"0",maxAmountToBorrowEv:"0",riskLevelEr:"999",userID:0}}function kv(e){return{currency:e.currency,name:e.name,displayCurrency:e.displayCurrency,valuePrecision:e.valuePrecision,pricePrecision:e.pricePrecision,status:e.status,valueFactor:1,valueScale:0,code:e.code,leverage:0,markDelete:!0,coefficient:"0",defaultHourlyInterestRate:"0",defaultMaxAmountToBorrowPerAccount:"0",minAmountToBorrowPerAccount:"0",maxAmountToBorrow:"0",liqFeeRate:"0",adlTargetRiskLevel:"0",priceCoefficientInAdl:"1",canRepay:!1,canBorrow:!1,canTransferOut:!0,canTransferIn:!0,canTrade:!0}}const Qv=999,Iv="999",Dv=Hr.pipe(h(e=>e.hasOwnProperty("riskLevelEr")&&ke(e.riskLevelEr,0)),l(e=>e.riskLevelEr)),_a=B([Dv,pi]).pipe(l(([e,t])=>t.toArray().find(r=>ke(r.borrowedEv,0)||ke(r.cumInterestEv,0))?{riskLevelEr:e,riskLevel:ke(e,Qv)?Iv:p.floor(e,2)}:{riskLevelEr:"999",riskLevel:"--"})),di=new z(1),qa=new z(1),Mv=6,Nv=4,_v=2;B([et,pi,_a,Na,Wo,ne,zr,vt,ci]).pipe(ge(100),l(qv),l(Fv)).subscribe(({accounts:e,overview:t})=>{di.next({accounts:e}),qa.next(t)});function qv([e,t,r,n,i,o,a,s,c]){return[t.toArray(u=>Av(u,r,n,o,a,s,e?c:new Map)).filter(Boolean).sort((u,d)=>ke(d.totalBalanceValue,u.totalBalanceValue)?1:-1),i]}function Av({lastUpdateTimeNs:e,currency:t,balanceEv:r,lockedTradingBalanceEv:n,borrowedEv:i,cumInterestEv:o,hourlyInterestRateEr:a,maxAmountToBorrowEv:s},c,u,d,f,b,y){const m=u.get(t),v=b.get("USD"),E=b.get("BTC"),S=d.get("."+t),x=d.get(".USDT"),T=d.get(".BTC");if(!m||!S||S.priceEp===0||!E||!v||!x||!T)return null;const{valuePrecision:P,pricePrecision:w,valueScale:O,name:Q,displayCurrency:R,maxAmountToBorrow:I,canBorrow:k,leverage:M,coefficient:C}=m,N=ke(s,0)?s:I,A=y.has(t)?y.get(t):0,q=p.delimit(p.floor(A,P,O)),U=W(n,A),V=U,$=W(r,A),Y=se($,U),ee=je(Y,P),oe=je(Y,2),me=je(Y,4),[ae]=f(R,Y,!0),[pe]=f(R,V,!0),[Ce,_e]=f(R,$,!0),Z=W(i,o),[Gt,Ye]=f(R,Z,!0),Le=se($,Z),[Kt,Jt]=f(R,Le,!0),ht=be(a,24),It=be(ht,365),gt=Ze(S.priceEp,ut(Oe)),Dt=ke(Le,0),Zt=k?Ee(g(Le).times(se(M,1)).times(Dt?C:1).minus(Z).times(gt)):"0",er=k?Ee(g(Le).times(Dt?C:1).minus(Z).times(gt)):"0",tr=k?se(N,Z):"0",{valueFactor:rr,valuePrecision:Gr}=v,{valuePrecision:nr}=E,Mt=Vv($,t,d),ir=g(Mt).times(rr).div(x.priceEp),Kr=g(Mt).times(rr).div(T.priceEp);return Object.assign(Object.assign({time:Math.floor(e/1e6),currency:t,displayCurrency:R,name:Q,totalBalanceEv:$,totalBalance:je($,P),totalBalanceMoneyWU:Ce,totalBalanceValue:_e,availableBalanceEv:Y,availableBalance:ee,availableBalanceWU:ee+" "+t,availableBalance2:oe,availableBalance2WU:oe+" "+t,availableBalance4:me,availableBalance4WU:me+" "+t,availableBalanceMoneyWU:ae,freezeBalanceEv:V,freezeBalance:je(V,P),freezeBalanceMoneyWU:pe,lockedTradingBalanceEv:U,lockedTradingBalance:je(U,P),borrowedEv:i,borrowed:fn(i,P),cumInterestEv:o,cumInterest:fn(o,P),totalDebtEv:Z,totalDebt:fn(Z,P),totalDebtValue:Ye,totalDebtMoneyWU:Gt,netEquityEv:Le,netEquity:je(Le,P),netEquityValue:Jt,netEquityMoneyWU:Kt,maxAmountToBorrowEv:N,maxAmountToBorrow:je(N,P),remainingMaxAmountToBorrowEv:tr,remainingMaxAmountToBorrow:je(tr,P),hourlyInterestRateEr:a,hourlyInterestRate:Qe(be(a,100),Mv,3)+"%",dailyInterestRateEr:ht,dailyInterestRate:Qe(be(ht,100),Nv,3)+"%",annualInterestRateEr:It,annualInterestRate:Qe(be(It,100),_v,3)+"%",indexPriceEp:gt,remainingBorrowValueEv:Zt,remainingBorrow2XValueEv:er,valuePrecision:P,pricePrecision:w,canBorrow:k},c),{totalBalanceUsdt:p.delimit(p.floor(ir,Gr)),totalBalanceBtc:p.delimit(p.floor(Kr,nr)),tradingBot:A,tradingBotStr:q})}function je(e,t){return p.delimit(Qe(e,t,0))}function fn(e,t){return p.delimit(Qe(e,t,3))}function Fv([e,t]){if(e.length<1)return{overview:{netEquityEv:"0",totalEquityEv:"0",totalDebtEv:"0",maxTransferOutValueEv:"0",totalAvailableEv:"0",totalMarginEv:"0",totalFreezeEv:"0"},accounts:[]};const{totalEquityEv:r,totalDebtEv:n,totalEquityCanBorrowEv:i,totalDebtCanBorrowEv:o,netEquityEv:a,remainingBorrowTotalValueEv:s,remainingBorrow2XTotalValueEv:c,totalAvailableEv:u,totalMarginEv:d,totalFreezeEv:f}=e.reduce(({totalEquityEv:E,totalEquityCanBorrowEv:S,totalDebtEv:x,totalDebtCanBorrowEv:T,netEquityEv:P,remainingBorrowTotalValueEv:w,remainingBorrow2XTotalValueEv:O,totalAvailableEv:Q,totalMarginEv:R,totalFreezeEv:I},k)=>{const M=be(k.totalBalanceEv,k.indexPriceEp),C=be(k.totalDebtEv,k.indexPriceEp);return{totalEquityEv:W(E,M),totalEquityCanBorrowEv:k.canBorrow?W(S,M):S,totalDebtEv:W(x,C),totalDebtCanBorrowEv:k.canBorrow?W(T,C):T,netEquityEv:W(P,be(k.netEquityEv,k.indexPriceEp)),remainingBorrowTotalValueEv:W(w,k.remainingBorrowValueEv),remainingBorrow2XTotalValueEv:W(O,k.remainingBorrow2XValueEv),totalAvailableEv:W(Q,be(k.availableBalanceEv,k.indexPriceEp)),totalMarginEv:k.canBorrow?W(R,M):R,totalFreezeEv:W(I,be(k.freezeBalanceEv,k.indexPriceEp))}},{totalEquityEv:"0",totalEquityCanBorrowEv:"0",totalDebtEv:"0",totalDebtCanBorrowEv:"0",netEquityEv:"0",remainingBorrowTotalValueEv:"0",remainingBorrow2XTotalValueEv:"0",totalAvailableEv:"0",totalMarginEv:"0",totalFreezeEv:"0"}),b=e[0].riskLevelEr,y=jv(i,o,b,t),m=Sr(s,0),v=Sr(c,0);return{overview:{netEquityEv:a,totalEquityEv:r,totalDebtEv:n,maxTransferOutValueEv:y,totalAvailableEv:u,totalMarginEv:d,totalFreezeEv:f},accounts:e.map(E=>{const S=to(E.canBorrow,m,E,t),x=to(E.canBorrow,v,E,t),T=Uv(E.canBorrow,i,o,E,t),P=Lv(E.canBorrow,y,E);return delete E.remainingBorrowValueEv,delete E.remainingBorrow2XValueEv,delete E.valuePrecision,delete E.pricePrecision,delete E.canBorrow,Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},E),T),S),P),{remainingBorrow2XEv:x.remainingBorrowEv,remainingBorrow2X:x.remainingBorrow})})}}function to(e,t,r,n){if(!e||st(r.riskLevelEr,n.canBorrowAbove))return{remainingBorrowEv:"0",remainingBorrow:p.floor(0,r.valuePrecision)};const i=Vo(Ze(t,r.indexPriceEp),r.remainingMaxAmountToBorrowEv);return{remainingBorrowEv:i,remainingBorrow:p.delimit(p.floor(i,r.valuePrecision))}}function Uv(e,t,r,n,i){const o={liquidationPriceEp:"0",liquidationPrice:"-"};if(!e||ke(n.riskLevelEr,10)||st(n.totalBalanceEv,0)&&st(n.totalDebtEv,0))return o;const a=se(t,be(r,i.canTradeAbove)),s=se(be(n.totalDebtEv,i.canTradeAbove),n.totalBalanceEv),c=Ee(g(a).div(s).plus(n.indexPriceEp));return st(c,0)?o:{liquidationPriceEp:c,liquidationPrice:p.delimit(Qe(c,n.valuePrecision))}}function Lv(e,t,r){if(!e){const i=se(r.netEquityEv,r.freezeBalanceEv);return{maxTransferOutAmountEv:i,maxTransferOutAmount:p.delimit(p.floor(i,r.valuePrecision))}}if(st(r.availableBalanceEv,0)||st(t,0))return ro(r.valuePrecision);const n=Vo(Ze(t,r.indexPriceEp),r.availableBalanceEv);return ke(n,0)?{maxTransferOutAmountEv:n,maxTransferOutAmount:p.delimit(p.floor(n,r.valuePrecision))}:ro(r.valuePrecision)}function jv(e,t,r,n){return st(r,n.canTransferOutAbove)?"0":Sr(0,se(e,be(t,n.canTransferOutAbove)))}function ro(e=8){return{maxTransferOutAmountEv:"0",maxTransferOutAmount:0 .toFixed(e)}}function Vv(e,t,r){const n=r.get("."+t);if(!n)return 0;const i=1,o=1;return wt.getValueEv(e,n.priceEp,i,n.priceFactor,o)}const Aa=new z(1),Fa=new z(1),fi=new z(1),Ua=new z(1),La=new z(1),ja=new z(1);B([et,pi,li,ne,zr,vt]).pipe(h(([e])=>e),l(zv),we(Dr)).subscribe(([[e,t],r])=>{Aa.next(e),Fa.next(t),Va(r,e,t)});Dr.pipe(we(Aa,Fa)).subscribe(([e,t,r])=>{Va(e,t,r)});function Va(e,t,r){fi.next({accounts:t.filter(({currency:n})=>e.includes(n))}),La.next({accounts:t.filter(({currency:n})=>!e.includes(n))}),Ua.next({accounts:r.filter(({currency:n})=>e.includes(n))}),ja.next({accounts:r.filter(({currency:n})=>!e.includes(n))})}function zv([e,t,r,n,i,o]){if(!e)return[[],[]];const a=t.toArray(s=>Wv(s,r,n,i,o)).filter(Boolean).sort((s,c)=>ke(c.totalBalanceValue,s.totalBalanceValue)?1:-1);return $v(a,i)}function Wv({lastUpdateTimeNs:e,fundEv:t,currency:r,lockedWithdrawEv:n},i,o,a,s){const c=i.find(M=>M.currency===r),u=s.get("USD"),d=s.get("BTC"),f=o.get("."+r),b=o.get(".USDT"),y=o.get(".BTC");if(!c||!f||!d||!u||!b||!y)return null;const{valuePrecision:m,code:v,name:E,displayCurrency:S}=c,{valueScale:x}=s.get(r),[T,P]=a(S,t,!0),{valueFactor:w,valuePrecision:O}=u,{valuePrecision:Q}=d,R=Hv(t,r,o),I=Ze(be(R,w),b.priceEp),k=Ze(be(R,w),y.priceEp);return{time:Math.floor(e/1e6),currency:r,currencyCode:v,displayCurrency:S,name:E,fundEv:t,lockedWithdrawEv:n,totalBalanceMoneyWU:T,totalBalanceValue:P,valuePrecision:m,valueScale:x,totalBalanceUsdt:p.delimit(p.floor(I,O)),totalBalanceBtc:p.delimit(p.floor(k,Q))}}function $v(e,t){const r=[],n=[];return e.forEach(i=>{const{time:o,currency:a,currencyCode:s,displayCurrency:c,name:u,fundEv:d,lockedWithdrawEv:f,totalBalanceMoneyWU:b,totalBalanceValue:y,valuePrecision:m,valueScale:v,totalBalanceUsdt:E,totalBalanceBtc:S}=i,x=f,T=se(d,x),P=St(T,m),w=St(T,2),O=St(T,4),[Q]=t(c,T,!0),R={time:o,currency:a,currencyCode:s,displayCurrency:c,name:u,totalBalance:St(d,m),totalBalanceMoneyWU:b,totalBalanceValue:y,availableBalance:P,availableBalanceWU:P+" "+a,availableBalance2:w,availableBalance2WU:w+" "+a,availableBalance4:O,availableBalance4WU:O+" "+a,availableBalanceMoneyWU:Q,lockedWithdraw:St(f,m),freezeBalance:St(x,m),totalBalanceUsdt:E,totalBalanceBtc:S};n.push(Object.assign(Object.assign({},R),{totalBalanceEv:fr(d,v),availableBalanceEv:fr(T,v),lockedWithdrawEv:fr(f,v),freezeBalanceEv:fr(x,v)})),r.push(Object.assign(Object.assign({},R),{totalBalanceEv:d,availableBalanceEv:T,lockedWithdrawEv:f,freezeBalanceEv:x}))}),[r,n]}function St(e,t){return p.delimit(p.floor(e,t,0))}function fr(e,t){return p.floor(e,0,-t)}function Hv(e,t,r){const n=r.get("."+t);if(!n)return 0;const i=1,o=1;return wt.getValueEv(e,n.priceEp,i,n.priceFactor,o)}function Xv(){di.pipe(l(e=>({type:"margin-trade-accounts",data:e}))).subscribe(e=>D.next(e)),Hr.pipe(l(()=>!0),Ke(1)).subscribe(e=>D.next({type:"update-margin-account-status",data:{isActivateMarginAccount:e}}))}function Yv(){fi.pipe(l(e=>({type:"fund-accounts",data:e}))).subscribe(e=>D.next(e)),Ua.pipe(l(e=>({type:"fund-scale-accounts",data:e}))).subscribe(e=>D.next(e)),La.pipe(l(e=>({type:"fund-invalid-accounts",data:e}))).subscribe(e=>D.next(e)),ja.pipe(l(e=>({type:"fund-invalid-scale-accounts",data:e}))).subscribe(e=>D.next(e))}const Gv=di.pipe(l(({accounts:e})=>e.map(t=>({currency:t.currency,valueEv:t.netEquityEv}))),G([])),Kv=B([Gv,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n,!0)),h(Boolean)),Jv=ne.pipe(h(e=>e.has(".BTC")),l(e=>e.get(".BTC")),l(e=>e.priceEp),Ie()),Zv=le.pipe(l(e=>e.get("BTC")),h(Boolean)),em=le.pipe(l(e=>e.get("USD")),h(Boolean)),tm=B([qa,_a,Jv,Zv,em]).pipe(l(([e,t,r,n,i])=>{const{totalEquityEv:o,totalDebtEv:a,netEquityEv:s,maxTransferOutValueEv:c,totalAvailableEv:u,totalMarginEv:d,totalFreezeEv:f}=e,b=yn(o,r,n),y=yn(a,r,n),m=yn(s,r,n);return Object.assign(Object.assign({},t),{totalEquityEv:o,totalEquityUsd:p.delimit(p.floor(o,i.valuePrecision)),totalEquityBtc:p.delimit(b),totalDebtEv:a,totalDebtUsd:p.delimit(Qe(a,i.valuePrecision,3)),totalDebtBtc:p.delimit(y),netEquityEv:s,netEquityUsd:p.delimit(p.floor(s,i.valuePrecision)),netEquityBtc:p.delimit(m),maxTransferOutValueEv:c,totalAvailableEv:u,totalAvailableUsd:p.delimit(p.floor(u,i.valuePrecision)),totalMarginEv:d,totalMarginUsd:p.delimit(p.floor(d,i.valuePrecision)),totalFreezeEv:f,totalFreezeUsd:p.delimit(p.floor(f,i.valuePrecision))})}));function yn(e,t,{valuePrecision:r}){return p.floor(Ze(e,t),r,-Oe)}const rm=fi.pipe(l(({accounts:e})=>e.map(t=>({currency:t.currency,valueEv:t.totalBalanceEv}))),G([])),nm=B([rm,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n,!0)),h(Boolean));function im(){Kv.pipe(l(e=>({type:"margin-assets",data:{assets:e}}))).subscribe(e=>D.next(e)),tm.pipe(l(e=>({type:"margin-assets-overview",data:e}))).subscribe(e=>D.next(e)),nm.pipe(l(e=>({type:"fund-assets",data:{assets:e}}))).subscribe(e=>D.next(e))}const{orders$:A0,snapshotOrders$:Xr,incrementalOrders$:Xt}=ms(Hr),om=Xt.pipe(l(({open:e,closed:t})=>[].concat(e,t)),dt()),[sm,am]=Io(om,e=>L.isConditionalOrder(e)),cm=B([sm,Mr]).pipe(l(([e,t])=>pa(e,t,!0)),h(Boolean)),um=B([am,Mr]).pipe(l(([e,t])=>da(e,t,!0)),h(Boolean)),lm=F(cm,um).pipe(h(e=>!!e));function pm(){lm.subscribe(e=>D.next({type:"notification-spot-order",data:e}))}const Yt=new Re(!0);X.pipe(h(e=>e.type==="margin-all-symbols"),l(e=>e.data)).subscribe(e=>Yt.next(e));function Yr(e){const t=[],r=[];return e.forEach(n=>{n.hasOwnProperty("business")&&n.business==="UTA_SPOT"?t.push(n):r.push(n)}),{spotOrders:t,marginOrders:r}}const dm=wa(Xr,Xt),fm=dm.pipe(l(e=>e.toArray())),za=new z(1),Wa=new z(1);B([fm,qr,Xe,Yt]).pipe(l(([e,t,r,n])=>{const{spotOrders:i,marginOrders:o}=Yr(e),a=t.map(s=>Object.assign(Object.assign({},s),{quoteQtyScale:0,baseQtyScale:0}));return{spotOrders:Rn(i,a,r,n),marginOrders:Rn(o,a,r,n)}})).subscribe(({spotOrders:e,marginOrders:t})=>{Wa.next(e),za.next(t)});function ym(){za.pipe(l(e=>({type:"margin-orders-active",data:e}))).subscribe(e=>D.next(e)),Wa.pipe(l(e=>({type:"uta-spot-orders-active",data:e}))).subscribe(e=>D.next(e))}const bm=Ba(Xr,Xt),vm=bm.pipe(l(e=>e.toArray())),$a=new z(1),Ha=new z(1);B([vm,qr,Xe,Yt]).pipe(l(([e,t,r,n])=>{const{spotOrders:i,marginOrders:o}=Yr(e);return{spotOrders:Cn(i,t,r,n),marginOrders:Cn(o,t,r,n)}})).subscribe(({spotOrders:e,marginOrders:t})=>{$a.next(e),Ha.next(t)});function mm(){Ha.pipe(l(e=>({type:"margin-orders-conditional",data:e}))).subscribe(e=>D.next(e)),$a.pipe(l(e=>({type:"uta-spot-orders-conditional",data:e}))).subscribe(e=>D.next(e))}const hm=Oa(Xr,Xt),gm=hm.pipe(l(e=>e.toArray())),Xa=new z(1),Ya=new z(1);B([gm,qr,Xe,Yt]).pipe(l(([e,t,r,n])=>{const{spotOrders:i,marginOrders:o}=Yr(e);return{spotOrders:kn(i,t,r,n),marginOrders:kn(o,t,r,n)}})).subscribe(({spotOrders:e,marginOrders:t})=>{Xa.next(e),Ya.next(t)});function Em(){Ya.pipe(l(e=>({type:"margin-orders-fill",data:e}))).subscribe(e=>D.next(e)),Xa.pipe(l(e=>({type:"uta-spot-orders-fill",data:e}))).subscribe(e=>D.next(e))}const Sm=Ra(Xr,Xt),Pm=Sm.pipe(l(e=>e.toArray())),Ga=new z(1),Ka=new z(1);B([Pm,qr,Xe,Yt]).pipe(l(([e,t,r,n])=>{const{spotOrders:i,marginOrders:o}=Yr(e);return{spotOrders:Qn(i,t,r,n),marginOrders:Qn(o,t,r,n)}})).subscribe(({spotOrders:e,marginOrders:t})=>{Ga.next(e),Ka.next(t)});function Tm(){Ka.pipe(l(e=>({type:"margin-orders-history",data:e}))).subscribe(e=>D.next(e)),Ga.pipe(l(e=>({type:"uta-spot-orders-history",data:e}))).subscribe(e=>D.next(e))}function xm(){Xv(),Yv(),im(),pm(),ym(),mm(),Em(),Tm()}function yi(e){return["TrailingStopPeg","TrailingTakeProfitPeg","TrailingStopByProportionPeg","TrailingTakeProfitByProportionPeg"].includes(e)}function wm(e){return e.ordStatus==="Untriggered"&&["LimitIfTouched","MarketIfTouched"].includes(e.ordType)&&!yi(e.pegPriceType)}function Bm(e){return e.ordStatus==="Untriggered"&&["Stop","StopLimit"].includes(e.ordType)&&!yi(e.pegPriceType)}function Om(e){return["Stop","StopLimit","StopAsLimit"].indexOf(e.ordType)>-1}function Rm(e){return Om(e)&&yi(e.pegPriceType)&&["Inactive","Untriggered"].includes(e.ordStatus)}function Ja(e,t){return t==="Entire"?e.orderQty===0:t==="Partial"?e.orderQty!==0:!0}function bi(e,t){const r=e.curPosTerm===t.term&&e.actionBy==="FromPosition",n=e.symbol===t.symbol,i=t.type==="PerpetualV2"?e.posSide===t.posSide:!0;return n&&r&&i}function vi(e,t){return t.actionTimestamp-e.actionTimestamp}function bn(e,t,r="All"){return e.filter(n=>bi(n,t)&&wm(n)&&Ja(n,r)).sort(vi)}function vn(e,t,r="All"){return e.filter(n=>bi(n,t)&&Bm(n)&&Ja(n,r)).sort(vi)}function Cm(e,t){return e.filter(r=>bi(r,t)&&Rm(r)).sort(vi)}const km=Pa.pipe(l(e=>e.reduce((t,r)=>{const{symbol:n}=r;return t.has(n)?t.get(n).push(r):t.set(n,[r]),t},new Map))),Qm=B([ri,km]).pipe(l(([e,t])=>e.filter(r=>r.size>0).reduce((r,n)=>{const[i,o]=Im(n,t.get(n.symbol)||[]);return r.set(i,o)},new Map)));function Im(e,t){return[e.symbol+e.posSide,{tp:{Entire:bn(t,e,"Entire"),Partial:bn(t,e,"Partial"),All:bn(t,e,"All")},sl:{Entire:vn(t,e,"Entire"),Partial:vn(t,e,"Partial"),All:vn(t,e,"All")},ts:{All:Cm(t,e)}}]}function Dm(){Qm.pipe(l(e=>({type:"tpsltsCache",data:e}))).subscribe(e=>D.next(e))}const Mm=ui.pipe(l(({wallets:e})=>e.map(t=>({currency:t.currency,valueEv:t.totalBalanceEv}))),G([]));B([Mm,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n)),h(Boolean));const Nm=B([Ws,Ar]).pipe(l(([e,t])=>e.map(r=>{let n=["USDT","MUSDT"].indexOf(r.currency)>-1?1e8:1;return r.currency===t.symbol&&(n=t.valueFactor),{currency:r.currency,valueEv:r.equityEv*n,bonusBalanceEv:r.bonusBalanceEv*n}})),G([])),_m=B([Nm,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n,!1,!0)),h(Boolean)),Za=Ks.pipe(l(e=>[...e.keys()].reduce((t,r)=>t.set(r,(e.get(r)||[]).map(n=>{const i=["USDT","MUSDT"].indexOf(n.currency)>-1?1e8:1;return{currency:n.currency,valueEv:n.equityEv*i,bonusBalanceEv:n.bonusBalanceEv*i}})),new Map)),ie(1)),qm=B([Za,ne,le,ye]).pipe(Vn(500),l(([e,t,r,n])=>{const i=[].concat(...e.toArray());return ve(i,t,r,n,!1,!0)}));ec(Zo);ec(Gn);B([le,ye,ne,_m,qm]).pipe(Vn(500),l(mv),h(Boolean));function ec(e){return B([Am(e),ne,le,ye]).pipe(Vn(500),l(([t,r,n,i])=>{const o=[].concat(...t.toArray());return ve(o,r,n,i,!1,!0)}))}function Am(e){return e.pipe(Je(t=>Za.pipe(l(r=>t.reduce((n,i)=>n.set(i,r.get(i)||[]),new Map)))))}Te.subscribe(()=>j.next({method:"service.subscribe",params:["service.unitrade"]}));fe.subscribe(()=>j.next({method:"service.unsubscribe",params:["service.unitrade"]}));const tc=re.pipe(h(e=>e.msgType==="unitrade.fiat.balance"));tc.pipe(h(e=>e.pushType==="snapshot")).subscribe(e=>{e.payload.forEach(t=>{t.currency!=="USD"&&j.next({method:"tick.subscribe",params:["."+t.currency]})})});const Fm=tc.pipe(l(e=>e.payload),G([])),Um=Fm.pipe(l(e=>t=>(e.forEach(r=>t.set(r.currency,r)),t))),Lm=fe.pipe(l(()=>e=>(e.clear(),e))),jm=F(Um,Lm).pipe(H((e,t)=>t(e),new Map)),Vm=8,mn=2,zm=B([jm,le,ne,ye]).pipe(l(Wm),h(Boolean));function Wm([e,t,r,n]){const i=t.get("BTC");if(!i)return null;const o=t.get("USD"),a=e.toArray();if(!o)return a;const{valueScale:s,valueFactor:c}=i,{valueScale:u,valueFactor:d}=o,f=r.get(".BTC");if(!f)return null;const b=r.get(".USDT");return b?a.map(({currency:y,balanceEv:m})=>{const v=r.get("."+y),E=r.get("."+n),S=$m(m,v),x=wt.getBalanceEv(S,f.priceEp,d,f.priceFactor,c),T=wt.getBalanceEv(S,b.priceEp,d,b.priceFactor,d),P=p.floor(S,mn,u);return{currency:y,balanceEv:m,usdBalance:P,usd:P,money:no(S,E,mn,u),btc:p.floor(x,Vm,s),usdt:no(T,b,mn,u)}}):null}function $m(e,t){return t?e*t.priceEp/100:0}function no(e,t,r,n){if(t){const{priceEp:i,priceScale:o=4}=t;return p.delimit(p.floor(e/i,r,n-o))}return 0 .toFixed(r)}B([zm,ne,vt,ye]).pipe(l(Hm),h(Boolean));function Hm([e,t,r,n]){const i=r.get("BTC"),o=r.get("USD"),a=t.get(".BTC"),s=t.get(".USDT");if(!i||!o||!a||!s)return null;const[c,u,d]=io(i),[f,b,y]=io(o),m=e.reduce((T,P)=>T+Ym(P,t),0),v=Xm(m,a.priceEp,y,1e4,d),E=t.get("."+n),S=Gm(E,m),x=g(m).times(s.priceFactor).div(s.priceEp).toNumber();return{btcEv:v,btc:yr(v,c,u),usdEv:m,usd:yr(m,f,b),money:yr(S,f,b),usdtEv:x,usdt:yr(x,f,b)}}function io(e){return[e.valuePrecision,e.valueScale,e.valueFactor]}function Xm(e,t,r=1e8,n=1e4,i=1e8){if(e===0)return 0;const o=g(i).times(n).div(r);return Number(g(e).div(t).times(o))}function Ym(e,t){const{balanceEv:r,currency:n}=e,i=t.get("."+n);return i?r*i.priceEp/100:0}function Gm(e,t){return e?Number(g(t).times(e.priceFactor).div(e.priceEp)):0}function yr(e,t,r){return p.delimit(p.floor(e,t,r))}Te.subscribe(()=>j.next({method:"wm.subscribe",params:[]}));fe.subscribe(()=>j.next({method:"wm.unsubscribe",params:[]}));const Km=re.pipe(h(e=>!!e.investments)),Jm=fe.pipe(l(()=>e=>(e.clear(),e))),Zm=Km.pipe(l(e=>e.investments)),e0=B([Zm,$e]).pipe(l(([e,t])=>e.filter(r=>t.some(n=>n.currency===r.currency)))),t0=e0.pipe(l(e=>function(t){return e.forEach(r=>t.set(r.currency,r)),t})),r0=F(t0,Jm).pipe(H((e,t)=>t(e),new Map)),n0=r0.pipe(l(e=>e.toArray())),i0=n0.pipe(l(e=>e.map(t=>({currency:t.currency,valueEv:t.balanceEv}))),G([]));B([i0,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n)),h(Boolean));Te.subscribe(()=>j.next({method:"service.subscribe",params:["service.launchpool"]}));fe.subscribe(()=>j.next({method:"service.unsubscribe",params:["service.launchpool"]}));const o0=re.pipe(h(e=>e.msgType==="launch.pool.assets")),s0=o0.pipe(l(e=>e.payload)),a0=B([s0,vt]).pipe(l(([e,t])=>{const r=e.map(n=>{const i=t.get(n.investCurrency);if(!i)return n;const{name:o,valueScale:a,valuePrecision:s}=i;return Object.assign(Object.assign({},n),{name:o,investAmount:p.floor(n.investAmountEv,s,a)})});return function(n){return r.forEach(i=>{n.set(i.poolId,i)}),n}})),c0=fe.pipe(l(()=>e=>(e.clear(),e))),u0=F(a0,c0).pipe(H((e,t)=>t(e),new Map)),l0=u0.pipe(l(e=>e.toArray()));Te.subscribe(()=>j.next({method:"service.subscribe",params:["service.predict"]}));fe.subscribe(()=>j.next({method:"service.unsubscribe",params:["service.predict"]}));const p0=re.pipe(h(e=>e.msgType==="predict.project.assets")),d0=p0.pipe(l(e=>e.payload)),f0=B([d0,vt]).pipe(l(([e,t])=>{const r=e.map(n=>{const i=t.get(n.currencyName);if(!i)return Object.assign(Object.assign({},n),{name:"--",balance:"--"});const{name:o,valueScale:a,valuePrecision:s}=i;return Object.assign(Object.assign({},n),{name:o,balance:p.floor(n.balanceEv,s,a)})});return function(n){return r.forEach(i=>{n.set(i.currencyName,i)}),n}})),y0=fe.pipe(l(()=>e=>(e.clear(),e))),b0=F(f0,y0).pipe(H((e,t)=>t(e),new Map)),v0=b0.pipe(l(e=>e.toArray()));function m0(){ne.pipe(l(e=>({type:"index-price",data:{prices:e}}))).subscribe(e=>D.next(e))}const h0=v0.pipe(l(e=>e.map(t=>({currency:t.currencyName,valueEv:t.balanceEv}))),G([]));B([h0,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n)),h(Boolean));const g0=l0.pipe(l(e=>e.map(t=>({currency:t.investCurrency,valueEv:t.investAmountEv}))),G([]));B([g0,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n)),h(Boolean));function E0(){Nr.pipe(l(e=>({type:"uta-state",data:e}))).subscribe(e=>D.next(e)),Zb.subscribe(e=>D.next({type:"update-lending-account-status",data:{isActivateLendingAccount:e}}))}const oo=["service.phemex_auction"];class S0{constructor(){this.isOpen=!1,this.isConnect=!1,Te.subscribe(()=>this._subscribe(!0)),fe.subscribe(()=>this._unsubscribe())}destroy(){this._unsubscribe()}subscribe(){this.isOpen=!0,Xn.getValue()&&this._subscribe()}unsubscribe(){this.isOpen=!1,this._subscribe()}_subscribe(t=!1){!t&&this.isConnect||!this.isOpen||(this.isConnect=!0,j.next({method:"service.subscribe",params:oo}))}_unsubscribe(){this.isConnect&&(this.isConnect=!1,j.next({method:"service.unsubscribe",params:oo}))}}re.pipe(h(e=>e.msgType==="auction.project.pool.info"),l(e=>e.payload[0]),ie(1));new S0;X.pipe(h(e=>e.type==="auction-subscribe"));X.pipe(h(e=>e.type==="auction-unsubscribe"));Te.subscribe(()=>j.next({method:"service.subscribe",params:["service.contract-biz"]}));const P0=re.pipe(h(e=>e.msgType==="service.contract-biz"&&e.payload.length>0),l(e=>e.payload),ie(1));function T0(){P0.pipe(l(e=>({type:"contract-biz",data:e}))).subscribe(e=>D.next(e))}const x0=$e.pipe(l(e=>e.reduce((t,r)=>t.set(r.code,r),new Map)),ie(1)),w0=fe.pipe(l(()=>e=>(e.clear(),e))),B0=X.pipe(h(e=>e.type==="lending-account-asset"),l(e=>e.data.map(t=>Object.assign(Object.assign({},t),{currencyCode:t.currency,currency:""}))),G([])),O0=B([B0,x0]).pipe(l(([e,t])=>r=>(e.filter(n=>t.has(n.currencyCode)).forEach(n=>{const i=t.get(n.currencyCode);r.set(i.symbol,Object.assign(Object.assign({},n),{currency:i.symbol}))}),r))),R0=F(O0,w0).pipe(H((e,t)=>t(e),new Map)),mi=B([R0,ne,zr,vt,ci]).pipe(ge(100),l(C0));function C0([e,t,r,n]){return e.toArray(i=>k0(i,t,r,n)).filter(Boolean).sort((i,o)=>ke(o.totalBalanceValue,i.totalBalanceValue)?1:-1)}function k0({currency:e,currencyCode:t,collateralAmountRq:r,loanAmountRq:n,interestAmountRq:i,balanceRq:o,lockedWithdrawRq:a,supplyAmountRq:s,supplyTotalInterestRq:c,autoInvest:u},d,f,b){const y=b.get(e);if(!y||!y.inAssetsDisplay)return null;const m=b.get("USD"),v=b.get("BTC"),E=d.get("."+e),S=d.get(".USDT"),x=d.get(".BTC");if(!E||!v||!m||!S||!x)return null;const{valuePrecision:T,name:P,displayCurrency:w}=y,O=se(o,a),Q=qe(O,T),R=qe(O,2),I=qe(O,4),[k]=f(w,O,!0),M=Ze(E.priceEp,ut(Oe)),{valueFactor:C,valuePrecision:N}=m,{valuePrecision:A}=v,q=W(W(o,r),s),[U,V]=f(w,q,!0),$=so(q,E),Y=g($).times(C).div(S.priceEp),ee=g($).times(C).div(x.priceEp),oe=W(n,i),[me,ae]=f(w,oe,!0),pe=se(q,oe),[Ce,_e]=f(w,pe,!0),Z=so(s,E);return{currency:e,currencyCode:t,displayCurrency:w,name:P,totalBalanceEv:q,totalBalance:qe(q,T),totalBalanceMoneyWU:U,totalBalanceValue:V,availableBalanceEv:O,availableBalance:Q,availableBalanceWU:Q+" "+e,availableBalance2:R,availableBalance2WU:R+" "+e,availableBalance4:I,availableBalance4WU:I+" "+e,availableBalanceMoneyWU:k,collateralBalanceEv:r,collateralBalance:qe(r,T),lockedWithdrawEv:a,lockedWithdraw:qe(a,T),borrowedEv:n,borrowed:hn(n,T),cumInterestEv:i,cumInterest:hn(i,T),totalDebtEv:oe,totalDebt:hn(oe,T),totalDebtValue:ae,totalDebtMoneyWU:me,netEquityEv:pe,netEquity:qe(pe,T),netEquityValue:_e,netEquityMoneyWU:Ce,indexPriceEp:M,totalBalanceUsdt:p.delimit(p.floor(Y,N)),totalBalanceBtc:p.delimit(p.floor(ee,A)),supplyAmountEv:s,supplyAmount:qe(s,T),supplyAmountUsdEv:Z,supplyAmountUsd:qe(Z,T),supplyTotalInterestEv:c,supplyTotalInterest:qe(c,T),autoInvest:u}}function so(e,t){if(!t)return"0";const r=1,n=1;return wt.getValueEv(e,t.priceEp,r,t.priceFactor,n,!1)}function qe(e,t){return p.delimit(Qe(e,t,0))}function hn(e,t){return p.delimit(Qe(e,t,3))}function Q0(){mi.pipe(l(e=>({type:"lending-accounts",data:{accounts:e}}))).subscribe(e=>D.next(e))}const I0=mi.pipe(l(e=>e.map(t=>({currency:t.currency,valueEv:t.netEquityEv}))),G([]));B([I0,ne,le,ye]).pipe(l(([e,t,r,n])=>ve(e,t,r,n,!0)),h(Boolean));const D0=B([mi,ne,le,ye]).pipe(ge(100),l(([e,t,r,n])=>{const i=e.map(y=>({currency:y.currency,valueEv:y.netEquityEv})),o=e.map(y=>({currency:y.currency,valueEv:y.totalBalanceEv})),a=e.map(y=>({currency:y.currency,valueEv:y.totalDebtEv})),s=e.map(y=>({currency:y.currency,valueEv:y.availableBalanceEv})),c=e.map(y=>({currency:y.currency,valueEv:y.collateralBalanceEv})),u=e.map(y=>({currency:y.currency,valueEv:y.lockedWithdrawEv})),d=e.map(y=>({currency:y.currency,valueEv:y.supplyTotalInterestEv})),f=e.map(y=>({currency:y.currency,valueEv:y.supplyAmountEv})),b={btcEv:0,btc:"--",usdEv:0,usd:"--",money:"--",usdtEv:0,usdt:"--"};return{netEquity:ve(i,t,r,n,!0)||b,totalEquity:ve(o,t,r,n,!0)||b,totalDebt:ve(a,t,r,n,!0,!1,3)||b,totalAvailable:ve(s,t,r,n,!0)||b,totalCollateralBalance:ve(c,t,r,n,!0)||b,totalLockedWithdraw:ve(u,t,r,n,!0)||b,totalSupply:ve(f,t,r,n,!0)||b,supplyTotalInterest:ve(d,t,r,n,!0)||b}}));function M0(){D0.pipe(l(e=>({type:"lending-assets-overview",data:e}))).subscribe(e=>D.next(e))}function N0(){Q0(),M0()}function _0(){_s.subscribe(e=>D.next({type:"risk-unit",data:e}))}Nu();rl();hl();Tl();cp();_d();Ld();Gd();Pf();jf();Gf();sy();fy();Ay();ob();bb();Bb();Fb();Vb();Hb();Kb();Jb();Pv();Tv();xv();xm();Dm();E0();m0();T0();N0();_0();Mn.onUnhandledError=function(e){if(e.type==="close"){console.warn("ws close");return}console.warn("rxjs error",e)};X.pipe(Ft(e=>e.type==="foundation-data")).subscribe(({currencies:e,contracts:t,spots:r,riskLimits:n,leverages:i,marginCurrencies:o,marginPairs:a,marginRiskLevels:s,leverageMargins:c})=>{$e.next(e),De.next(t),Ue.next(r),zo.next(n),$u.next(i),$n.next(o),Mr.next(a),Wo.next(s),$o.next(c),D.next({type:"worker-ready"})});X.pipe(Ft(e=>e.type==="ws-url"),qn(e=>e.url),Pc()).subscribe(Iu);X.pipe(Ft(e=>e.type==="risk-engine-mode"),qn(e=>e.data)).subscribe(e=>rt.next(e));Uo.subscribe(e=>{console.log("WS Status:",e),D.next({type:"ws-status",data:{status:e}})});X.pipe(Ft(e=>e.type==="contract-default-taker-fee-rate"),qn(e=>e.contractDefaultTakerFeeRateEr),Ft(e=>!!e||e===0)).subscribe(e=>_r.next(e));
//# sourceMappingURL=data-worker-37d278fc.js.map
